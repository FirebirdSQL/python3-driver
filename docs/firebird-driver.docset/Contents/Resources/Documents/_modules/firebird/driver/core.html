<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>firebird.driver.core &#8212; firebird-driver 1.8.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-2.3.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>

        <a class="brand" href="../../../index.html">
          firebird-driver</a>
        <span class="navbar-text pull-left"><b>1.8.0</b></span>

        <div class="nav-collapse">
          <ul class="nav">
            <li class="divider-vertical"></li>
            
                <li><a href="../../../usage-guide.html">Usage Guide</a></li>
                <li><a href="../../../reference.html">Reference</a></li>
                <li><a href="../../../genindex.html">Index</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Content <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started.html#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#installation-from-pypi">Installation from PYPI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started.html#quick-start-guide">Quick-start Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#driver-configuration">Driver configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#connecting-to-a-database">Connecting to a Database</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#creating-a-database">Creating a Database</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#executing-sql-statements">Executing SQL Statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#calling-stored-procedures">Calling Stored Procedures</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage-guide.html">Usage Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#driver-structure">Driver structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#configuration">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#the-driver-config-object">The ‘driver_config’ object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#server-and-database-configuration">Server and database configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#databases">Databases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#using-connect">Using connect()</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#using-create-database">Using create_database()</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#deleting-databases">Deleting databases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#connection-object">Connection object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#closing-the-connection">Closing the connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#getting-information-about-connection">Getting information about connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#getting-information-about-database">Getting information about database</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#executing-sql-statements">Executing SQL Statements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#cursor-object">Cursor object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#sql-execution-basics">SQL Execution Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#fetching-data-from-server">Fetching data from server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#index-13">Scrollable cursors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#id3">Parameterized statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#id5">Prepared Statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#named-cursors">Named Cursors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#working-with-stored-procedures">Working with stored procedures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#data-handling-and-conversions">Data handling and conversions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#implicit-conversion-of-input-parameters-from-strings">Implicit Conversion of Input Parameters from Strings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#automatic-conversion-from-to-unicode">Automatic conversion from/to Unicode</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#working-with-blobs">Working with BLOBs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#firebird-array-type">Firebird ARRAY type</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#transanction-management">Transanction management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#basics">Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#auto-commit">Auto-commit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#transaction-parameters">Transaction parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#getting-information-about-transaction">Getting information about transaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#retaining-transactions">Retaining transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#savepoints">Savepoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#using-multiple-transactions-with-the-same-connection">Using multiple transactions with the same connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#distributed-transactions">Distributed Transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#transaction-context-manager">Transaction Context Manager</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#database-events">Database Events</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#what-they-are">What they are</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#why-use-them">Why use them</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#how-events-are-exposed">How events are exposed</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#api-for-python-developers">API for Python developers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#working-with-services">Working with Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#services-api-connections">Services API Connections</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#text-output-from-services">Text output from Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#server-configuration-and-state-information">Server Configuration and State information</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#database-options">Database options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#database-maintenance">Database maintenance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#user-maintenance">User maintenance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#trace-sessions">Trace sessions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#logging-driver-activities">Logging driver activities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage-guide.html#index-43">Driver hooks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#apihook">APIHook</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#connectionhook">ConnectionHook</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage-guide.html#serverhook">ServerHook</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../python-db-api-compliance.html">Compliance to PyDB API 2.0</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../python-db-api-compliance.html#unsupported-optional-features">Unsupported Optional Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python-db-api-compliance.html#supported-optional-features">Supported Optional Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python-db-api-compliance.html#nominally-supported-optional-features">Nominally Supported Optional Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python-db-api-compliance.html#extensions-and-caveats">Extensions and Caveats</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">Firebird-driver Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reference.html#driver-modules">Driver modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../ref-main.html">Main driver namespace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ref-types.html">firebird.driver.types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ref-config.html">firebird.driver.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ref-core.html">firebird.driver.core</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ref-hooks.html">firebird.driver.hooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ref-intf.html">firebird.driver.interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ref-fbapi.html">firebird.driver.fbapi</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-8-0">Version 1.8.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-7-0">Version 1.7.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-6-0">Version 1.6.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-5-2">Version 1.5.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-5-1">Version 1.5.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-5-0">Version 1.5.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#potentially-breaking-changes">Potentially breaking changes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-4-3">Version 1.4.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-4-2">Version 1.4.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-4-1">Version 1.4.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-4-0">Version 1.4.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#improvements">Improvements:</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#backward-incompatible-changes">Backward incompatible changes:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-3-4">Version 1.3.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-3-3">Version 1.3.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-3-2">Version 1.3.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-3-1">Version 1.3.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-3-0">Version 1.3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-2-1">Version 1.2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-2-0">Version 1.2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-1-0">Version 1.1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-1-0-0">Version 1.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-8-0">Version 0.8.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-7-0">Version 0.7.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-6-0">Version 0.6.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-5-0">Version 0.5.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
      </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body span12 content" role="main">
      
  <h1>Source code for firebird.driver.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding:utf-8</span>
<span class="c1">#</span>
<span class="c1"># PROGRAM/MODULE: firebird-driver</span>
<span class="c1"># FILE:           firebird/driver/core.py</span>
<span class="c1"># DESCRIPTION:    Main driver code (connection, transaction, cursor etc.)</span>
<span class="c1"># CREATED:        25.3.2020</span>
<span class="c1">#</span>
<span class="c1"># The contents of this file are subject to the MIT License</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
<span class="c1"># copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1"># SOFTWARE.</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2020 Firebird Project (www.firebirdsql.org)</span>
<span class="c1"># All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Contributor(s): Pavel Císař (original code)</span>
<span class="c1">#                 ______________________________________</span>
<span class="c1"># pylint: disable=C0302, W0212, R0902, R0912,R0913, R0914, R0915, R0904</span>

<span class="sd">&quot;&quot;&quot;firebird-driver - Main driver code (connection, transaction, cursor etc.)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> \
     <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">PriorityQueue</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">memset</span><span class="p">,</span> <span class="n">memmove</span><span class="p">,</span> <span class="n">create_string_buffer</span><span class="p">,</span> <span class="n">byref</span><span class="p">,</span> <span class="n">string_at</span><span class="p">,</span> <span class="n">addressof</span><span class="p">,</span> <span class="n">pointer</span>
<span class="kn">from</span> <span class="nn">firebird.base.types</span> <span class="kn">import</span> <span class="n">Sentinel</span><span class="p">,</span> <span class="n">UNLIMITED</span><span class="p">,</span> <span class="n">ByteOrder</span>
<span class="kn">from</span> <span class="nn">firebird.base.logging</span> <span class="kn">import</span> <span class="n">LoggingIdMixin</span><span class="p">,</span> <span class="n">UNDEFINED</span>
<span class="kn">from</span> <span class="nn">firebird.base.buffer</span> <span class="kn">import</span> <span class="n">MemoryBuffer</span><span class="p">,</span> <span class="n">BufferFactory</span><span class="p">,</span> <span class="n">BytesBufferFactory</span><span class="p">,</span> \
     <span class="n">CTypesBufferFactory</span><span class="p">,</span> <span class="n">safe_ord</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fbapi</span> <span class="k">as</span> <span class="n">a</span>
<span class="kn">from</span> <span class="nn">.types</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">InterfaceError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">DataError</span><span class="p">,</span>
                    <span class="n">OperationalError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">InternalError</span><span class="p">,</span> <span class="n">ProgrammingError</span><span class="p">,</span>
                    <span class="n">NotSupportedError</span><span class="p">,</span>
                    <span class="n">NetProtocol</span><span class="p">,</span> <span class="n">DBKeyScope</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="p">,</span> <span class="n">Features</span><span class="p">,</span> <span class="n">ReplicaMode</span><span class="p">,</span> <span class="n">TraInfoCode</span><span class="p">,</span>
                    <span class="n">TraInfoAccess</span><span class="p">,</span> <span class="n">TraIsolation</span><span class="p">,</span> <span class="n">TraReadCommitted</span><span class="p">,</span> <span class="n">TraLockResolution</span><span class="p">,</span> <span class="n">TraAccessMode</span><span class="p">,</span>
                    <span class="n">TableShareMode</span><span class="p">,</span> <span class="n">TableAccessMode</span><span class="p">,</span> <span class="n">Isolation</span><span class="p">,</span> <span class="n">DefaultAction</span><span class="p">,</span> <span class="n">StatementType</span><span class="p">,</span> <span class="n">BlobType</span><span class="p">,</span>
                    <span class="n">DbAccessMode</span><span class="p">,</span> <span class="n">DbSpaceReservation</span><span class="p">,</span> <span class="n">DbWriteMode</span><span class="p">,</span> <span class="n">ShutdownMode</span><span class="p">,</span> <span class="n">OnlineMode</span><span class="p">,</span>
                    <span class="n">ShutdownMethod</span><span class="p">,</span>
                    <span class="n">DecfloatRound</span><span class="p">,</span> <span class="n">DecfloatTraps</span><span class="p">,</span> <span class="n">DESCRIPTION</span><span class="p">,</span>
                    <span class="n">ServerCapability</span><span class="p">,</span> <span class="n">SrvRepairFlag</span><span class="p">,</span> <span class="n">SrvStatFlag</span><span class="p">,</span> <span class="n">SrvBackupFlag</span><span class="p">,</span>
                    <span class="n">SrvRestoreFlag</span><span class="p">,</span> <span class="n">SrvNBackupFlag</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="p">,</span> <span class="n">ConnectionFlag</span><span class="p">,</span> <span class="n">EncryptionFlag</span><span class="p">,</span>
                    <span class="n">TPBItem</span><span class="p">,</span> <span class="n">DPBItem</span><span class="p">,</span> <span class="n">BPBItem</span><span class="p">,</span> <span class="n">SPBItem</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="p">,</span> <span class="n">ItemMetadata</span><span class="p">,</span> <span class="n">Transactional</span><span class="p">,</span>
                    <span class="n">XpbKind</span><span class="p">,</span> <span class="n">CursorFlag</span><span class="p">,</span> <span class="n">ImpCompiler</span><span class="p">,</span> <span class="n">ImpCPU</span><span class="p">,</span> <span class="n">ImpFlags</span><span class="p">,</span> <span class="n">ImpOS</span><span class="p">,</span> <span class="n">Implementation</span><span class="p">,</span>
                    <span class="n">TableAccessStats</span><span class="p">,</span> <span class="n">DbProvider</span><span class="p">,</span> <span class="n">DbClass</span><span class="p">,</span> <span class="n">StatementFlag</span><span class="p">,</span> <span class="n">BlobInfoCode</span><span class="p">,</span>
                    <span class="n">StateResult</span><span class="p">,</span> <span class="n">SrvDbInfoOption</span><span class="p">,</span> <span class="n">ServerAction</span><span class="p">,</span> <span class="n">CB_OUTPUT_LINE</span><span class="p">,</span> <span class="n">FILESPEC</span><span class="p">,</span>
                    <span class="n">SrvBackupOption</span><span class="p">,</span> <span class="n">SrvRestoreOption</span><span class="p">,</span> <span class="n">SrvNBackupOption</span><span class="p">,</span> <span class="n">SrvRepairOption</span><span class="p">,</span>
                    <span class="n">SrvPropertiesOption</span><span class="p">,</span> <span class="n">SrvPropertiesFlag</span><span class="p">,</span> <span class="n">SrvValidateOption</span><span class="p">,</span>
                    <span class="n">SrvUserOption</span><span class="p">,</span> <span class="n">SrvTraceOption</span><span class="p">,</span> <span class="n">UserInfo</span><span class="p">,</span> <span class="n">TraceSession</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">iAttachment</span><span class="p">,</span> <span class="n">iTransaction</span><span class="p">,</span> <span class="n">iStatement</span><span class="p">,</span> <span class="n">iMessageMetadata</span><span class="p">,</span> <span class="n">iBlob</span><span class="p">,</span> \
     <span class="n">iResultSet</span><span class="p">,</span> <span class="n">iDtc</span><span class="p">,</span> <span class="n">iService</span><span class="p">,</span> <span class="n">iCryptKeyCallbackImpl</span>
<span class="kn">from</span> <span class="nn">.hooks</span> <span class="kn">import</span> <span class="n">APIHook</span><span class="p">,</span> <span class="n">ConnectionHook</span><span class="p">,</span> <span class="n">ServerHook</span><span class="p">,</span> <span class="n">register_class</span><span class="p">,</span> <span class="n">get_callbacks</span><span class="p">,</span> <span class="n">add_hook</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">driver_config</span>

<span class="n">SHRT_MIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span>
<span class="n">SHRT_MAX</span> <span class="o">=</span> <span class="mi">32767</span>
<span class="n">USHRT_MAX</span> <span class="o">=</span> <span class="mi">65535</span>
<span class="n">INT_MIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2147483648</span>
<span class="n">INT_MAX</span> <span class="o">=</span> <span class="mi">2147483647</span>
<span class="n">UINT_MAX</span> <span class="o">=</span> <span class="mi">4294967295</span>
<span class="n">LONG_MIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9223372036854775808</span>
<span class="n">LONG_MAX</span> <span class="o">=</span> <span class="mi">9223372036854775807</span>

<span class="c1">#: Max BLOB segment size</span>
<span class="n">MAX_BLOB_SEGMENT_SIZE</span> <span class="o">=</span> <span class="mi">65535</span>

<span class="c1">#: Current filesystem encoding</span>
<span class="n">FS_ENCODING</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span>

<span class="c1">#: Python dictionary that maps Firebird character set names (key) to Python character sets (value).</span>
<span class="n">CHARSET_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">getpreferredencoding</span><span class="p">(),</span> <span class="s1">&#39;NONE&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">getpreferredencoding</span><span class="p">(),</span>
               <span class="s1">&#39;OCTETS&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;UNICODE_FSS&#39;</span><span class="p">:</span> <span class="s1">&#39;utf_8&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF8&#39;</span><span class="p">:</span> <span class="s1">&#39;utf_8&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">:</span> <span class="s1">&#39;utf_8&#39;</span><span class="p">,</span>
               <span class="s1">&#39;ASCII&#39;</span><span class="p">:</span> <span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;SJIS_0208&#39;</span><span class="p">:</span> <span class="s1">&#39;shift_jis&#39;</span><span class="p">,</span> <span class="s1">&#39;EUCJ_0208&#39;</span><span class="p">:</span> <span class="s1">&#39;euc_jp&#39;</span><span class="p">,</span>
               <span class="s1">&#39;DOS737&#39;</span><span class="p">:</span> <span class="s1">&#39;cp737&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS437&#39;</span><span class="p">:</span> <span class="s1">&#39;cp437&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS850&#39;</span><span class="p">:</span> <span class="s1">&#39;cp850&#39;</span><span class="p">,</span>
               <span class="s1">&#39;DOS865&#39;</span><span class="p">:</span> <span class="s1">&#39;cp865&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS860&#39;</span><span class="p">:</span> <span class="s1">&#39;cp860&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS863&#39;</span><span class="p">:</span> <span class="s1">&#39;cp863&#39;</span><span class="p">,</span>
               <span class="s1">&#39;DOS775&#39;</span><span class="p">:</span> <span class="s1">&#39;cp775&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS862&#39;</span><span class="p">:</span> <span class="s1">&#39;cp862&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS864&#39;</span><span class="p">:</span> <span class="s1">&#39;cp864&#39;</span><span class="p">,</span>
               <span class="s1">&#39;ISO8859_1&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_1&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO8859_2&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_2&#39;</span><span class="p">,</span>
               <span class="s1">&#39;ISO8859_3&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_3&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO8859_4&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_4&#39;</span><span class="p">,</span>
               <span class="s1">&#39;ISO8859_5&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_5&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO8859_6&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_6&#39;</span><span class="p">,</span>
               <span class="s1">&#39;ISO8859_7&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_7&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO8859_8&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_8&#39;</span><span class="p">,</span>
               <span class="s1">&#39;ISO8859_9&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_9&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO8859_13&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859_13&#39;</span><span class="p">,</span>
               <span class="s1">&#39;KSC_5601&#39;</span><span class="p">:</span> <span class="s1">&#39;euc_kr&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS852&#39;</span><span class="p">:</span> <span class="s1">&#39;cp852&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS857&#39;</span><span class="p">:</span> <span class="s1">&#39;cp857&#39;</span><span class="p">,</span>
               <span class="s1">&#39;DOS858&#39;</span><span class="p">:</span> <span class="s1">&#39;cp858&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS861&#39;</span><span class="p">:</span> <span class="s1">&#39;cp861&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS866&#39;</span><span class="p">:</span> <span class="s1">&#39;cp866&#39;</span><span class="p">,</span>
               <span class="s1">&#39;DOS869&#39;</span><span class="p">:</span> <span class="s1">&#39;cp869&#39;</span><span class="p">,</span> <span class="s1">&#39;WIN1250&#39;</span><span class="p">:</span> <span class="s1">&#39;cp1250&#39;</span><span class="p">,</span> <span class="s1">&#39;WIN1251&#39;</span><span class="p">:</span> <span class="s1">&#39;cp1251&#39;</span><span class="p">,</span>
               <span class="s1">&#39;WIN1252&#39;</span><span class="p">:</span> <span class="s1">&#39;cp1252&#39;</span><span class="p">,</span> <span class="s1">&#39;WIN1253&#39;</span><span class="p">:</span> <span class="s1">&#39;cp1253&#39;</span><span class="p">,</span> <span class="s1">&#39;WIN1254&#39;</span><span class="p">:</span> <span class="s1">&#39;cp1254&#39;</span><span class="p">,</span>
               <span class="s1">&#39;BIG_5&#39;</span><span class="p">:</span> <span class="s1">&#39;big5&#39;</span><span class="p">,</span> <span class="s1">&#39;GB_2312&#39;</span><span class="p">:</span> <span class="s1">&#39;gb2312&#39;</span><span class="p">,</span> <span class="s1">&#39;WIN1255&#39;</span><span class="p">:</span> <span class="s1">&#39;cp1255&#39;</span><span class="p">,</span>
               <span class="s1">&#39;WIN1256&#39;</span><span class="p">:</span> <span class="s1">&#39;cp1256&#39;</span><span class="p">,</span> <span class="s1">&#39;WIN1257&#39;</span><span class="p">:</span> <span class="s1">&#39;cp1257&#39;</span><span class="p">,</span> <span class="s1">&#39;GB18030&#39;</span><span class="p">:</span> <span class="s1">&#39;gb18030&#39;</span><span class="p">,</span>
               <span class="s1">&#39;GBK&#39;</span><span class="p">:</span> <span class="s1">&#39;gbk&#39;</span><span class="p">,</span> <span class="s1">&#39;KOI8R&#39;</span><span class="p">:</span> <span class="s1">&#39;koi8_r&#39;</span><span class="p">,</span> <span class="s1">&#39;KOI8U&#39;</span><span class="p">:</span> <span class="s1">&#39;koi8_u&#39;</span><span class="p">,</span>
               <span class="s1">&#39;WIN1258&#39;</span><span class="p">:</span> <span class="s1">&#39;cp1258&#39;</span><span class="p">,</span>
               <span class="p">}</span>

<span class="c1">#: Sentinel that denotes timeout expiration</span>
<span class="n">TIMEOUT</span><span class="p">:</span> <span class="n">Sentinel</span> <span class="o">=</span> <span class="n">Sentinel</span><span class="p">(</span><span class="s1">&#39;TIMEOUT&#39;</span><span class="p">)</span>

<span class="c1"># Internal</span>
<span class="c1">#: Firebird `.iMaster` interface</span>
<span class="n">_master</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1">#: Firebird `.iUtil` interface</span>
<span class="n">_util</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_thns</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

<span class="n">_tenTo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span> <span class="o">**</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>
<span class="n">_i2name</span> <span class="o">=</span> <span class="p">{</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">READ_SEQ_COUNT</span><span class="p">:</span> <span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">READ_IDX_COUNT</span><span class="p">:</span> <span class="s1">&#39;indexed&#39;</span><span class="p">,</span>
           <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">INSERT_COUNT</span><span class="p">:</span> <span class="s1">&#39;inserts&#39;</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">UPDATE_COUNT</span><span class="p">:</span> <span class="s1">&#39;updates&#39;</span><span class="p">,</span>
           <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DELETE_COUNT</span><span class="p">:</span> <span class="s1">&#39;deletes&#39;</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">BACKOUT_COUNT</span><span class="p">:</span> <span class="s1">&#39;backouts&#39;</span><span class="p">,</span>
           <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PURGE_COUNT</span><span class="p">:</span> <span class="s1">&#39;purges&#39;</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">EXPUNGE_COUNT</span><span class="p">:</span> <span class="s1">&#39;expunges&#39;</span><span class="p">}</span>

<span class="n">_bpb_stream</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">BPBItem</span><span class="o">.</span><span class="n">TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BlobType</span><span class="o">.</span><span class="n">STREAM</span><span class="p">])</span>

<span class="c1"># Info structural codes</span>
<span class="n">isc_info_end</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">isc_info_truncated</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">isc_info_error</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">isc_info_data_not_ready</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">def</span> <span class="nf">__api_loaded</span><span class="p">(</span><span class="n">api</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">FirebirdAPI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="s1">&#39;_master&#39;</span><span class="p">,</span> <span class="n">api</span><span class="o">.</span><span class="n">fb_get_master_interface</span><span class="p">())</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="s1">&#39;_util&#39;</span><span class="p">,</span> <span class="n">_master</span><span class="o">.</span><span class="n">get_util_interface</span><span class="p">())</span>

<span class="n">add_hook</span><span class="p">(</span><span class="n">APIHook</span><span class="o">.</span><span class="n">LOADED</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">FirebirdAPI</span><span class="p">,</span> <span class="n">__api_loaded</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_blob_buffer</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">MAX_BLOB_SEGMENT_SIZE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">MAX_BLOB_SEGMENT_SIZE</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_thns</span><span class="p">,</span> <span class="s1">&#39;blob_buf&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">MAX_BLOB_SEGMENT_SIZE</span><span class="p">)</span>
            <span class="n">_thns</span><span class="o">.</span><span class="n">blob_buf</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">memset</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_BLOB_SEGMENT_SIZE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">_encode_timestamp</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="c1"># Convert datetime.datetime or datetime.date to BLR format timestamp</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_date</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_time</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_date</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_time</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;datetime.datetime or datetime.date expected&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_is_fixed_point</span><span class="p">(</span><span class="n">dialect</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">datatype</span><span class="p">:</span> <span class="n">SQLDataType</span><span class="p">,</span> <span class="n">subtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">SHORT</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">LONG</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">)</span>
             <span class="ow">and</span> <span class="p">(</span><span class="n">subtype</span> <span class="ow">or</span> <span class="n">scale</span><span class="p">))</span>
            <span class="ow">or</span>
            <span class="p">((</span><span class="n">dialect</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">scale</span>
             <span class="ow">and</span> <span class="p">(</span><span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">D_FLOAT</span><span class="p">)))</span>
            <span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_external_data_type_name</span><span class="p">(</span><span class="n">dialect</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">datatype</span><span class="p">:</span> <span class="n">SQLDataType</span><span class="p">,</span>
                                 <span class="n">subtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_is_fixed_point</span><span class="p">(</span><span class="n">dialect</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">subtype</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;NUMERIC&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;DECIMAL&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="s1">&#39;NUMERIC/DECIMAL&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span> <span class="s1">&#39;CHAR&#39;</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">VARYING</span><span class="p">:</span> <span class="s1">&#39;VARCHAR&#39;</span><span class="p">,</span>
            <span class="n">SQLDataType</span><span class="o">.</span><span class="n">SHORT</span><span class="p">:</span> <span class="s1">&#39;SMALLINT&#39;</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">LONG</span><span class="p">:</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
            <span class="n">SQLDataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">:</span> <span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">:</span> <span class="s1">&#39;FLOAT&#39;</span><span class="p">,</span>
            <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">:</span> <span class="s1">&#39;DOUBLE&#39;</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">D_FLOAT</span><span class="p">:</span> <span class="s1">&#39;DOUBLE&#39;</span><span class="p">,</span>
            <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">:</span> <span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DATE</span><span class="p">:</span> <span class="s1">&#39;DATE&#39;</span><span class="p">,</span>
            <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIME</span><span class="p">:</span> <span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">BLOB</span><span class="p">:</span> <span class="s1">&#39;BLOB&#39;</span><span class="p">,</span>
            <span class="n">SQLDataType</span><span class="o">.</span><span class="n">BOOLEAN</span><span class="p">:</span> <span class="s1">&#39;BOOLEAN&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="s1">&#39;UNKNOWN&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_internal_data_type_name</span><span class="p">(</span><span class="n">data_type</span><span class="p">:</span> <span class="n">SQLDataType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">D_FLOAT</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DOUBLE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">data_type</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span>

<span class="k">def</span> <span class="nf">_check_integer_range</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dialect</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">datatype</span><span class="p">:</span> <span class="n">SQLDataType</span><span class="p">,</span>
                         <span class="n">subtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">SHORT</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">SHRT_MIN</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">SHRT_MAX</span>
    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">LONG</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">INT_MIN</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">INT_MAX</span>
    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">LONG_MIN</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">LONG_MAX</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">vmin</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;numeric overflow: value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"></span>
<span class="s2">(</span><span class="si">{</span><span class="n">_get_external_data_type_name</span><span class="p">(</span><span class="n">dialect</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">subtype</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span><span class="si">}</span><span class="s2"> scaled for </span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="s2"> decimal places) is of</span>
<span class="s2">too great a magnitude to fit into its internal storage type </span><span class="si">{</span><span class="n">_get_internal_data_type_name</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">which has range [</span><span class="si">{</span><span class="n">vmin</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">vmax</span><span class="si">}</span><span class="s2">].&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_is_str_param</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">datatype</span><span class="p">:</span> <span class="n">SQLDataType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">datatype</span> <span class="o">!=</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">BLOB</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">VARYING</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">create_meta_descriptors</span><span class="p">(</span><span class="n">meta</span><span class="p">:</span> <span class="n">iMessageMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ItemMetadata</span><span class="p">]:</span>
    <span class="s2">&quot;Returns list of metadata descriptors from statement metadata.&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get_count</span><span class="p">()):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ItemMetadata</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">relation</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_relation</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">owner</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_owner</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">alias</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_alias</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">datatype</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_type</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">nullable</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">subtype</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_subtype</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">length</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_length</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">scale</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_scale</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">charset</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_charset</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">offset</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_offset</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">null_offset</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_null_offset</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                   <span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Context managers</span>

<div class="viewcode-block" id="transaction"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.transaction">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="n">transact_object</span><span class="p">:</span> <span class="n">Transactional</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">tpb</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bypass</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transactional</span><span class="p">:</span> <span class="c1"># pylint: disable=W0621</span>
    <span class="sd">&quot;&quot;&quot;Context manager for `~firebird.driver.types.Transactional` objects.</span>

<span class="sd">    Starts new transaction when context is entered. On exit calls `rollback()` when</span>
<span class="sd">    exception was raised, or `commit()` if there was no error. Exception raised</span>
<span class="sd">    in managed context is NOT suppressed.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        transact_object: Managed transactional object.</span>
<span class="sd">        tpb: Transaction parameter buffer used to start the transaction.</span>
<span class="sd">        bypass: When both `bypass` and `transact_object.is_active()` are `True` when</span>
<span class="sd">                context is entered, the context manager does nothing on exit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bypass</span> <span class="ow">and</span> <span class="n">transact_object</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">transact_object</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transact_object</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">tpb</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">transact_object</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">transact_object</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transact_object</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="temp_database"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.temp_database">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">temp_database</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Context manager for temporary databases. Creates new database when context</span>
<span class="sd">    is entered, and drops it on exit. Exception raised in managed context is NOT suppressed.</span>

<span class="sd">    All positional and keyword arguments are passed to `create_database`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">create_database</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">con</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">con</span><span class="o">.</span><span class="n">drop_database</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">con</span><span class="o">.</span><span class="n">drop_database</span><span class="p">()</span></div>

<span class="n">_OP_DIE</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="n">_OP_RECORD_AND_REREGISTER</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="c1"># Managers for Parameter buffers</span>
<div class="viewcode-block" id="TPB"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TPB">[docs]</a><span class="k">class</span> <span class="nc">TPB</span><span class="p">:</span> <span class="c1"># pylint: disable=R0902</span>
    <span class="sd">&quot;&quot;&quot;Transaction Parameter Buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">access_mode</span><span class="p">:</span> <span class="n">TraAccessMode</span> <span class="o">=</span> <span class="n">TraAccessMode</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span>
                 <span class="n">isolation</span><span class="p">:</span> <span class="n">Isolation</span> <span class="o">=</span> <span class="n">Isolation</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">,</span>
                 <span class="n">lock_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">no_auto_undo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">auto_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ignore_limbo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">at_snapshot_number</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_mode</span><span class="p">:</span> <span class="n">TraAccessMode</span> <span class="o">=</span> <span class="n">access_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isolation</span><span class="p">:</span> <span class="n">Isolation</span> <span class="o">=</span> <span class="n">isolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">lock_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_auto_undo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">no_auto_undo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">auto_commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_limbo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">ignore_limbo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_reservation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TableShareMode</span><span class="p">,</span> <span class="n">TableAccessMode</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Firebird 4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">at_snapshot_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">at_snapshot_number</span>
<div class="viewcode-block" id="TPB.clear"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TPB.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear all information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_mode</span> <span class="o">=</span> <span class="n">TraAccessMode</span><span class="o">.</span><span class="n">WRITE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">Isolation</span><span class="o">.</span><span class="n">SNAPSHOT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_auto_undo</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_commit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_limbo</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_reservation</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Firebird 4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">at_snapshot_number</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="TPB.parse_buffer"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TPB.parse_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">parse_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load information from TPB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">TPB</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span> <span class="k">as</span> <span class="n">tpb</span><span class="p">:</span> <span class="c1"># pylint: disable=W0621</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">tpb</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">tpb</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">TraAccessMode</span><span class="o">.</span><span class="n">_value2member_map_</span><span class="p">:</span> <span class="c1"># pylint: disable=E1101</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">access_mode</span> <span class="o">=</span> <span class="n">TraAccessMode</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">TraIsolation</span><span class="o">.</span><span class="n">_value2member_map_</span><span class="p">:</span> <span class="c1"># pylint: disable=E1101</span>
                    <span class="n">isolation</span> <span class="o">=</span> <span class="n">TraIsolation</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">isolation</span> <span class="o">!=</span> <span class="n">TraIsolation</span><span class="o">.</span><span class="n">READ_COMMITTED</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">Isolation</span><span class="p">(</span><span class="n">isolation</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">TraReadCommitted</span><span class="o">.</span><span class="n">_value2member_map_</span><span class="p">:</span> <span class="c1"># pylint: disable=E1101</span>
                    <span class="n">isolation</span> <span class="o">=</span> <span class="n">TraReadCommitted</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">isolation</span> <span class="o">==</span> <span class="n">TraReadCommitted</span><span class="o">.</span><span class="n">RECORD_VERSION</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">Isolation</span><span class="o">.</span><span class="n">READ_COMMITTED_RECORD_VERSION</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">Isolation</span><span class="o">.</span><span class="n">READ_COMMITTED_NO_RECORD_VERSION</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">TraLockResolution</span><span class="o">.</span><span class="n">_value2member_map_</span><span class="p">:</span> <span class="c1"># pylint: disable=E1101</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lock_timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">TraLockResolution</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">WAIT</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TPBItem</span><span class="o">.</span><span class="n">AUTOCOMMIT</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auto_commit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TPBItem</span><span class="o">.</span><span class="n">NO_AUTO_UNDO</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">no_auto_undo</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TPBItem</span><span class="o">.</span><span class="n">IGNORE_LIMBO</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ignore_limbo</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TPBItem</span><span class="o">.</span><span class="n">LOCK_TIMEOUT</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lock_timeout</span> <span class="o">=</span> <span class="n">tpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TPBItem</span><span class="o">.</span><span class="n">AT_SNAPSHOT_NUMBER</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">at_snapshot_number</span> <span class="o">=</span> <span class="n">tpb</span><span class="o">.</span><span class="n">get_bigint</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">TableAccessMode</span><span class="o">.</span><span class="n">_value2member_map_</span><span class="p">:</span> <span class="c1"># pylint: disable=E1101</span>
                    <span class="n">tbl_access</span> <span class="o">=</span> <span class="n">TableAccessMode</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                    <span class="n">tbl_name</span> <span class="o">=</span> <span class="n">tpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
                    <span class="n">tpb</span><span class="o">.</span><span class="n">move_next</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">tpb</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing share mode value in table </span><span class="si">{</span><span class="n">tbl_name</span><span class="si">}</span><span class="s2"> reservation&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">:=</span> <span class="n">tpb</span><span class="o">.</span><span class="n">get_tag</span><span class="p">())</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TableShareMode</span><span class="o">.</span><span class="n">_value2member_map_</span><span class="p">:</span> <span class="c1"># pylint: disable=E1101</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing share mode value in table </span><span class="si">{</span><span class="n">tbl_name</span><span class="si">}</span><span class="s2"> reservation&quot;</span><span class="p">)</span>
                    <span class="n">tbl_share</span> <span class="o">=</span> <span class="n">TableShareMode</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reserve_table</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">,</span> <span class="n">tbl_share</span><span class="p">,</span> <span class="n">tbl_access</span><span class="p">)</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">move_next</span><span class="p">()</span></div>
<div class="viewcode-block" id="TPB.get_buffer"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TPB.get_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">get_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create TPB from stored information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">TPB</span><span class="p">)</span> <span class="k">as</span> <span class="n">tpb</span><span class="p">:</span> <span class="c1"># pylint: disable=W0621</span>
            <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access_mode</span><span class="p">)</span>
            <span class="n">isolation</span> <span class="o">=</span> <span class="p">(</span><span class="n">Isolation</span><span class="o">.</span><span class="n">READ_COMMITTED_RECORD_VERSION</span>
                         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation</span> <span class="o">==</span> <span class="n">Isolation</span><span class="o">.</span><span class="n">READ_COMMITTED</span>
                         <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isolation</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Isolation</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">,</span> <span class="n">Isolation</span><span class="o">.</span><span class="n">SERIALIZABLE</span><span class="p">):</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">isolation</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">isolation</span> <span class="o">==</span> <span class="n">Isolation</span><span class="o">.</span><span class="n">READ_COMMITTED_READ_CONSISTENCY</span><span class="p">:</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">TPBItem</span><span class="o">.</span><span class="n">READ_CONSISTENCY</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">TraIsolation</span><span class="o">.</span><span class="n">READ_COMMITTED</span><span class="p">)</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">TraReadCommitted</span><span class="o">.</span><span class="n">RECORD_VERSION</span>
                               <span class="k">if</span> <span class="n">isolation</span> <span class="o">==</span> <span class="n">Isolation</span><span class="o">.</span><span class="n">READ_COMMITTED_RECORD_VERSION</span>
                               <span class="k">else</span> <span class="n">TraReadCommitted</span><span class="o">.</span><span class="n">NO_RECORD_VERSION</span><span class="p">)</span>
            <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">TraLockResolution</span><span class="o">.</span><span class="n">NO_WAIT</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">TraLockResolution</span><span class="o">.</span><span class="n">WAIT</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">TPBItem</span><span class="o">.</span><span class="n">LOCK_TIMEOUT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commit</span><span class="p">:</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">TPBItem</span><span class="o">.</span><span class="n">AUTOCOMMIT</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_auto_undo</span><span class="p">:</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">TPBItem</span><span class="o">.</span><span class="n">NO_AUTO_UNDO</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_limbo</span><span class="p">:</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">TPBItem</span><span class="o">.</span><span class="n">IGNORE_LIMBO</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_snapshot_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_bigint</span><span class="p">(</span><span class="n">TPBItem</span><span class="o">.</span><span class="n">AT_SNAPSHOT_NUMBER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_snapshot_number</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_reservation</span><span class="p">:</span>
                <span class="c1"># Access mode + table name</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
                <span class="n">tpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Share mode</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">tpb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>
<div class="viewcode-block" id="TPB.reserve_table"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TPB.reserve_table">[docs]</a>    <span class="k">def</span> <span class="nf">reserve_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">share_mode</span><span class="p">:</span> <span class="n">TableShareMode</span><span class="p">,</span> <span class="n">access_mode</span><span class="p">:</span> <span class="n">TableAccessMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set information about table reservation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_reservation</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">share_mode</span><span class="p">,</span> <span class="n">access_mode</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="DPB"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DPB">[docs]</a><span class="k">class</span> <span class="nc">DPB</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Database Parameter Buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">trusted_auth</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sql_dialect</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">,</span> <span class="n">cache_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_gc</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">no_db_triggers</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_linger</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">utf8filename</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dbkey_scope</span><span class="p">:</span> <span class="n">DBKeyScope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dummy_packet_interval</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">db_cache_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forced_writes</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">reserve_space</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">page_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">sweep_interval</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_sql_dialect</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_charset</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auth_plugin_list</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session_time_zone</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">set_db_replica</span><span class="p">:</span> <span class="n">ReplicaMode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">set_bind</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">decfloat_round</span><span class="p">:</span> <span class="n">DecfloatRound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">decfloat_traps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DecfloatTraps</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
                 <span class="p">):</span>
        <span class="c1"># Available options:</span>
        <span class="c1"># AuthClient, WireCryptPlugin, Providers, ConnectionTimeout, WireCrypt,</span>
        <span class="c1"># WireCompression, DummyPacketInterval, RemoteServiceName, RemoteServicePort,</span>
        <span class="c1"># RemoteAuxPort, TcpNoNagle, IpcName, RemotePipeName, ClientBatchBuffer [FB4+]</span>
        <span class="c1">#: Configuration override</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1">#: List of authentication plugins override</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_plugin_list</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">auth_plugin_list</span>
        <span class="c1"># Connect</span>
        <span class="c1">#: Use trusted authentication</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trusted_auth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">trusted_auth</span>
        <span class="c1">#: User name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">user</span>
        <span class="c1">#: User password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">password</span>
        <span class="c1">#: User role</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">role</span>
        <span class="c1">#: SQL Dialect for database connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_dialect</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">sql_dialect</span>
        <span class="c1">#: Character set for database connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">charset</span>
        <span class="c1">#: Connection timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="c1">#: Dummy packet interval for this database connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_packet_interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy_packet_interval</span>
        <span class="c1">#: Page cache size override for database connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cache_size</span>
        <span class="c1">#: Disable garbage collection for database connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_gc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">no_gc</span>
        <span class="c1">#: Disable database triggers for database connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_db_triggers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">no_db_triggers</span>
        <span class="c1">#: Do not use linger for database connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_linger</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">no_linger</span>
        <span class="c1">#: Database filename passed in UTF8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utf8filename</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">utf8filename</span>
        <span class="c1">#: Scope for RDB$DB_KEY values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbkey_scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DBKeyScope</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbkey_scope</span>
        <span class="c1">#: Session time zone [Firebird 4]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time_zone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_time_zone</span>
        <span class="c1">#: Set replica mode [Firebird 4]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_db_replica</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ReplicaMode</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_db_replica</span>
        <span class="c1">#: Set BIND [Firebird 4]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_bind</span>
        <span class="c1">#: Set DECFLOAT ROUND [Firebird 4]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_round</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DecfloatRound</span><span class="p">]</span> <span class="o">=</span> <span class="n">decfloat_round</span>
        <span class="c1">#: Set DECFLOAT TRAPS [Firebird 4]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_traps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">DecfloatTraps</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="kc">None</span> <span class="k">if</span> <span class="n">decfloat_traps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">decfloat_traps</span><span class="p">)</span>
        <span class="c1"># For db create</span>
        <span class="c1">#: Database page size [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_size</span>
        <span class="c1">#: Overwrite existing database [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="c1">#: Number of pages in database cache [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_buffers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: Database cache size [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_cache_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_cache_size</span>
        <span class="c1">#: Database write mode (True = sync/False = async) [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forced_writes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">forced_writes</span>
        <span class="c1">#: Database data page space usage (True = reserve space, False = Use all space) [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_space</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">reserve_space</span>
        <span class="c1">#: Database access mode (True = read-only/False = read-write) [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">read_only</span>
        <span class="c1">#: Sweep interval for the database [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweep_interval</span>
        <span class="c1">#: SQL dialect for the database [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_sql_dialect</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_sql_dialect</span>
        <span class="c1">#: Character set for the database [db create only]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_charset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_charset</span>
<div class="viewcode-block" id="DPB.clear"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DPB.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear all information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Connect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trusted_auth</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_dialect</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="s1">&#39;UTF8&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_packet_interval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_gc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_db_triggers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_linger</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utf8filename</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbkey_scope</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time_zone</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_db_replica</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_round</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_traps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># For db create</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_buffers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forced_writes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_space</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_interval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_sql_dialect</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_charset</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="DPB.parse_buffer"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DPB.parse_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">parse_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load information from DPB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_py_charset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CHARSET_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">DPB</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span> <span class="k">as</span> <span class="n">dpb</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">dpb</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">_py_charset</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">AUTH_PLUGIN_LIST</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth_plugin_list</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">TRUSTED_AUTH</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trusted_auth</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">USER_NAME</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">_py_charset</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">_py_charset</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">CONNECT_TIMEOUT</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">DUMMY_PACKET_INTERVAL</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dummy_packet_interval</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">_py_charset</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SQL_DIALECT</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sql_dialect</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">LC_CTYPE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">NUM_BUFFERS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache_size</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">NO_GARBAGE_COLLECT</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">no_gc</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">UTF8_FILENAME</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">utf8filename</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">NO_DB_TRIGGERS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">no_db_triggers</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">NOLINGER</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">no_linger</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">DBKEY_SCOPE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbkey_scope</span> <span class="o">=</span> <span class="n">DBKeyScope</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">OVERWRITE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_PAGE_BUFFERS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_cache_size</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">FORCE_WRITE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">forced_writes</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">NO_RESERVE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reserve_space</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_DB_READONLY</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SWEEP_INTERVAL</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sweep_interval</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_DB_SQL_DIALECT</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_sql_dialect</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_DB_CHARSET</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_charset</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SESSION_TIME_ZONE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_time_zone</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_DB_REPLICA</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_db_replica</span> <span class="o">=</span> <span class="n">ReplicaMode</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_int</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_BIND</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_bind</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">DECFLOAT_ROUND</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_round</span> <span class="o">=</span> <span class="n">DecfloatRound</span><span class="p">(</span><span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DPBItem</span><span class="o">.</span><span class="n">DECFLOAT_TRAPS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_traps</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecfloatTraps</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                                           <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span></div>
<div class="viewcode-block" id="DPB.get_buffer"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DPB.get_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">get_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">for_create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create DPB from stored information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_py_charset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CHARSET_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">DPB</span><span class="p">)</span> <span class="k">as</span> <span class="n">dpb</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">_py_charset</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trusted_auth</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">TRUSTED_AUTH</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">USER_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">_py_charset</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">_py_charset</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_plugin_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">AUTH_PLUGIN_LIST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_plugin_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">CONNECT_TIMEOUT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_packet_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">DUMMY_PACKET_INTERVAL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_packet_interval</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">_py_charset</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_dialect</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SQL_DIALECT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_dialect</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">LC_CTYPE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">for_create</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_DB_CHARSET</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">NUM_BUFFERS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_gc</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">NO_GARBAGE_COLLECT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8filename</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">UTF8_FILENAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_db_triggers</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">NO_DB_TRIGGERS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_linger</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">NOLINGER</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbkey_scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">DBKEY_SCOPE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbkey_scope</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_time_zone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SESSION_TIME_ZONE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_time_zone</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_db_replica</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_DB_REPLICA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_db_replica</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_bind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_BIND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_bind</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_round</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">DECFLOAT_ROUND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_round</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_traps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">DECFLOAT_TRAPS</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">decfloat_traps</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">for_create</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">OVERWRITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cache_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_PAGE_BUFFERS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cache_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forced_writes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">FORCE_WRITE</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forced_writes</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">NO_RESERVE</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_space</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_DB_READONLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SWEEP_INTERVAL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_interval</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_sql_dialect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_DB_SQL_DIALECT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_sql_dialect</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_charset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dpb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">DPBItem</span><span class="o">.</span><span class="n">SET_DB_CHARSET</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_charset</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div></div>

<div class="viewcode-block" id="SPB_ATTACH"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.SPB_ATTACH">[docs]</a><span class="k">class</span> <span class="nc">SPB_ATTACH</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Service Parameter Buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">trusted_auth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">auth_plugin_list</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">expected_db</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trusted_auth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">trusted_auth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_plugin_list</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">auth_plugin_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">expected_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">role</span>
<div class="viewcode-block" id="SPB_ATTACH.clear"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.SPB_ATTACH.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear all information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trusted_auth</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_db</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="SPB_ATTACH.parse_buffer"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.SPB_ATTACH.parse_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">parse_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load information from SPB_ATTACH.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_ATTACH</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">spb</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">spb</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SPBItem</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">spb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SPBItem</span><span class="o">.</span><span class="n">AUTH_PLUGIN_LIST</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth_plugin_list</span> <span class="o">=</span> <span class="n">spb</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SPBItem</span><span class="o">.</span><span class="n">TRUSTED_AUTH</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trusted_auth</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SPBItem</span><span class="o">.</span><span class="n">USER_NAME</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">spb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SPBItem</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">spb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">spb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SPBItem</span><span class="o">.</span><span class="n">EXPECTED_DB</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">expected_db</span> <span class="o">=</span> <span class="n">spb</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span></div>
<div class="viewcode-block" id="SPB_ATTACH.get_buffer"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.SPB_ATTACH.get_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">get_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create SPB_ATTACH from stored information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_ATTACH</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
                                  <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trusted_auth</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">TRUSTED_AUTH</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">USER_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
                                      <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                                      <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
                                  <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_plugin_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">AUTH_PLUGIN_LIST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_plugin_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">EXPECTED_DB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_db</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="Buffer"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Buffer">[docs]</a><span class="k">class</span> <span class="nc">Buffer</span><span class="p">(</span><span class="n">MemoryBuffer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MemoryBuffer with extensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">factory</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BufferFactory</span><span class="p">]</span><span class="o">=</span><span class="n">BytesBufferFactory</span><span class="p">,</span>
                 <span class="n">max_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Sentinel</span><span class="p">]</span><span class="o">=</span><span class="n">UNLIMITED</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">:</span> <span class="n">ByteOrder</span><span class="o">=</span><span class="n">ByteOrder</span><span class="o">.</span><span class="n">LITTLE</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">factory</span><span class="p">,</span> <span class="n">eof_marker</span><span class="o">=</span><span class="n">isc_info_end</span><span class="p">,</span>
                         <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
<div class="viewcode-block" id="Buffer.seek_last_data"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Buffer.seek_last_data">[docs]</a>    <span class="k">def</span> <span class="nf">seek_last_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the position in buffer to first non-zero byte when searched from</span>
<span class="sd">        the end of buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_data</span></div>
<div class="viewcode-block" id="Buffer.get_tag"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Buffer.get_tag">[docs]</a>    <span class="k">def</span> <span class="nf">get_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read 1 byte number (c_ubyte).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_byte</span><span class="p">()</span></div>
<div class="viewcode-block" id="Buffer.rewind"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Buffer.rewind">[docs]</a>    <span class="k">def</span> <span class="nf">rewind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set current position in buffer to beginning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span></div>
<div class="viewcode-block" id="Buffer.is_truncated"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Buffer.is_truncated">[docs]</a>    <span class="k">def</span> <span class="nf">is_truncated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return True when positioned on `isc_info_truncated` tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">safe_ord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">])</span> <span class="o">==</span> <span class="n">isc_info_truncated</span></div></div>

<div class="viewcode-block" id="CBuffer"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.CBuffer">[docs]</a><span class="k">class</span> <span class="nc">CBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ctypes MemoryBuffer with extensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">max_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Sentinel</span><span class="p">]</span><span class="o">=</span><span class="n">UNLIMITED</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">:</span> <span class="n">ByteOrder</span><span class="o">=</span><span class="n">ByteOrder</span><span class="o">.</span><span class="n">LITTLE</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">CTypesBufferFactory</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span></div>

<div class="viewcode-block" id="EventBlock"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventBlock">[docs]</a><span class="k">class</span> <span class="nc">EventBlock</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Used internally by `EventCollector`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span><span class="p">,</span> <span class="n">event_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">updated</span><span class="p">):</span>
            <span class="n">memmove</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">updated</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">_OP_RECORD_AND_REREGISTER</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span><span class="p">:</span> <span class="n">PriorityQueue</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_handle</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span> <span class="o">=</span> <span class="n">db_handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isc_status</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_STATUS_ARRAY</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_STATUS_ARRAY</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_names</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__results</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">RESULT_VECTOR</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">RESULT_VECTOR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__callback</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_EVENT_CALLBACK</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_EVENT_CALLBACK</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_buf</span> <span class="o">=</span> <span class="n">pointer</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ISC_UCHAR</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_buf</span> <span class="o">=</span> <span class="n">pointer</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ISC_UCHAR</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_LONG</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_LONG</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buf_length</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">isc_event_block</span><span class="p">(</span><span class="n">pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_buf</span><span class="p">),</span>
                                                <span class="n">pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_buf</span><span class="p">),</span>
                                                <span class="o">*</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">event_names</span><span class="p">])</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;EventBlock disposed without prior close()&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">event_id</span><span class="o">.</span><span class="n">value</span>
    <span class="k">def</span> <span class="nf">__wait_for_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">isc_que_events</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isc_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">buf_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_buf</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">__callback</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isc_status</span><span class="p">,</span>
                                          <span class="s2">&quot;Error while waiting for events.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wait_for_events</span><span class="p">()</span>
<div class="viewcode-block" id="EventBlock.count_and_reregister"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventBlock.count_and_reregister">[docs]</a>    <span class="k">def</span> <span class="nf">count_and_reregister</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Count event occurences and re-register interest in further notifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">a</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">isc_event_counts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf_length</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">event_buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__first</span><span class="p">:</span>
            <span class="c1"># Ignore the first call, it&#39;s for setting up the table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__first</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__wait_for_events</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_names</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wait_for_events</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>
<div class="viewcode-block" id="EventBlock.close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventBlock.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close this block canceling managed events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">isc_cancel_events</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isc_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callback</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isc_status</span><span class="p">,</span>
                                              <span class="s2">&quot;Error while canceling events.&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="EventBlock.is_closed"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventBlock.is_closed">[docs]</a>    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if event block is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span></div></div>


<div class="viewcode-block" id="EventCollector"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventCollector">[docs]</a><span class="k">class</span> <span class="nc">EventCollector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Collects database event notifications.</span>

<span class="sd">    Notifications of events are not accumulated until `.begin()` method is called.</span>

<span class="sd">    From the moment the `.begin()` is called, notifications of any events that occur</span>
<span class="sd">    will accumulate asynchronously within the conduit’s internal queue until the collector</span>
<span class="sd">    is closed either explicitly (via the `.close()` method) or implicitly</span>
<span class="sd">    (via garbage collection).</span>

<span class="sd">    Note:</span>

<span class="sd">        `EventCollector` implements context manager protocol to call method `.begin()`</span>
<span class="sd">        and `.close()` automatically.</span>

<span class="sd">    Example::</span>

<span class="sd">       with connection.event_collector([&#39;event_a&#39;, &#39;event_b&#39;]) as collector:</span>
<span class="sd">           events = collector.wait()</span>
<span class="sd">           process_events(events)</span>

<span class="sd">    Important:</span>

<span class="sd">       DO NOT create instances of this class directly! Use only</span>
<span class="sd">       `Connection.event_collector` to get EventCollector instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span><span class="p">,</span> <span class="n">event_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_handle</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span> <span class="o">=</span> <span class="n">db_handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isc_status</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_STATUS_ARRAY</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_STATUS_ARRAY</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__events</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__event_names</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">EventBlock</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span><span class="p">:</span> <span class="n">PriorityQueue</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__events_ready</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">event_names</span><span class="p">)]</span><span class="o">*</span><span class="mi">15</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__process_thread</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;EventCollector disposed without prior close()&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<div class="viewcode-block" id="EventCollector.begin"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventCollector.begin">[docs]</a>    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Starts listening for events.</span>

<span class="sd">        Must be called directly or through context manager interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">event_process</span><span class="p">(</span><span class="n">queue</span><span class="p">:</span> <span class="n">PriorityQueue</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">operation</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">operation</span> <span class="ow">is</span> <span class="n">_OP_RECORD_AND_REREGISTER</span><span class="p">:</span>
                    <span class="n">events</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">count_and_reregister</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">events</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__events_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">operation</span> <span class="ow">is</span> <span class="n">_OP_DIE</span><span class="p">:</span>
                    <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__process_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">event_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__queue</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__process_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">block_events</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks</span><span class="p">:</span>
            <span class="n">event_block</span> <span class="o">=</span> <span class="n">EventBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_handle</span><span class="p">,</span> <span class="n">block_events</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__event_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_block</span><span class="p">)</span>
            <span class="n">event_block</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span></div>
<div class="viewcode-block" id="EventCollector.wait"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventCollector.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Wait for events.</span>

<span class="sd">        Blocks the calling thread until at least one of the events occurs, or</span>
<span class="sd">        the specified timeout (if any) expires.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            timeout: Number of seconds (use a float to indicate fractions of</span>
<span class="sd">                seconds). If not even one of the relevant events has</span>
<span class="sd">                occurred after timeout seconds, this method will unblock</span>
<span class="sd">                and return None. The default timeout is infinite.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `None` if the wait timed out, otherwise a dictionary that maps</span>
<span class="sd">            `event_name -&gt; event_occurrence_count`.</span>

<span class="sd">        Example::</span>

<span class="sd">           &gt;&gt;&gt; collector = connection.event_collector([&#39;event_a&#39;, &#39;event_b&#39;])</span>
<span class="sd">           &gt;&gt;&gt; collector.begin()</span>
<span class="sd">           &gt;&gt;&gt; collector.wait()</span>
<span class="sd">           {</span>
<span class="sd">            &#39;event_a&#39;: 1,</span>
<span class="sd">            &#39;event_b&#39;: 0</span>
<span class="sd">           }</span>

<span class="sd">        In the example above `event_a` occurred once and `event_b` did not occur</span>
<span class="sd">        at all.</span>

<span class="sd">        Raises:</span>
<span class="sd">            InterfaceError: When collector does not listen for events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Event collection not initialized (begin() not called).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__events_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__events</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>
<div class="viewcode-block" id="EventCollector.flush"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventCollector.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear any event notifications that have accumulated in the collector’s</span>
<span class="sd">        internal queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__events_ready</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__events</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__event_names</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>
<div class="viewcode-block" id="EventCollector.close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventCollector.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cancels the standing request for this collector to be notified of events.</span>

<span class="sd">        After this method has been called, this EventCollector instance is useless,</span>
<span class="sd">        and should be discarded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">_OP_DIE</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__process_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_blocks</span><span class="p">:</span>
                <span class="n">block</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span> <span class="o">=</span> <span class="kc">True</span></div>
<div class="viewcode-block" id="EventCollector.is_closed"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EventCollector.is_closed">[docs]</a>    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if collector is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span></div></div>

<div class="viewcode-block" id="InfoProvider"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.InfoProvider">[docs]</a><span class="k">class</span> <span class="nc">InfoProvider</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for embedded information providers.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        response (CBuffer): Internal buffer for response packet acquired via Firebird API.</span>
<span class="sd">        request (Buffer): Internal buffer for information request packet needed by Firebird API.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">charset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span> <span class="n">CBuffer</span> <span class="o">=</span> <span class="n">CBuffer</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">:</span> <span class="n">Buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">_raise_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;Requested functionality is not supported by used Firebird version.&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="InfoProvider._close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.InfoProvider._close">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close the information source.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="InfoProvider._acquire"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.InfoProvider._acquire">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Acquire information specified by parameter. Information must be stored in</span>
<span class="sd">        `response` buffer.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            request: Data specifying the required information.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="InfoProvider._get_data"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.InfoProvider._get_data">[docs]</a>    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">SHRT_MAX</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper function that aquires information specified by parameter into internal</span>
<span class="sd">        `response` buffer. If information source couldn&#39;t store all required data because</span>
<span class="sd">        the buffer is too small, this function tries to `.acquire()` the information again</span>
<span class="sd">        with buffer of doubled size.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            request: Data specifying the required information.</span>
<span class="sd">            max_size: Maximum response size.</span>

<span class="sd">        Raises:</span>
<span class="sd">            InterfaceError: If information cannot be successfuly stored into buffer</span>
<span class="sd">                of `max_size`, or response is ivalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acquire</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_truncated</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">max_size</span><span class="p">:</span>
                    <span class="n">buf_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">buf_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">buf_size</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Response too large&quot;</span><span class="p">)</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">seek_last_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Invalid response format&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="EngineVersionProvider"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EngineVersionProvider">[docs]</a><span class="k">class</span> <span class="nc">EngineVersionProvider</span><span class="p">(</span><span class="n">InfoProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Engine version provider for internal use by driver.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">con</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
<div class="viewcode-block" id="EngineVersionProvider._acquire"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EngineVersionProvider._acquire">[docs]</a>    <span class="k">def</span> <span class="nf">_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Acquires information from associated attachment. Information is stored in native</span>
<span class="sd">        format in `response` buffer.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            request: Data specifying the required information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">con</span><span class="p">(),</span> <span class="n">Connection</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">con</span><span class="p">()</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">con</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span></div>
<div class="viewcode-block" id="EngineVersionProvider.get_server_version"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EngineVersionProvider.get_server_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_server_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">con</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Server</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;Returns server version sctring.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">con</span> <span class="o">=</span> <span class="n">con</span>
        <span class="n">info_code</span> <span class="o">=</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">FIREBIRD_VERSION</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">(),</span> <span class="n">Connection</span><span class="p">)</span> \
            <span class="k">else</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">SERVER_VERSION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">info_code</span><span class="p">]))</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">info_code</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">isc_info_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;An error response was received&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Result code does not match request code&quot;</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">(),</span> <span class="n">Connection</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">()</span>  <span class="c1"># Cluster length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>  <span class="c1"># number of strings</span>
        <span class="n">verstr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_pascal_string</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">verstr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
            <span class="c1"># Unknown version</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">con</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">result</span></div>
<div class="viewcode-block" id="EngineVersionProvider.get_engine_version"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.EngineVersionProvider.get_engine_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_engine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">con</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Server</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="s2">&quot;Returns Firebird version as &lt;major&gt;.&lt;minor&gt; float number.&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_version</span><span class="p">(</span><span class="n">con</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div></div>

<span class="n">_engine_version_provider</span><span class="p">:</span> <span class="n">EngineVersionProvider</span> <span class="o">=</span> <span class="n">EngineVersionProvider</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="DatabaseInfoProvider3"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3">[docs]</a><span class="k">class</span> <span class="nc">DatabaseInfoProvider3</span><span class="p">(</span><span class="n">InfoProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides access to information about attached database [Firebird 3+].</span>

<span class="sd">    Important:</span>
<span class="sd">       Do NOT create instances of this class directly! Use `Connection.info` property to</span>
<span class="sd">       access the instance already bound to attached database.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">:</span> <span class="n">Connection</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">DbInfoCode</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">{</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">BASE_LEVEL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_ID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__db_id</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">IMPLEMENTATION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__implementation</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">IMPLEMENTATION_OLD</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__implementation_old</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">VERSION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_string</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">FIREBIRD_VERSION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_string</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">USER_NAMES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__user_names</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ACTIVE_TRANSACTIONS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tra_active</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">LIMBO</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tra_limbo</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ALLOCATION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">NO_RESERVE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_SQL_DIALECT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ODS_MINOR_VERSION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ODS_VERSION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CURRENT_MEMORY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">FORCED_WRITES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">MAX_MEMORY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">NUM_BUFFERS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">SWEEP_INTERVAL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ATTACHMENT_ID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">FETCHES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">MARKS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">READS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">WRITES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">SET_PAGE_BUFFERS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_READ_ONLY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_SIZE_IN_PAGES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGE_ERRORS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">RECORD_ERRORS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">BPAGE_ERRORS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DPAGE_ERRORS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">IPAGE_ERRORS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PPAGE_ERRORS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">TPAGE_ERRORS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ATT_CHARSET</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">OLDEST_TRANSACTION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">OLDEST_ACTIVE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">OLDEST_SNAPSHOT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">NEXT_TRANSACTION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ACTIVE_TRAN_COUNT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_CLASS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_PROVIDER</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGES_USED</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGES_FREE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CRYPT_KEY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_string</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CRYPT_STATE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crypt_state</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CONN_FLAGS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__con_state</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">BACKOUT_COUNT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tbl_perf_count</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DELETE_COUNT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tbl_perf_count</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">EXPUNGE_COUNT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tbl_perf_count</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">INSERT_COUNT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tbl_perf_count</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PURGE_COUNT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tbl_perf_count</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">READ_IDX_COUNT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tbl_perf_count</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">READ_SEQ_COUNT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tbl_perf_count</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">UPDATE_COUNT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tbl_perf_count</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CREATION_DATE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__creation_date</span><span class="p">,</span>
             <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGE_CONTENTS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">,</span>
             <span class="p">}</span>
        <span class="c1"># Page size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__page_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">)</span>  <span class="c1"># prefetch it</span>
        <span class="c1"># Get Firebird engine version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__version</span> <span class="o">=</span> <span class="n">_engine_version_provider</span><span class="o">.</span><span class="n">get_server_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__engine_version</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__db_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>  <span class="c1"># Cluster length</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_pascal_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_charset</span><span class="p">))</span>
            <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">__implementation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ImpCPU</span><span class="p">,</span> <span class="n">ImpOS</span><span class="p">,</span> <span class="n">ImpCompiler</span><span class="p">,</span> <span class="n">ImpFlags</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>  <span class="c1"># Cluster length</span>
        <span class="n">cpu_id</span> <span class="o">=</span> <span class="n">ImpCPU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">())</span>
        <span class="n">os_id</span> <span class="o">=</span> <span class="n">ImpOS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">())</span>
        <span class="n">compiler_id</span> <span class="o">=</span> <span class="n">ImpCompiler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">())</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ImpFlags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cpu_id</span><span class="p">,</span> <span class="n">os_id</span><span class="p">,</span> <span class="n">compiler_id</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__implementation_old</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>  <span class="c1"># Cluster length</span>
        <span class="n">impl_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">()</span>
        <span class="n">class_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">impl_number</span><span class="p">,</span> <span class="n">class_number</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_info_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">()</span>  <span class="c1"># Cluster length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>  <span class="c1"># number of strings</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_pascal_string</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__user_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span> <span class="c1"># necessary to process names separated by info tag</span>
        <span class="n">usernames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span> <span class="c1"># DbInfoCode.USER_NAMES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>  <span class="c1"># cluster length</span>
            <span class="n">usernames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_pascal_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_charset</span><span class="p">))</span>
        <span class="c1"># The client-exposed return value is a dictionary mapping</span>
        <span class="c1"># username -&gt; number of connections by that user.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">usernames</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">__tra_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>  <span class="c1"># DbInfoCode.ACTIVE_TRANSACTIONS</span>
            <span class="n">tid_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tid_size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">tra_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_int</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">tid_size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">tra_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_bigint</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong transaction ID size </span><span class="si">{</span><span class="n">tid_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tra_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">__tra_limbo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>  <span class="c1"># Total data length</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
            <span class="n">tid_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tid_size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">tra_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_int</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">tid_size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">tra_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_bigint</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong transaction ID size </span><span class="si">{</span><span class="n">tid_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tra_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">__crypt_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EncryptionFlag</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EncryptionFlag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__con_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConnectionFlag</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ConnectionFlag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__tbl_perf_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">clen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>  <span class="c1"># Cluster length</span>
        <span class="k">while</span> <span class="n">clen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">relation_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">relation_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_int</span><span class="p">()</span>
            <span class="n">clen</span> <span class="o">-=</span> <span class="mi">6</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">__creation_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">decode_date</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="mi">4</span><span class="p">]),</span>
                                         <span class="n">_util</span><span class="o">.</span><span class="n">decode_time</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">:]))</span>
<div class="viewcode-block" id="DatabaseInfoProvider3._close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3._close">[docs]</a>    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Drops the association with attached database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_con</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="DatabaseInfoProvider3._acquire"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3._acquire">[docs]</a>    <span class="k">def</span> <span class="nf">_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Acquires information from associated attachment. Information is stored in native</span>
<span class="sd">        format in `response` buffer.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            request: Data specifying the required information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">()</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span></div>
<div class="viewcode-block" id="DatabaseInfoProvider3.get_info"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info_code</span><span class="p">:</span> <span class="n">DbInfoCode</span><span class="p">,</span> <span class="n">page_number</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns requested information from associated attachment.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            info_code: A code specifying the required information.</span>
<span class="sd">            page_number: A page number for `DbInfoCode.PAGE_CONTENTS` request. Ignored for other requests.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The data type of returned value depends on information required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">info_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">info_code</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">info_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Info code </span><span class="si">{</span><span class="n">info_code</span><span class="si">}</span><span class="s2"> not supported by engine version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__engine_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">info_code</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">info_code</span> <span class="o">==</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGE_CONTENTS</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
            <span class="n">request</span> <span class="o">+=</span> <span class="n">page_number</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">+</span> <span class="mi">10</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">tag</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">info_code</span> <span class="o">==</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ACTIVE_TRANSACTIONS</span><span class="p">:</span>
                <span class="c1"># isc_info_active_transactions with no active transactions returns empty buffer</span>
                <span class="c1"># and does not follow this rule</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">isc_info_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;An error response was received&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Result code does not match request code&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info_code</span> <span class="o">==</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ACTIVE_TRANSACTIONS</span><span class="p">:</span>
            <span class="c1"># we&#39;ll rewind back, otherwise it will break the repeating cluster processing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">info_code</span><span class="p">]()</span>
        <span class="c1"># cache</span>
        <span class="k">if</span> <span class="n">info_code</span> <span class="ow">in</span> <span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CREATION_DATE</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_CLASS</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_PROVIDER</span><span class="p">,</span>
                         <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_SQL_DIALECT</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ODS_MINOR_VERSION</span><span class="p">,</span>
                         <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ODS_VERSION</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">VERSION</span><span class="p">,</span>
                         <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">FIREBIRD_VERSION</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">IMPLEMENTATION_OLD</span><span class="p">,</span>
                         <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">IMPLEMENTATION</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_ID</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">BASE_LEVEL</span><span class="p">,</span>
                         <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ATTACHMENT_ID</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">info_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span></div>
    <span class="c1"># Functions</span>
<div class="viewcode-block" id="DatabaseInfoProvider3.get_page_content"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3.get_page_content">[docs]</a>    <span class="k">def</span> <span class="nf">get_page_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns content of single database page.</span>

<span class="sd">        Arguments:</span>
<span class="sd">           page_number: Sequence number of database page to be fetched from server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGE_CONTENTS</span><span class="p">,</span> <span class="n">page_number</span><span class="p">)</span></div>
<div class="viewcode-block" id="DatabaseInfoProvider3.get_active_transaction_ids"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3.get_active_transaction_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_active_transaction_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns list of IDs of active transactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ACTIVE_TRANSACTIONS</span><span class="p">)</span></div>
<div class="viewcode-block" id="DatabaseInfoProvider3.get_active_transaction_count"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3.get_active_transaction_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_active_transaction_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns number of active transactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ACTIVE_TRAN_COUNT</span><span class="p">)</span></div>
<div class="viewcode-block" id="DatabaseInfoProvider3.get_table_access_stats"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3.get_table_access_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_access_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TableAccessStats</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns actual table access statistics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">READ_SEQ_COUNT</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">READ_IDX_COUNT</span><span class="p">,</span>
                      <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">INSERT_COUNT</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">UPDATE_COUNT</span><span class="p">,</span>
                      <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DELETE_COUNT</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">BACKOUT_COUNT</span><span class="p">,</span>
                      <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PURGE_COUNT</span><span class="p">,</span> <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">EXPUNGE_COUNT</span><span class="p">]</span>
        <span class="c1">#stats = self.get_info(info_codes)</span>
        <span class="k">for</span> <span class="n">info_code</span> <span class="ow">in</span> <span class="n">info_codes</span><span class="p">:</span>
            <span class="n">stat</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">info_code</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tables</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">info_codes</span><span class="p">))[</span><span class="n">info_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">TableAccessStats</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">_i2name</span><span class="p">[</span><span class="n">code</span><span class="p">]:</span><span class="n">count</span>
                                           <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
                <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]</span> <span class="c1"># pylint: disable=C0206</span></div>
<div class="viewcode-block" id="DatabaseInfoProvider3.is_compressed"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3.is_compressed">[docs]</a>    <span class="k">def</span> <span class="nf">is_compressed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if connection to the server uses data compression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ConnectionFlag</span><span class="o">.</span><span class="n">COMPRESSED</span> <span class="ow">in</span> <span class="n">ConnectionFlag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CONN_FLAGS</span><span class="p">))</span></div>
<div class="viewcode-block" id="DatabaseInfoProvider3.is_encrypted"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider3.is_encrypted">[docs]</a>    <span class="k">def</span> <span class="nf">is_encrypted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if connection to the server uses data encryption.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ConnectionFlag</span><span class="o">.</span><span class="n">ENCRYPTED</span> <span class="ow">in</span> <span class="n">ConnectionFlag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CONN_FLAGS</span><span class="p">))</span></div>
    <span class="c1"># Properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Attachment ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ATTACHMENT_ID</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">charset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database character set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">()</span><span class="o">.</span><span class="n">_tra_qry</span><span class="p">,</span> <span class="n">bypass</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">()</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT RDB$CHARACTER_SET_NAME FROM RDB$DATABASE&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">()</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">page_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Page size (in bytes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__page_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sql_dialect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;SQL dialect used by connected database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_SQL_DIALECT</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database name (filename or alias).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_ID</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">site</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database site name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_ID</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">server_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Firebird server version (compatible with InterBase version).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">firebird_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Firebird server version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">FIREBIRD_VERSION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">implementation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Implementation</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Implementation (old format).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Implementation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">IMPLEMENTATION_OLD</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">provider</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DbProvider</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database Provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DbProvider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_PROVIDER</span><span class="p">))</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DbClass</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database Class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DbClass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_CLASS</span><span class="p">))</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">creation_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Date when database was created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CREATION_DATE</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ods</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database On-Disk Structure version (&lt;major&gt;.&lt;minor&gt;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ods_version</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ods_minor_version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ods_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database On-Disk Structure MAJOR version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ODS_VERSION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ods_minor_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database On-Disk Structure MINOR version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ODS_MINOR_VERSION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">page_cache_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Size of page cache used by connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">NUM_BUFFERS</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pages_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of pages allocated for database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">ALLOCATION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size_in_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database size in pages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_SIZE_IN_PAGES</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pages_used</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of database pages in active use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGES_USED</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pages_free</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of free allocated pages in database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PAGES_FREE</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sweep_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sweep interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">SWEEP_INTERVAL</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">space_reservation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DbSpaceReservation</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Data page space usage (USE_FULL or RESERVE).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DbSpaceReservation</span><span class="o">.</span><span class="n">USE_FULL</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">NO_RESERVE</span><span class="p">)</span> <span class="k">else</span> <span class="n">DbSpaceReservation</span><span class="o">.</span><span class="n">RESERVE</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">write_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DbWriteMode</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database write mode (SYNC or ASYNC).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DbWriteMode</span><span class="o">.</span><span class="n">SYNC</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">FORCED_WRITES</span><span class="p">)</span> <span class="k">else</span> <span class="n">DbWriteMode</span><span class="o">.</span><span class="n">ASYNC</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">access_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DbAccessMode</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database access mode (READ_ONLY or READ_WRITE).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DbAccessMode</span><span class="o">.</span><span class="n">READ_ONLY</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_READ_ONLY</span><span class="p">)</span> <span class="k">else</span> <span class="n">DbAccessMode</span><span class="o">.</span><span class="n">READ_WRITE</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Current I/O statistics - Reads from disk to page cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">READS</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fetches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Current I/O statistics - Fetches from page cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">FETCHES</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cache_hit_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cache hit ratio = 1 - (reads / fetches).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reads</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetches</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetches</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">writes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Current I/O statistics - Writes from page cache to disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">WRITES</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">marks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Current I/O statistics - Writes to page in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">MARKS</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Total amount of memory curretly used by database engine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CURRENT_MEMORY</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Max. total amount of memory so far used by database engine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">MAX_MEMORY</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">oit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;ID of Oldest Interesting Transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">OLDEST_TRANSACTION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">oat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;ID of Oldest Active Transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">OLDEST_ACTIVE</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;ID of Oldest Snapshot Transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">OLDEST_SNAPSHOT</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">next_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;ID for next transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">DbInfoCode</span><span class="o">.</span><span class="n">NEXT_TRANSACTION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Firebird version as SEMVER string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__version</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">engine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Firebird version as &lt;major&gt;.&lt;minor&gt; float number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__engine_version</span></div>

<div class="viewcode-block" id="DatabaseInfoProvider"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DatabaseInfoProvider">[docs]</a><span class="k">class</span> <span class="nc">DatabaseInfoProvider</span><span class="p">(</span><span class="n">DatabaseInfoProvider3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides access to information about attached database [Firebird 4+].</span>

<span class="sd">    Important:</span>
<span class="sd">       Do NOT create instances of this class directly! Use `Connection.info` property to</span>
<span class="sd">       access the instance already bound to attached database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">SES_IDLE_TIMEOUT_DB</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">SES_IDLE_TIMEOUT_ATT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">SES_IDLE_TIMEOUT_RUN</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">STMT_TIMEOUT_DB</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">STMT_TIMEOUT_ATT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">PROTOCOL_VERSION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CRYPT_PLUGIN</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_string</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">CREATION_TIMESTAMP_TZ</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__creation_tstz</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">WIRE_CRYPT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_string</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">FEATURES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__features</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">NEXT_ATTACHMENT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">NEXT_STATEMENT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_GUID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_string</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">DB_FILE_ID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_string</span><span class="p">,</span>
            <span class="n">DbInfoCode</span><span class="o">.</span><span class="n">REPLICA_MODE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__replica_mode</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">def</span> <span class="nf">__creation_tstz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_util</span><span class="o">.</span><span class="n">decode_timestamp_tz</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__features</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Features</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__replica_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReplicaMode</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ReplicaMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">())</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">idle_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Attachment idle timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">()</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">get_idle_timeout</span><span class="p">()</span>
    <span class="nd">@idle_timeout</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">set_idle_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">()</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">set_idle_timeout</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">statement_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Statement timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">()</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">get_statement_timeout</span><span class="p">()</span>
    <span class="nd">@statement_timeout</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">set_statement_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_con</span><span class="p">()</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">set_statement_timeout</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection">[docs]</a><span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">LoggingIdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Connection to the database.</span>

<span class="sd">    Note:</span>
<span class="sd">        Implements context manager protocol to call `.close()` automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># PEP 249 (Python DB API 2.0) extension</span>
    <span class="ne">Warning</span> <span class="o">=</span> <span class="ne">Warning</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">Error</span>
    <span class="n">InterfaceError</span> <span class="o">=</span> <span class="n">InterfaceError</span>
    <span class="n">DatabaseError</span> <span class="o">=</span> <span class="n">DatabaseError</span>
    <span class="n">DataError</span> <span class="o">=</span> <span class="n">DataError</span>
    <span class="n">OperationalError</span> <span class="o">=</span> <span class="n">OperationalError</span>
    <span class="n">IntegrityError</span> <span class="o">=</span> <span class="n">IntegrityError</span>
    <span class="n">InternalError</span> <span class="o">=</span> <span class="n">InternalError</span>
    <span class="n">ProgrammingError</span> <span class="o">=</span> <span class="n">ProgrammingError</span>
    <span class="n">NotSupportedError</span> <span class="o">=</span> <span class="n">NotSupportedError</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">:</span> <span class="n">iAttachment</span><span class="p">,</span> <span class="n">dsn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dpb</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sql_dialect</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_att</span><span class="p">:</span> <span class="n">iAttachment</span> <span class="o">=</span> <span class="n">att</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Connection[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_db_handle</span><span class="p">()</span><span class="si">}</span><span class="s1">]&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__charset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">charset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__precision_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sqlsubtype_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ecollectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">EventCollector</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dsn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dsn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sql_dialect</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">sql_dialect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CHARSET_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dpb</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">dpb</span>
        <span class="c1">#: Default TPB for newly created transaction managers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_tpb</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">tpb</span><span class="p">(</span><span class="n">Isolation</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TransactionManager</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Statement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ev</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__info</span><span class="p">:</span> <span class="n">DatabaseInfoProvider</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tra_main</span><span class="p">:</span> <span class="n">TransactionManager</span> <span class="o">=</span> <span class="n">TransactionManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_tpb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tra_main</span><span class="o">.</span><span class="n">_logging_id_</span> <span class="o">=</span> <span class="s1">&#39;Transaction.Main&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tra_qry</span><span class="p">:</span> <span class="n">TransactionManager</span> <span class="o">=</span> <span class="n">TransactionManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                               <span class="n">tpb</span><span class="p">(</span><span class="n">Isolation</span><span class="o">.</span><span class="n">READ_COMMITTED_RECORD_VERSION</span><span class="p">,</span>
                                                                   <span class="n">access_mode</span><span class="o">=</span><span class="n">TraAccessMode</span><span class="o">.</span><span class="n">READ</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tra_qry</span><span class="o">.</span><span class="n">_logging_id_</span> <span class="o">=</span> <span class="s1">&#39;Transaction.Query&#39;</span>
        <span class="c1"># Cursor for internal use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_transaction</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">_dead_con</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">_logging_id_</span> <span class="o">=</span> <span class="s1">&#39;Cursor.internal&#39;</span>
        <span class="c1"># firebird.lib extensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__schema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__monitor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__FIREBIRD_LIB__</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_id</span><span class="si">}</span><span class="s2">&#39; disposed without prior close()&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_internals</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__str</span>
    <span class="k">def</span> <span class="nf">_get_db_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">isc_status</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_STATUS_ARRAY</span><span class="p">()</span>
        <span class="n">db_handle</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span>
        <span class="n">api</span><span class="o">.</span><span class="n">fb_get_database_handle</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                          <span class="n">isc_status</span><span class="p">,</span>
                                          <span class="s2">&quot;Error in Cursor._unpack_output:fb_get_database_handle()&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db_handle</span><span class="o">.</span><span class="n">value</span>
    <span class="k">def</span> <span class="nf">__stmt_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statements</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__schema</span><span class="o">.</span><span class="n">_set_internal</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__schema</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__monitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__monitor</span><span class="o">.</span><span class="n">_set_internal</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__monitor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">collector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ecollectors</span><span class="p">:</span>
            <span class="n">collector</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_transaction</span><span class="o">.</span><span class="n">_finish</span><span class="p">(</span><span class="n">DefaultAction</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_transaction</span><span class="o">.</span><span class="n">_finish</span><span class="p">(</span><span class="n">DefaultAction</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transactions</span><span class="p">:</span>
            <span class="n">tra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transactions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">tra</span><span class="o">.</span><span class="n">default_action</span> <span class="o">=</span> <span class="n">DefaultAction</span><span class="o">.</span><span class="n">ROLLBACK</span>  <span class="c1"># Required by Python DB API 2.0</span>
            <span class="n">tra</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statements</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statements</span><span class="o">.</span><span class="n">pop</span><span class="p">()()</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_close_internals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_transaction</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_transaction</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__info</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_engine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ev</span> <span class="o">=</span> <span class="n">_engine_version_provider</span><span class="o">.</span><span class="n">get_engine_version</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ev</span>
    <span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tra</span><span class="p">:</span> <span class="n">TransactionManager</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Statement</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_commit</span> <span class="o">:=</span> <span class="ow">not</span> <span class="n">tra</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="n">tra</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">tra</span><span class="o">.</span><span class="n">_tra</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sql_dialect</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sql_dialect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stmt_deleted</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_commit</span><span class="p">:</span>
            <span class="n">tra</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">_determine_field_precision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">ItemMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">meta</span><span class="o">.</span><span class="n">relation</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">meta</span><span class="o">.</span><span class="n">field</span><span class="p">):</span>
            <span class="c1"># Either or both field name and relation name are not provided,</span>
            <span class="c1"># so we cannot determine field precision. It&#39;s normal situation</span>
            <span class="c1"># for example for queries with dynamically computed fields</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># Special case for automatic RDB$DB_KEY fields.</span>
        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DB_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;RDB$DB_KEY&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__precision_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">meta</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">field</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">precision</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">precision</span>
        <span class="c1"># First, try table</span>
        <span class="k">with</span> <span class="n">transaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tra_qry</span><span class="p">,</span> <span class="n">bypass</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT FIELD_SPEC.RDB$FIELD_PRECISION&quot;</span>
                                   <span class="s2">&quot; FROM RDB$FIELDS FIELD_SPEC,&quot;</span>
                                   <span class="s2">&quot; RDB$RELATION_FIELDS REL_FIELDS&quot;</span>
                                   <span class="s2">&quot; WHERE&quot;</span>
                                   <span class="s2">&quot; FIELD_SPEC.RDB$FIELD_NAME =&quot;</span>
                                   <span class="s2">&quot; REL_FIELDS.RDB$FIELD_SOURCE&quot;</span>
                                   <span class="s2">&quot; AND REL_FIELDS.RDB$RELATION_NAME = ?&quot;</span>
                                   <span class="s2">&quot; AND REL_FIELDS.RDB$FIELD_NAME = ?&quot;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">field</span><span class="p">)):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Next, try stored procedure output parameter</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT FIELD_SPEC.RDB$FIELD_PRECISION&quot;</span>
                                       <span class="s2">&quot; FROM RDB$FIELDS FIELD_SPEC,&quot;</span>
                                       <span class="s2">&quot; RDB$PROCEDURE_PARAMETERS REL_FIELDS&quot;</span>
                                       <span class="s2">&quot; WHERE&quot;</span>
                                       <span class="s2">&quot; FIELD_SPEC.RDB$FIELD_NAME =&quot;</span>
                                       <span class="s2">&quot; REL_FIELDS.RDB$FIELD_SOURCE&quot;</span>
                                       <span class="s2">&quot; AND RDB$PROCEDURE_NAME = ?&quot;</span>
                                       <span class="s2">&quot; AND RDB$PARAMETER_NAME = ?&quot;</span>
                                       <span class="s2">&quot; AND RDB$PARAMETER_TYPE = 1&quot;</span><span class="p">,</span>
                                       <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">field</span><span class="p">)):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__precision_cache</span><span class="p">[(</span><span class="n">meta</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">field</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># We ran out of options</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">_get_array_sqlsubtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">subtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sqlsubtype_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">relation</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">subtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">subtype</span>
        <span class="k">with</span> <span class="n">transaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tra_qry</span><span class="p">,</span> <span class="n">bypass</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT FIELD_SPEC.RDB$FIELD_SUB_TYPE&quot;</span>
                                   <span class="s2">&quot; FROM RDB$FIELDS FIELD_SPEC, RDB$RELATION_FIELDS REL_FIELDS&quot;</span>
                                   <span class="s2">&quot; WHERE&quot;</span>
                                   <span class="s2">&quot; FIELD_SPEC.RDB$FIELD_NAME = REL_FIELDS.RDB$FIELD_SOURCE&quot;</span>
                                   <span class="s2">&quot; AND REL_FIELDS.RDB$RELATION_NAME = ?&quot;</span>
                                   <span class="s2">&quot; AND REL_FIELDS.RDB$FIELD_NAME = ?&quot;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">column</span><span class="p">)):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ic</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sqlsubtype_cache</span><span class="p">[(</span><span class="n">relation</span><span class="p">,</span> <span class="n">column</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>
<div class="viewcode-block" id="Connection.drop_database"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.drop_database">[docs]</a>    <span class="k">def</span> <span class="nf">drop_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Drops the connected database.</span>

<span class="sd">        Note:</span>

<span class="sd">            Closes all event collectors, transaction managers (with rollback) and statements</span>
<span class="sd">            associated with this connection before attempt to drop the database.</span>

<span class="sd">        Hooks:</span>
<span class="sd">            Event `.ConnectionHook.DROPPED`: Executed after database is sucessfuly dropped.</span>
<span class="sd">            Hook must have signature::</span>

<span class="sd">                hook_func(connection: Connection) -&gt; None</span>

<span class="sd">            Any value returned by hook is ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_internals</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">drop_database</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">get_callbacks</span><span class="p">(</span><span class="n">ConnectionHook</span><span class="o">.</span><span class="n">DROPPED</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="Connection.execute_immediate"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.execute_immediate">[docs]</a>    <span class="k">def</span> <span class="nf">execute_immediate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Executes SQL statement.</span>

<span class="sd">        Important:</span>

<span class="sd">            The statement MUST NOT return any result. The statement is executed in the</span>
<span class="sd">            context of `.main_transaction`.</span>

<span class="sd">        Arguments:</span>
<span class="sd">           sql: SQL statement to be executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_transaction</span><span class="o">.</span><span class="n">execute_immediate</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>
<div class="viewcode-block" id="Connection.event_collector"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.event_collector">[docs]</a>    <span class="k">def</span> <span class="nf">event_collector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">EventCollector</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create new `EventCollector` instance for this connection.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            event_names: Sequence of database event names to whom the collector should be subscribed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">isc_status</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_STATUS_ARRAY</span><span class="p">()</span>
        <span class="n">db_handle</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">fb_get_database_handle</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                          <span class="n">isc_status</span><span class="p">,</span>
                                          <span class="s2">&quot;Error in Connection.get_events:fb_get_database_handle()&quot;</span><span class="p">)</span>
        <span class="n">conduit</span> <span class="o">=</span> <span class="n">EventCollector</span><span class="p">(</span><span class="n">db_handle</span><span class="p">,</span> <span class="n">event_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ecollectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conduit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conduit</span></div>
<div class="viewcode-block" id="Connection.close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close the connection and release all associated resources.</span>

<span class="sd">        Closes all event collectors, transaction managers (with rollback) and statements</span>
<span class="sd">        associated with this connection before attempt (see Hooks) to close the</span>
<span class="sd">        connection itself.</span>

<span class="sd">        Hooks:</span>
<span class="sd">            Event `.ConnectionHook.DETACH_REQUEST`: Executed before connection</span>
<span class="sd">            is closed. Hook must have signature::</span>

<span class="sd">                hook_func(connection: Connection) -&gt; bool</span>

<span class="sd">            .. note::</span>

<span class="sd">               If any hook function returns True, connection is NOT closed.</span>

<span class="sd">            Event `.ConnectionHook.CLOSED`: Executed after connection is closed.</span>
<span class="sd">            Hook must have signature::</span>

<span class="sd">                hook_func(connection: Connection) -&gt; None</span>

<span class="sd">            Any value returned by hook is ignored.</span>

<span class="sd">        Important:</span>
<span class="sd">            Closed connection SHALL NOT be used anymore.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="n">retain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">DatabaseError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">get_callbacks</span><span class="p">(</span><span class="n">ConnectionHook</span><span class="o">.</span><span class="n">DETACH_REQUEST</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">retain</span><span class="p">:</span>
                    <span class="n">retain</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">retain</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_close_internals</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">get_callbacks</span><span class="p">(</span><span class="n">ConnectionHook</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                        <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="Connection.transaction_manager"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.transaction_manager">[docs]</a>    <span class="k">def</span> <span class="nf">transaction_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_tpb</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">default_action</span><span class="p">:</span> <span class="n">DefaultAction</span><span class="o">=</span><span class="n">DefaultAction</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionManager</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create new `TransactionManager` instance for this connection.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            default_tpb: Default Transaction parameter buffer.</span>
<span class="sd">            default_action: Default action to be performed on implicit transaction end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">tra</span> <span class="o">=</span> <span class="n">TransactionManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_tpb</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_tpb</span><span class="p">,</span> <span class="n">default_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tra</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tra</span></div>
<div class="viewcode-block" id="Connection.begin"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.begin">[docs]</a>    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpb</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pylint: disable=W0621</span>
        <span class="sd">&quot;&quot;&quot;Starts new transaction managed by `.main_transaction`.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            tpb: Transaction parameter buffer with transaction parameters. If not specified,</span>
<span class="sd">                 the `.default_tpb` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">tpb</span><span class="p">)</span></div>
<div class="viewcode-block" id="Connection.savepoint"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.savepoint">[docs]</a>    <span class="k">def</span> <span class="nf">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a new savepoint for transaction managed by `.main_transaction`.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: Name for the savepoint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_transaction</span><span class="o">.</span><span class="n">savepoint</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>
<div class="viewcode-block" id="Connection.commit"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">retaining</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Commits the transaction managed by `.main_transaction`.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            retaining: When True, the transaction context is retained after commit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">retaining</span><span class="o">=</span><span class="n">retaining</span><span class="p">)</span></div>
<div class="viewcode-block" id="Connection.rollback"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.rollback">[docs]</a>    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">retaining</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rolls back the transaction managed by `.main_transaction`.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            retaining: When True, the transaction context is retained after rollback.</span>
<span class="sd">            savepoint: When specified, the transaction is rolled back to savepoint with given name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">retaining</span><span class="o">=</span><span class="n">retaining</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="n">savepoint</span><span class="p">)</span></div>
<div class="viewcode-block" id="Connection.cursor"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.cursor">[docs]</a>    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns new `Cursor` instance associated with `.main_transaction`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_transaction</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></div>
<div class="viewcode-block" id="Connection.ping"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.ping">[docs]</a>    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Checks connection status. If test fails the only operation possible</span>
<span class="sd">        with connection is to close it.</span>

<span class="sd">        Raises:</span>
<span class="sd">          DatabaseError: When connection is dead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span></div>
<div class="viewcode-block" id="Connection.is_active"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.is_active">[docs]</a>    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if `.main_transaction` has active transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tra_main</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span></div>
<div class="viewcode-block" id="Connection.is_closed"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Connection.is_closed">[docs]</a>    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if connection to the database is closed.</span>

<span class="sd">        Important:</span>
<span class="sd">            Closed connection SHALL NOT be used anymore.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_att</span> <span class="ow">is</span> <span class="kc">None</span></div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dsn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Connection string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dsn</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">DatabaseInfoProvider3</span><span class="p">,</span> <span class="n">DatabaseInfoProvider</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Access to various information about attached database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="o">=</span> <span class="n">DatabaseInfoProvider</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_version</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">4.0</span> \
                <span class="k">else</span> <span class="n">DatabaseInfoProvider3</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">charset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Connection character set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__charset</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sql_dialect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Connection SQL dialect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sql_dialect</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">main_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionManager</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Main transaction manager for this connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tra_main</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">query_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionManager</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Transaction manager for Read-committed Read-only query transactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tra_qry</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TransactionManager</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List of all transaction managers associated with connection.</span>

<span class="sd">        Note:</span>
<span class="sd">            The first two are always `.main_transaction` and `.query_transaction` managers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_transaction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_transaction</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transactions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;firebird.lib.schema.Schema&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Access to database schema. Requires firebird.lib package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">firebird.lib.schema</span> <span class="c1"># pylint: disable=C0415</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__schema</span> <span class="o">=</span> <span class="n">firebird</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Schema</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__schema</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__schema</span><span class="o">.</span><span class="n">_set_internal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__schema</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;firebird.lib.monitor.Monitor&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Access to database monitoring tables. Requires firebird.lib package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__monitor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">firebird.lib.monitor</span> <span class="c1"># pylint: disable=C0415</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__monitor</span> <span class="o">=</span> <span class="n">firebird</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">Monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__monitor</span><span class="o">.</span><span class="n">_set_internal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__monitor</span></div>

<div class="viewcode-block" id="tpb"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.tpb">[docs]</a><span class="k">def</span> <span class="nf">tpb</span><span class="p">(</span><span class="n">isolation</span><span class="p">:</span> <span class="n">Isolation</span><span class="p">,</span> <span class="n">lock_timeout</span><span class="p">:</span> <span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">access_mode</span><span class="p">:</span> <span class="n">TraAccessMode</span><span class="o">=</span><span class="n">TraAccessMode</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper function to costruct simple TPB.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        isolation: Isolation level.</span>
<span class="sd">        lock_timeout: Lock timeout (-1 = Infinity)</span>
<span class="sd">        access: Access mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">TPB</span><span class="p">(</span><span class="n">isolation</span><span class="o">=</span><span class="n">isolation</span><span class="p">,</span> <span class="n">lock_timeout</span><span class="o">=</span><span class="n">lock_timeout</span><span class="p">,</span> <span class="n">access_mode</span><span class="o">=</span><span class="n">access_mode</span><span class="p">)</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()</span></div>

<span class="k">def</span> <span class="nf">_connect_helper</span><span class="p">(</span><span class="n">dsn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">NetProtocol</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">dsn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">host</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">database</span><span class="p">)</span> <span class="ow">or</span> <span class="c1"># pylint: disable=R0916</span>
            <span class="p">(</span><span class="n">dsn</span> <span class="ow">and</span> <span class="p">(</span><span class="n">host</span> <span class="ow">or</span> <span class="n">database</span><span class="p">))</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">host</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">database</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Must supply one of:</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="s2">&quot; 1. keyword argument dsn=&#39;host:/path/to/database&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="s2">&quot; 2. both keyword arguments host=&#39;host&#39; and&quot;</span>
                             <span class="s2">&quot; database=&#39;/path/to/database&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="s2">&quot; 3. only keyword argument database=&#39;/path/to/database&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dsn</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dsn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">protocol</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">://&#39;</span>
            <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">port</span><span class="p">:</span>
                <span class="n">dsn</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">/&#39;</span>
            <span class="k">elif</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">dsn</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dsn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">host</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">):</span> <span class="c1"># Windows Named Pipes</span>
                <span class="k">if</span> <span class="n">port</span><span class="p">:</span>
                    <span class="n">dsn</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dsn</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">port</span><span class="p">:</span>
                <span class="n">dsn</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">:&#39;</span>
            <span class="k">elif</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">dsn</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">:&#39;</span>
        <span class="n">dsn</span> <span class="o">+=</span> <span class="n">database</span>
    <span class="k">return</span> <span class="n">dsn</span>

<span class="k">def</span> <span class="nf">__make_connection</span><span class="p">(</span><span class="n">create</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">dsn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">utf8filename</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">dpb</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
                      <span class="n">sql_dialect</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">crypt_callback</span><span class="p">:</span> <span class="n">iCryptKeyCallbackImpl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">get_dispatcher</span><span class="p">()</span> <span class="k">as</span> <span class="n">provider</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">crypt_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">set_dbcrypt_callback</span><span class="p">(</span><span class="n">crypt_callback</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">create_database</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="n">dpb</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span> <span class="k">if</span> <span class="n">utf8filename</span> <span class="k">else</span> <span class="n">FS_ENCODING</span><span class="p">)</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">dsn</span><span class="p">,</span> <span class="n">dpb</span><span class="p">,</span> <span class="n">sql_dialect</span><span class="p">,</span> <span class="n">charset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">con</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">get_callbacks</span><span class="p">(</span><span class="n">ConnectionHook</span><span class="o">.</span><span class="n">ATTACH_REQUEST</span><span class="p">,</span> <span class="n">Connection</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">con</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="n">dpb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Error in DATABASE_ATTACH_REQUEST hook.&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
                <span class="k">if</span> <span class="n">con</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">con</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">att</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">attach_database</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="n">dpb</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span> <span class="k">if</span> <span class="n">utf8filename</span> <span class="k">else</span> <span class="n">FS_ENCODING</span><span class="p">)</span>
                <span class="n">con</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">dsn</span><span class="p">,</span> <span class="n">dpb</span><span class="p">,</span> <span class="n">sql_dialect</span><span class="p">,</span> <span class="n">charset</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">get_callbacks</span><span class="p">(</span><span class="n">ConnectionHook</span><span class="o">.</span><span class="n">ATTACHED</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
        <span class="n">hook</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">con</span>

<div class="viewcode-block" id="connect"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.connect">[docs]</a><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">no_gc</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_db_triggers</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbkey_scope</span><span class="p">:</span> <span class="n">DBKeyScope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">crypt_callback</span><span class="p">:</span> <span class="n">iCryptKeyCallbackImpl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">auth_plugin_list</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session_time_zone</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Establishes a connection to the database.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        database: DSN or Database configuration name.</span>
<span class="sd">        user: User name.</span>
<span class="sd">        password: User password.</span>
<span class="sd">        role: User role.</span>
<span class="sd">        no_gc: Do not perform garbage collection for this connection.</span>
<span class="sd">        no_db_triggers: Do not execute database triggers for this connection.</span>
<span class="sd">        dbkey_scope: DBKEY scope override for connection.</span>
<span class="sd">        crypt_callback: Callback that provides encryption key for the database.</span>
<span class="sd">        charset: Character set for connection.</span>
<span class="sd">        auth_plugin_list: List of authentication plugins override</span>
<span class="sd">        session_time_zone: Session time zone [Firebird 4]</span>

<span class="sd">    Hooks:</span>
<span class="sd">        Event `.ConnectionHook.ATTACH_REQUEST`: Executed after all parameters</span>
<span class="sd">        are preprocessed and before `Connection` is created. Hook</span>
<span class="sd">        must have signature::</span>

<span class="sd">            hook_func(dsn: str, dpb: bytes) -&gt; Optional[Connection]</span>

<span class="sd">        Hook may return `Connection` instance or None.</span>
<span class="sd">        First instance returned by any hook will become the return value</span>
<span class="sd">        of this function and other hooks are not called.</span>

<span class="sd">        Event `.ConnectionHook.ATTACHED`: Executed before `Connection` instance is</span>
<span class="sd">        returned. Hook must have signature::</span>

<span class="sd">            hook_func(connection: Connection) -&gt; None</span>

<span class="sd">        Any value returned by hook is ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">get_database</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">db_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">db_defaults</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">db_config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">srv_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">server_defaults</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">srv_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">get_server</span><span class="p">(</span><span class="n">db_config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">srv_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration for server &#39;</span><span class="si">{</span><span class="n">db_config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">charset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">charset</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">charset</span><span class="p">:</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="n">charset</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">auth_plugin_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auth_plugin_list</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">auth_plugin_list</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">session_time_zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">session_time_zone</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">session_time_zone</span><span class="o">.</span><span class="n">value</span>
    <span class="n">dsn</span> <span class="o">=</span> <span class="n">_connect_helper</span><span class="p">(</span><span class="n">db_config</span><span class="o">.</span><span class="n">dsn</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                          <span class="n">database</span><span class="p">,</span> <span class="n">db_config</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">dpb</span> <span class="o">=</span> <span class="n">DPB</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="n">trusted_auth</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">trusted_auth</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">sql_dialect</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">sql_dialect</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">charset</span><span class="o">=</span><span class="n">charset</span><span class="p">,</span> <span class="n">cache_size</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">cache_size</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">no_linger</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">no_linger</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">utf8filename</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">utf8filename</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">no_gc</span><span class="o">=</span><span class="n">no_gc</span><span class="p">,</span> <span class="n">no_db_triggers</span><span class="o">=</span><span class="n">no_db_triggers</span><span class="p">,</span> <span class="n">dbkey_scope</span><span class="o">=</span><span class="n">dbkey_scope</span><span class="p">,</span>
              <span class="n">dummy_packet_interval</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">dummy_packet_interval</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">config</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">auth_plugin_list</span><span class="o">=</span><span class="n">auth_plugin_list</span><span class="p">,</span>
              <span class="n">session_time_zone</span><span class="o">=</span><span class="n">session_time_zone</span><span class="p">,</span> <span class="n">set_bind</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">set_bind</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">decfloat_round</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">decfloat_round</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">decfloat_traps</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">decfloat_traps</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">__make_connection</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">dsn</span><span class="p">,</span> <span class="n">db_config</span><span class="o">.</span><span class="n">utf8filename</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">dpb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">(),</span>
                             <span class="n">db_config</span><span class="o">.</span><span class="n">sql_dialect</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="n">crypt_callback</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_database"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.create_database">[docs]</a><span class="k">def</span> <span class="nf">create_database</span><span class="p">(</span><span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">no_gc</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_db_triggers</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbkey_scope</span><span class="p">:</span> <span class="n">DBKeyScope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">crypt_callback</span><span class="p">:</span> <span class="n">iCryptKeyCallbackImpl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auth_plugin_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">session_time_zone</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates new database.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        database: DSN or Database configuration name.</span>
<span class="sd">        user: User name.</span>
<span class="sd">        password: User password.</span>
<span class="sd">        role: User role.</span>
<span class="sd">        no_gc: Do not perform garbage collection for this connection.</span>
<span class="sd">        no_db_triggers: Do not execute database triggers for this connection.</span>
<span class="sd">        dbkey_scope: DBKEY scope override for connection.</span>
<span class="sd">        crypt_callback: Callback that provides encryption key for the database.</span>
<span class="sd">        charset: Character set for connection.</span>
<span class="sd">        overwrite: Overwite the existing database.</span>
<span class="sd">        auth_plugin_list: List of authentication plugins override</span>
<span class="sd">        session_time_zone: Session time zone [Firebird 4]</span>

<span class="sd">    Hooks:</span>
<span class="sd">        Event `.ConnectionHook.ATTACHED`: Executed before `Connection` instance is</span>
<span class="sd">        returned. Hook must have signature::</span>

<span class="sd">            hook_func(connection: Connection) -&gt; None</span>

<span class="sd">        Any value returned by hook is ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">get_database</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">db_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">db_defaults</span>
        <span class="n">db_config</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">database</span>
        <span class="k">if</span> <span class="n">db_config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">srv_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">server_defaults</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">srv_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">get_server</span><span class="p">(</span><span class="n">db_config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">srv_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration for server &#39;</span><span class="si">{</span><span class="n">db_config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">db_config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">srv_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">server_defaults</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">srv_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">get_server</span><span class="p">(</span><span class="n">db_config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">srv_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration for server &#39;</span><span class="si">{</span><span class="n">db_config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">charset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">charset</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">charset</span><span class="p">:</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="n">charset</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">auth_plugin_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auth_plugin_list</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">auth_plugin_list</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">session_time_zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">session_time_zone</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">session_time_zone</span><span class="o">.</span><span class="n">value</span>
    <span class="n">dsn</span> <span class="o">=</span> <span class="n">_connect_helper</span><span class="p">(</span><span class="n">db_config</span><span class="o">.</span><span class="n">dsn</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                          <span class="n">db_config</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">db_config</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">dpb</span> <span class="o">=</span> <span class="n">DPB</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="n">trusted_auth</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">trusted_auth</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">sql_dialect</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">db_sql_dialect</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">charset</span><span class="o">=</span><span class="n">charset</span><span class="p">,</span> <span class="n">cache_size</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">cache_size</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">no_linger</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">no_linger</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">utf8filename</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">utf8filename</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">no_gc</span><span class="o">=</span><span class="n">no_gc</span><span class="p">,</span> <span class="n">no_db_triggers</span><span class="o">=</span><span class="n">no_db_triggers</span><span class="p">,</span> <span class="n">dbkey_scope</span><span class="o">=</span><span class="n">dbkey_scope</span><span class="p">,</span>
              <span class="n">dummy_packet_interval</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">dummy_packet_interval</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">config</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">auth_plugin_list</span><span class="o">=</span><span class="n">auth_plugin_list</span><span class="p">,</span>
              <span class="n">session_time_zone</span><span class="o">=</span><span class="n">session_time_zone</span><span class="p">,</span> <span class="n">set_bind</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">set_bind</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">decfloat_round</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">decfloat_round</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">decfloat_traps</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">decfloat_traps</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">db_cache_size</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">db_cache_size</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">forced_writes</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">forced_writes</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">page_size</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">page_size</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">reserve_space</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">reserve_space</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sweep_interval</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">sweep_interval</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">db_sql_dialect</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">db_sql_dialect</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">db_charset</span><span class="o">=</span><span class="n">db_config</span><span class="o">.</span><span class="n">db_charset</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">__make_connection</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">dsn</span><span class="p">,</span> <span class="n">db_config</span><span class="o">.</span><span class="n">utf8filename</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                             <span class="n">dpb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">(</span><span class="n">for_create</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">db_config</span><span class="o">.</span><span class="n">sql_dialect</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                             <span class="n">charset</span><span class="p">,</span> <span class="n">crypt_callback</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransactionInfoProvider3"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionInfoProvider3">[docs]</a><span class="k">class</span> <span class="nc">TransactionInfoProvider3</span><span class="p">(</span><span class="n">InfoProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides access to information about transaction [Firebird 3+].</span>

<span class="sd">    Important:</span>
<span class="sd">       Do NOT create instances of this class directly! Use `TransactionManager.info`</span>
<span class="sd">       property to access the instance already bound to transaction context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tra</span><span class="p">:</span> <span class="n">TransactionManager</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mngr</span><span class="p">:</span> <span class="n">TransactionManager</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">tra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">DbInfoCode</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">{</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">ISOLATION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isolation</span><span class="p">,</span>
             <span class="n">TraInfoCode</span><span class="o">.</span><span class="n">ACCESS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__access</span><span class="p">,</span>
             <span class="n">TraInfoCode</span><span class="o">.</span><span class="n">DBPATH</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">,</span>
             <span class="n">TraInfoCode</span><span class="o">.</span><span class="n">LOCK_TIMEOUT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lock_timeout</span><span class="p">,</span>
             <span class="n">TraInfoCode</span><span class="o">.</span><span class="n">ID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">TraInfoCode</span><span class="o">.</span><span class="n">OLDEST_INTERESTING</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">TraInfoCode</span><span class="o">.</span><span class="n">OLDEST_SNAPSHOT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
             <span class="n">TraInfoCode</span><span class="o">.</span><span class="n">OLDEST_ACTIVE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="k">def</span> <span class="nf">__isolation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Isolation</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># The value is `TraInfoIsolation` that maps to `Isolation`</span>
            <span class="k">return</span> <span class="n">Isolation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">())</span>
        <span class="c1"># The values are `TraInfoIsolation` + `TraInfoReadCommitted` that maps to `Isolation`</span>
        <span class="k">return</span> <span class="n">Isolation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_byte</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__access</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TraInfoAccess</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TraInfoAccess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__lock_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">(</span><span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mngr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mngr</span><span class="p">()</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;TransactionManager is not active&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mngr</span><span class="p">()</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mngr</span> <span class="o">=</span> <span class="kc">None</span>
<div class="viewcode-block" id="TransactionInfoProvider3.get_info"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionInfoProvider3.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info_code</span><span class="p">:</span> <span class="n">TraInfoCode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns response for transaction INFO request. The type anc content of returned</span>
<span class="sd">        value(s) depend on INFO code passed as parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">info_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Info code </span><span class="si">{</span><span class="n">info_code</span><span class="si">}</span><span class="s2"> not supported by engine version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mngr</span><span class="p">()</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">_engine_version</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">info_code</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">tag</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;An error response was received&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">isc_info_error</span>
                                 <span class="k">else</span> <span class="s2">&quot;Result code does not match request code&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">info_code</span><span class="p">]()</span></div>
    <span class="c1"># Functions</span>
<div class="viewcode-block" id="TransactionInfoProvider3.is_read_only"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionInfoProvider3.is_read_only">[docs]</a>    <span class="k">def</span> <span class="nf">is_read_only</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if transaction is Read Only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">ACCESS</span><span class="p">)</span> <span class="o">==</span> <span class="n">TraInfoAccess</span><span class="o">.</span><span class="n">READ_ONLY</span></div>
    <span class="c1"># Properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Transaction ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">oit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;ID of Oldest Interesting Transaction at the time this transaction started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">OLDEST_INTERESTING</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">oat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;ID of Oldest Active Transaction at the time this transaction started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">OLDEST_ACTIVE</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;ID of Oldest Snapshot Transaction at the time this transaction started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">OLDEST_SNAPSHOT</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isolation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Isolation</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Isolation level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">ISOLATION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lock_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Lock timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">LOCK_TIMEOUT</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">DBPATH</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">snapshot_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Snapshot number for this transaction.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotSupportedError: Requires Firebird 4+</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_not_supported</span><span class="p">()</span></div>

<div class="viewcode-block" id="TransactionInfoProvider"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionInfoProvider">[docs]</a><span class="k">class</span> <span class="nc">TransactionInfoProvider</span><span class="p">(</span><span class="n">TransactionInfoProvider3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides access to information about transaction [Firebird 4+].</span>

<span class="sd">    Important:</span>
<span class="sd">       Do NOT create instances of this class directly! Use `TransactionManager.info`</span>
<span class="sd">       property to access the instance already bound to transaction context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tra</span><span class="p">:</span> <span class="n">TransactionManager</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">tra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">SNAPSHOT_NUMBER</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_int</span><span class="p">,})</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">snapshot_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Snapshot number for this transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">TraInfoCode</span><span class="o">.</span><span class="n">SNAPSHOT_NUMBER</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransactionManager"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager">[docs]</a><span class="k">class</span> <span class="nc">TransactionManager</span><span class="p">(</span><span class="n">LoggingIdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transaction manager.</span>

<span class="sd">    Note:</span>
<span class="sd">        Implements context manager protocol to call `.close()` automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">default_tpb</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
                 <span class="n">default_action</span><span class="p">:</span> <span class="n">DefaultAction</span><span class="o">=</span><span class="n">DefaultAction</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dead_con</span><span class="p">)</span>
        <span class="c1">#: Default Transaction Parameter Block used to start transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_tpb</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">default_tpb</span>
        <span class="c1">#: Default action (commit/rollback) to be performed when transaction is closed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_action</span><span class="p">:</span> <span class="n">DefaultAction</span> <span class="o">=</span> <span class="n">default_action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__info</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TransactionInfoProvider</span><span class="p">,</span> <span class="n">TransactionInfoProvider3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursors</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Weak references to cursors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="p">:</span> <span class="n">iTransaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logging_id_</span> <span class="o">=</span> <span class="s1">&#39;Transaction&#39;</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionManager</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_id</span><span class="si">}</span><span class="s2">&#39; disposed while active&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finish</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__dead_con</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pylint: disable=W0613</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">_close_cursors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cursor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursors</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_cursor_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_action</span><span class="p">:</span> <span class="n">DefaultAction</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">default_action</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">default_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_action</span>
                <span class="k">if</span> <span class="n">default_action</span> <span class="o">==</span> <span class="n">DefaultAction</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="o">=</span> <span class="kc">None</span>
<div class="viewcode-block" id="TransactionManager.close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close the transaction manager and release all associated resources.</span>

<span class="sd">        Important:</span>
<span class="sd">            Closed instance SHALL NOT be used anymore.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_finish</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">con</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">con</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">con</span><span class="o">.</span><span class="n">_transactions</span><span class="p">:</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">_transactions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__info</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span></div>
<div class="viewcode-block" id="TransactionManager.execute_immediate"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager.execute_immediate">[docs]</a>    <span class="k">def</span> <span class="nf">execute_immediate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Executes SQL statement. The statement MUST NOT return any result.</span>

<span class="sd">        Arguments:</span>
<span class="sd">           sql: SQL statement to be executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">sql_dialect</span><span class="p">)</span></div>
<div class="viewcode-block" id="TransactionManager.begin"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager.begin">[docs]</a>    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpb</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pylint: disable=W0621</span>
        <span class="sd">&quot;&quot;&quot;Starts new transaction managed by this instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            tpb: Transaction parameter buffer with transaction&#39;s parameters. If not specified,</span>
<span class="sd">                 the `.default_tpb` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finish</span><span class="p">()</span>  <span class="c1"># Make sure that previous transaction (if any) is ended</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">start_transaction</span><span class="p">(</span><span class="n">tpb</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_tpb</span><span class="p">)</span></div>
<div class="viewcode-block" id="TransactionManager.commit"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">retaining</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Commits the transaction managed by this instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            retaining: When True, the transaction context is retained after commit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">retaining</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">commit_retaining</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_cursors</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">retaining</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="TransactionManager.rollback"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager.rollback">[docs]</a>    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">retaining</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rolls back the transaction managed by this instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            retaining: When True, the transaction context is retained after rollback.</span>
<span class="sd">            savepoint: When specified, the transaction is rolled back to savepoint with given name.</span>

<span class="sd">        Raises:</span>
<span class="sd">            InterfaceError: When both retaining and savepoint parameters are specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">retaining</span> <span class="ow">and</span> <span class="n">savepoint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t rollback to savepoint while retaining context&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savepoint</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_immediate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rollback to </span><span class="si">{</span><span class="n">savepoint</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retaining</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">rollback_retaining</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_cursors</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">retaining</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="TransactionManager.savepoint"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager.savepoint">[docs]</a>    <span class="k">def</span> <span class="nf">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a new savepoint for transaction managed by this instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: Name for the savepoint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_immediate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SAVEPOINT </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="TransactionManager.cursor"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager.cursor">[docs]</a>    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns new `Cursor` instance associated with this instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_deleted</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cur</span></div>
<div class="viewcode-block" id="TransactionManager.is_active"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager.is_active">[docs]</a>    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if transaction is active.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="TransactionManager.is_closed"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.TransactionManager.is_closed">[docs]</a>    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this transaction manager is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span></div>
    <span class="c1"># Properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">TransactionInfoProvider3</span><span class="p">,</span> <span class="n">TransactionInfoProvider</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Access to various information about active transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">TransactionInfoProvider</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">_engine_version</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">4.0</span> \
                <span class="k">else</span> <span class="n">TransactionInfoProvider3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">_encoding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="s2">&quot;Logging context [connection].&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Connection.GC&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cursors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Cursor</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Cursors associated with this transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursors</span><span class="p">]</span></div>

<div class="viewcode-block" id="DistributedTransactionManager"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DistributedTransactionManager">[docs]</a><span class="k">class</span> <span class="nc">DistributedTransactionManager</span><span class="p">(</span><span class="n">TransactionManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manages distributed transaction over multiple connections that use two-phase</span>
<span class="sd">    commit protocol.</span>

<span class="sd">    Note:</span>
<span class="sd">        Implements context manager protocol to call `.close()` automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connections</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Connection</span><span class="p">],</span> <span class="n">default_tpb</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># pylint: disable=W0231</span>
                 <span class="n">default_action</span><span class="p">:</span> <span class="n">DefaultAction</span><span class="o">=</span><span class="n">DefaultAction</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_tpb</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">default_tpb</span> <span class="k">if</span> <span class="n">default_tpb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tpb</span><span class="p">(</span><span class="n">Isolation</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_action</span><span class="p">:</span> <span class="n">DefaultAction</span> <span class="o">=</span> <span class="n">default_action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursors</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Weak references to cursors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="p">:</span> <span class="n">iTransaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtc</span><span class="p">:</span> <span class="n">iDtc</span> <span class="o">=</span> <span class="n">_master</span><span class="o">.</span><span class="n">get_dtc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logging_id_</span> <span class="o">=</span> <span class="s1">&#39;DTransaction&#39;</span>
<div class="viewcode-block" id="DistributedTransactionManager.close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DistributedTransactionManager.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close the distributed transaction manager and release all associated</span>
<span class="sd">        resources.</span>

<span class="sd">        Important:</span>
<span class="sd">            Closed instance SHALL NOT be used anymore.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_finish</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span> <span class="o">=</span> <span class="kc">True</span></div>
<div class="viewcode-block" id="DistributedTransactionManager.execute_immediate"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DistributedTransactionManager.execute_immediate">[docs]</a>    <span class="k">def</span> <span class="nf">execute_immediate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Executes SQL statement on all connections in distributed transaction.</span>
<span class="sd">        The statement MUST NOT return any result.</span>

<span class="sd">        Arguments:</span>
<span class="sd">           sql: SQL statement to be executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">connection</span><span class="o">.</span><span class="n">sql_dialect</span><span class="p">)</span></div>
<div class="viewcode-block" id="DistributedTransactionManager.begin"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DistributedTransactionManager.begin">[docs]</a>    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpb</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pylint: disable=W0621</span>
        <span class="sd">&quot;&quot;&quot;Starts new distributed transaction managed by this instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            tpb: Transaction parameter buffer with transaction&#39;s parameters. If not specified,</span>
<span class="sd">                 the `.default_tpb` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finish</span><span class="p">()</span>  <span class="c1"># Make sure that previous transaction (if any) is ended</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtc</span><span class="o">.</span><span class="n">start_builder</span><span class="p">()</span> <span class="k">as</span> <span class="n">builder</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span>
                <span class="n">builder</span><span class="o">.</span><span class="n">add_with_tpb</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">_att</span><span class="p">,</span> <span class="n">tpb</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_tpb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>
<div class="viewcode-block" id="DistributedTransactionManager.prepare"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DistributedTransactionManager.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Manually triggers the first phase of a two-phase commit (2PC).</span>

<span class="sd">        Note:</span>
<span class="sd">           Direct use of this method is optional; if preparation is not triggered</span>
<span class="sd">           manually, it will be performed implicitly by `.commit()` in a 2PC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span></div>
<div class="viewcode-block" id="DistributedTransactionManager.commit"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DistributedTransactionManager.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">retaining</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Commits the distributed transaction managed by this instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            retaining: When True, the transaction context is retained after commit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">retaining</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">commit_retaining</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_cursors</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">retaining</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="DistributedTransactionManager.rollback"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DistributedTransactionManager.rollback">[docs]</a>    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">retaining</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rolls back the distributed transaction managed by this instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            retaining: When True, the transaction context is retained after rollback.</span>
<span class="sd">            savepoint: When specified, the transaction is rolled back to savepoint with given name.</span>

<span class="sd">        Raises:</span>
<span class="sd">            InterfaceError: When both retaining and savepoint parameters are specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">retaining</span> <span class="ow">and</span> <span class="n">savepoint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t rollback to savepoint while retaining context&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savepoint</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_immediate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rollback to </span><span class="si">{</span><span class="n">savepoint</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retaining</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">rollback_retaining</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_cursors</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">retaining</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tra</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="DistributedTransactionManager.savepoint"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DistributedTransactionManager.savepoint">[docs]</a>    <span class="k">def</span> <span class="nf">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a new savepoint for distributed transaction managed by this instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: Name for the savepoint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_immediate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SAVEPOINT </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="DistributedTransactionManager.cursor"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.DistributedTransactionManager.cursor">[docs]</a>    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span><span class="p">:</span> <span class="c1"># pylint: disable=W0221</span>
        <span class="sd">&quot;&quot;&quot;Returns new `Cursor` instance associated with specified connection and</span>
<span class="sd">        this distributed transaction manager.</span>

<span class="sd">        Raises:</span>
<span class="sd">            InterfaceError: When specified connection is not associated with distributed</span>
<span class="sd">                            connection manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>
        <span class="k">if</span> <span class="n">connection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Cannot create cursor for connection that does &quot;</span>
                                 <span class="s2">&quot;not belong to this distributed transaction&quot;</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_deleted</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cur</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UNDEFINED</span></div>

<div class="viewcode-block" id="Statement"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Statement">[docs]</a><span class="k">class</span> <span class="nc">Statement</span><span class="p">(</span><span class="n">LoggingIdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepared SQL statement.</span>

<span class="sd">    Note:</span>
<span class="sd">        Implements context manager protocol to call `.free()` automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="n">iStatement</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dialect</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dead_con</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dialect</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">dialect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sql</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">sql</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span><span class="p">:</span> <span class="n">iStatement</span> <span class="o">=</span> <span class="n">stmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">:</span> <span class="n">StatementType</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span><span class="p">:</span> <span class="n">StatementFlag</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">get_flags</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_desc</span><span class="p">:</span> <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Input metadata</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">get_input_metadata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_cnt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_meta</span><span class="p">:</span> <span class="n">iMessageMetadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_meta</span> <span class="o">=</span> <span class="n">meta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get_message_length</span><span class="p">())</span>
        <span class="c1"># Output metadata</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">get_output_metadata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_meta</span><span class="p">:</span> <span class="n">iMessageMetadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_cnt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_desc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ItemMetadata</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_desc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_meta</span> <span class="o">=</span> <span class="n">meta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get_message_length</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_desc</span> <span class="o">=</span> <span class="n">create_meta_descriptors</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="o">.</span><span class="n">field</span> <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="n">meta</span><span class="o">.</span><span class="n">alias</span> <span class="k">else</span> <span class="n">meta</span><span class="o">.</span><span class="n">alias</span> <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_desc</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Statement</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_meta</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_meta</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statement &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_id</span><span class="si">}</span><span class="s2">&#39; disposed without prior free()&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_id</span><span class="si">}</span><span class="s1">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="si">}</span><span class="s1">]&#39;</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__dead_con</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pylint: disable=W0613</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">__get_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detailed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span><span class="o">.</span><span class="n">get_plan</span><span class="p">(</span><span class="n">detailed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">result</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<div class="viewcode-block" id="Statement.free"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Statement.free">[docs]</a>    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Release the statement and all associated resources.</span>

<span class="sd">        Important:</span>
<span class="sd">            The statement SHALL NOT be used after call to this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_meta</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_meta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_meta</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_meta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Statement.has_cursor"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Statement.has_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">has_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if statement has cursor (can return multiple rows).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">StatementFlag</span><span class="o">.</span><span class="n">HAS_CURSOR</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span></div>
<div class="viewcode-block" id="Statement.can_repeat"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Statement.can_repeat">[docs]</a>    <span class="k">def</span> <span class="nf">can_repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if statement could be executed repeatedly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">StatementFlag</span><span class="o">.</span><span class="n">REPEAT_EXECUTE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span></div>
    <span class="c1"># Properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="s2">&quot;Logging context [Connection]&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Connection.GC&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execution plan in classic format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_plan</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">detailed_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execution plan in new format (explained).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_plan</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;SQL statement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sql</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StatementType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Statement type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Statement timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">_engine_version</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">4.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span><span class="o">.</span><span class="n">get_timeout</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statement timeout not supported by engine version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">_engine_version</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nd">@timeout</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">_engine_version</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">4.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istmt</span><span class="o">.</span><span class="n">set_timeout</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statement timeout not supported by engine version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span><span class="o">.</span><span class="n">_engine_version</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BlobReader"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.BlobReader">[docs]</a><span class="k">class</span> <span class="nc">BlobReader</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">,</span> <span class="n">LoggingIdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handler for large BLOB values returned by server.</span>

<span class="sd">    The BlobReader is a “file-like” class, so it acts much like an open file instance.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        sub_type (int): BLOB sub-type</span>
<span class="sd">        newline (str): Sequence used as line terminator, default `&#39;\\\\n&#39;`</span>

<span class="sd">    Note:</span>
<span class="sd">        Implements context manager protocol to call `.close()` automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob</span><span class="p">:</span> <span class="n">iBlob</span><span class="p">,</span> <span class="n">blob_id</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_QUAD</span><span class="p">,</span> <span class="n">sub_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">segment_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span><span class="p">:</span> <span class="n">iBlob</span> <span class="o">=</span> <span class="n">blob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">sub_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">charset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blob_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_segment_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">segment_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blob_id</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_QUAD</span> <span class="o">=</span> <span class="n">blob_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__buf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_segment_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__buf_data</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__reset_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">memset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segment_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__buf_data</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">__blob_get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reset_buffer</span><span class="p">()</span>
        <span class="c1"># Load BLOB</span>
        <span class="n">bytes_actually_read</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Cardinal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span><span class="o">.</span><span class="n">get_segment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_segment_size</span><span class="p">,</span> <span class="n">byref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__buf</span><span class="p">),</span>
                               <span class="n">bytes_actually_read</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__buf_data</span> <span class="o">=</span> <span class="n">bytes_actually_read</span><span class="o">.</span><span class="n">value</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlobReader</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BlobReader &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_id</span><span class="si">}</span><span class="s2">&#39; disposed without prior close()&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_id</span><span class="si">}</span><span class="s1">[size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="si">}</span><span class="s1">]&#39;</span>
<div class="viewcode-block" id="BlobReader.flush"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.BlobReader.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="BlobReader.close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.BlobReader.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close the BlobReader.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="BlobReader.read"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.BlobReader.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Read at most size bytes from the file (less if the read hits EOF</span>
<span class="sd">        before obtaining size bytes). If the size argument is negative or omitted,</span>
<span class="sd">        read all data until EOF is reached. The bytes are returned as a string</span>
<span class="sd">        object. An empty string is returned when EOF is encountered immediately.</span>
<span class="sd">        Like `file.read()`.</span>

<span class="sd">        Note:</span>
<span class="sd">           Performs automatic conversion to `str` for TEXT BLOBs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_read</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pos</span>
        <span class="n">return_size</span> <span class="o">=</span> <span class="n">to_read</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">return_size</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">to_read</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_copy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">to_read</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">to_copy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__blob_get</span><span class="p">()</span>
                <span class="n">to_copy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">to_read</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">to_copy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># BLOB EOF</span>
                    <span class="k">break</span>
            <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="n">byref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span><span class="p">),</span> <span class="n">to_copy</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">to_copy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pos</span> <span class="o">+=</span> <span class="n">to_copy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span> <span class="o">+=</span> <span class="n">to_copy</span>
            <span class="n">to_read</span> <span class="o">-=</span> <span class="n">to_copy</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">raw</span><span class="p">[:</span><span class="n">return_size</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_charset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>
<div class="viewcode-block" id="BlobReader.readline"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.BlobReader.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read and return one line from the BLOB. If size is specified, at most size bytes</span>
<span class="sd">        will be read.</span>

<span class="sd">        Uses `newline` as the line terminator.</span>

<span class="sd">        Raises:</span>
<span class="sd">           InterfaceError: For non-textual BLOBs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_type</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t read line from binary BLOB&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">to_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pos</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_read</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">to_read</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="n">to_read</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">to_scan</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">to_read</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">to_scan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__blob_get</span><span class="p">()</span>
                <span class="n">to_scan</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">to_read</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">to_scan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># BLOB EOF</span>
                    <span class="k">break</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">to_scan</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span><span class="o">+</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string_at</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span><span class="p">),</span> <span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_charset</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__buf_pos</span> <span class="o">+=</span> <span class="n">pos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pos</span> <span class="o">+=</span> <span class="n">pos</span>
            <span class="n">to_read</span> <span class="o">-=</span> <span class="n">pos</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">newline</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>
<div class="viewcode-block" id="BlobReader.readlines"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.BlobReader.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hint</span><span class="p">:</span> <span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Read and return a list of lines from the stream. `hint` can be specified to</span>
<span class="sd">        control the number of lines read: no more lines will be read if the total size</span>
<span class="sd">        (in bytes/characters) of all lines so far exceeds hint.</span>

<span class="sd">        Note:</span>
<span class="sd">            It’s already possible to iterate on BLOB using `for line in blob:` ... without</span>
<span class="sd">            calling `.readlines()`.</span>

<span class="sd">        Raises:</span>
<span class="sd">           InterfaceError: For non-textual BLOBs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hint</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="n">hint</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>
<div class="viewcode-block" id="BlobReader.seek"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.BlobReader.seek">[docs]</a>    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">whence</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the file’s current position, like stdio‘s `fseek()`.</span>

<span class="sd">        See:</span>
<span class="sd">            :meth:`io.IOBase.seek()` for details.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            offset: Offset from specified position.</span>
<span class="sd">            whence: Context for offset. Accepted values: os.SEEK_SET, os.SEEK_CUR or os.SEEK_END</span>

<span class="sd">        Warning:</span>
<span class="sd">           If BLOB was NOT CREATED as `stream` BLOB, this method raises `DatabaseError`</span>
<span class="sd">           exception. This constraint is set by Firebird.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">whence</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reset_buffer</span><span class="p">()</span></div>
<div class="viewcode-block" id="BlobReader.tell"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.BlobReader.tell">[docs]</a>    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return current position in BLOB.</span>

<span class="sd">        See:</span>
<span class="sd">            :meth:`io.IOBase.tell()` for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pos</span></div>
<div class="viewcode-block" id="BlobReader.is_text"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.BlobReader.is_text">[docs]</a>    <span class="k">def</span> <span class="nf">is_text</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;True if BLOB is a text BLOB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_type</span> <span class="o">==</span> <span class="mi">1</span></div>
    <span class="c1"># Properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="s2">&quot;Logging context [owner]&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UNDEFINED</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>
        <span class="k">return</span> <span class="s1">&#39;Owner.GC&#39;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;BLOB length.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_length</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;True if the BLOB is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;File mode (&#39;r&#39; or &#39;rb&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;rb&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_type</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blob_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_QUAD</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;BLOB ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blob_id</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blob_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlobType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;BLOB type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span><span class="o">.</span><span class="n">get_info2</span><span class="p">(</span><span class="n">BlobInfoCode</span><span class="o">.</span><span class="n">TYPE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BlobType</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cursor"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor">[docs]</a><span class="k">class</span> <span class="nc">Cursor</span><span class="p">(</span><span class="n">LoggingIdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a database cursor, which is used to execute SQL statement and</span>
<span class="sd">    manage the context of a fetch operation.</span>

<span class="sd">    Note:</span>
<span class="sd">        Implements context manager protocol to call `.close()` automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: This read/write attribute specifies the number of rows to fetch at a time with</span>
    <span class="c1">#: .fetchmany(). It defaults to 1 meaning to fetch a single row at a time.</span>
    <span class="c1">#:</span>
    <span class="c1">#: Required by Python DB API 2.0</span>
    <span class="n">arraysize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">TransactionManager</span><span class="p">):</span> <span class="c1"># pylint: disable=W0621</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">:</span> <span class="n">Connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dialect</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">sql_dialect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span> <span class="n">TransactionManager</span> <span class="o">=</span> <span class="n">transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="p">:</span> <span class="n">Statement</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">:</span> <span class="n">iResultSet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span><span class="p">:</span> <span class="n">StateResult</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_flags</span><span class="p">:</span> <span class="n">CursorFlag</span> <span class="o">=</span> <span class="n">CursorFlag</span><span class="o">.</span><span class="n">NONE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output_cache</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__internal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blob_readers</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">()</span>
        <span class="c1">#: Names of columns that should be returned as `BlobReader`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_blobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#: BLOBs greater than threshold are returned as `BlobReader` instead in materialized form.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_blob_threshold</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">stream_blob_threshold</span><span class="o">.</span><span class="n">value</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blob_readers</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cursor &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_id</span><span class="si">}</span><span class="s2">&#39; disposed without prior close()&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">_dead_con</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pylint: disable=W0613</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">_extract_db_array_to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">esize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">subtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                  <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                  <span class="n">buf</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dim</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_text</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_text2</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">string_at</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">],</span> <span class="n">esize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">subtype</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># non OCTETS</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                    <span class="c1"># CHAR with multibyte encoding requires special handling</span>
                    <span class="k">if</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">69</span><span class="p">):</span>  <span class="c1"># UTF8 and GB18030</span>
                        <span class="n">reallength</span> <span class="o">=</span> <span class="n">esize</span> <span class="o">//</span> <span class="mi">4</span>
                    <span class="k">elif</span> <span class="n">subtype</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># UNICODE_FSS</span>
                        <span class="n">reallength</span> <span class="o">=</span> <span class="n">esize</span> <span class="o">//</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reallength</span> <span class="o">=</span> <span class="n">esize</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[:</span><span class="n">reallength</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_varying</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_varying2</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">string_at</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">subtype</span> <span class="o">!=</span> <span class="n">a</span><span class="o">.</span><span class="n">OCTETS</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_short</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_long</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_int64</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span> <span class="o">+</span> <span class="n">esize</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">subtype</span> <span class="ow">or</span> <span class="n">scale</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">/</span> <span class="n">_tenTo</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="mi">256</span><span class="o">-</span><span class="n">scale</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_bool</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span> <span class="o">+</span> <span class="n">esize</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_float</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_d_float</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_double</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_timestamp</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">decode_date</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="mi">4</span><span class="p">]),</span>
                                                    <span class="n">_util</span><span class="o">.</span><span class="n">decode_time</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_date</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">decode_date</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_time</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">decode_time</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_time_tz</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">decode_time_tz</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_timestamp_tz</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">decode_timestamp_tz</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_int128</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">get_int128</span><span class="p">()</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">FB_I128</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">]),</span> <span class="n">scale</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_dec64</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">get_decfloat16</span><span class="p">()</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">FB_DEC16</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_dec128</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">get_decfloat34</span><span class="p">()</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">FB_DEC34</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">bufpos</span><span class="p">:</span><span class="n">bufpos</span><span class="o">+</span><span class="n">esize</span><span class="p">])))</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported Firebird ARRAY subtype: </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">bufpos</span> <span class="o">+=</span> <span class="n">esize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dim</span><span class="p">]):</span>
                <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_db_array_to_list</span><span class="p">(</span><span class="n">esize</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">subtype</span><span class="p">,</span>
                                                               <span class="n">scale</span><span class="p">,</span> <span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                               <span class="n">dimensions</span><span class="p">,</span>
                                                               <span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">)</span>
                <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_copy_list_to_db_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">esize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">subtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                               <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                               <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">buf</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">valuebuf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_text</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_text2</span><span class="p">):</span>
            <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">esize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_varying</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_varying2</span><span class="p">):</span>
            <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">esize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_short</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_long</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_int64</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">esize</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_SHORT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">esize</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_LONG</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">esize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_INT64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Unsupported number type&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_float</span><span class="p">:</span>
            <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">esize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_d_float</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_double</span><span class="p">):</span>
            <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">esize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_timestamp</span><span class="p">:</span>
            <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">esize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_date</span><span class="p">:</span>
            <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">esize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_time</span><span class="p">:</span>
            <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">esize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_bool</span><span class="p">:</span>
            <span class="n">valuebuf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">esize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported Firebird ARRAY subtype: </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_db_array_buffer</span><span class="p">(</span><span class="n">esize</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span>
                                   <span class="n">subtype</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span>
                                   <span class="n">dim</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span>
                                   <span class="n">value</span><span class="p">,</span> <span class="n">valuebuf</span><span class="p">,</span>
                                   <span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_fill_db_array_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">esize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">subtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                              <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">valuebuf</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">buf</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dim</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_text</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_text2</span><span class="p">,</span>
                             <span class="n">a</span><span class="o">.</span><span class="n">blr_varying</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_varying2</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">esize</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ARRAY value of parameter is too long,&quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot; expected </span><span class="si">{</span><span class="n">esize</span><span class="si">}</span><span class="s2">, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_short</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_long</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_int64</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">subtype</span> <span class="ow">or</span> <span class="n">scale</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">val</span> <span class="o">*</span> <span class="n">_tenTo</span><span class="p">[</span><span class="mi">256</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">scale</span><span class="p">)])</span><span class="o">.</span><span class="n">to_integral</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="n">_tenTo</span><span class="p">[</span><span class="mi">256</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">scale</span><span class="p">)])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Objects of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s1"> are not &#39;</span>
                                            <span class="sa">f</span><span class="s1">&#39; acceptable input for&#39;</span>
                                            <span class="sa">f</span><span class="s1">&#39; a fixed-point column.&#39;</span><span class="p">)</span>
                        <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">esize</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">esize</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">esize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                            <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Unsupported type&quot;</span><span class="p">)</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span>
                                   <span class="n">byref</span><span class="p">(</span><span class="n">valuebuf</span><span class="p">),</span>
                                   <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_bool</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span>
                                   <span class="n">byref</span><span class="p">(</span><span class="n">valuebuf</span><span class="p">),</span>
                                   <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_float</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_d_float</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_double</span><span class="p">):</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_timestamp</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_encode_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_date</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_date</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_time</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_time</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_time_tz</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_time_tz</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">esize</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_timestamp_tz</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_timestamp_tz</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_dec64</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">get_decfloat16</span><span class="p">()</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_dec128</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">get_decfloat34</span><span class="p">()</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_int128</span><span class="p">:</span>
                    <span class="n">valuebuf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">get_int128</span><span class="p">()</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">scale</span><span class="p">)</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">),</span> <span class="n">valuebuf</span><span class="p">,</span> <span class="n">esize</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported Firebird ARRAY subtype: </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">bufpos</span> <span class="o">+=</span> <span class="n">esize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dim</span><span class="p">]):</span>
                <span class="n">bufpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_db_array_buffer</span><span class="p">(</span><span class="n">esize</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">subtype</span><span class="p">,</span>
                                                    <span class="n">scale</span><span class="p">,</span> <span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">dimensions</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                    <span class="n">valuebuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bufpos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bufpos</span>
    <span class="k">def</span> <span class="nf">_validate_array_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                              <span class="n">value_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sqlsubtype</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">value_scale</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">dimensions</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dim</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># leaf: check value type</span>
                <span class="k">if</span> <span class="n">value_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_text</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_text2</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_varying</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_varying2</span><span class="p">):</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_short</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_long</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_int64</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_int128</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sqlsubtype</span> <span class="ow">or</span> <span class="n">value_scale</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_dec64</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_dec128</span><span class="p">):</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value_type</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_float</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_d_float</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_double</span><span class="p">):</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_timestamp</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_timestamp_tz</span><span class="p">):</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value_type</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_date</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_sql_time</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_sql_time_tz</span><span class="p">):</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value_type</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_bool</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># non-leaf: recurse down</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_array_value</span><span class="p">(</span><span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span>
                                                       <span class="n">value_type</span><span class="p">,</span> <span class="n">sqlsubtype</span><span class="p">,</span>
                                                       <span class="n">value_scale</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="c1"># Fail early</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">ok</span>
    <span class="k">def</span> <span class="nf">_pack_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">iMessageMetadata</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">iMessageMetadata</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="c1"># pylint: disable=R1702</span>
        <span class="n">in_cnt</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="n">in_cnt</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statement parameter sequence contains&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span><span class="si">}</span><span class="s2"> items,&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot; but exactly </span><span class="si">{</span><span class="n">in_cnt</span><span class="si">}</span><span class="s2"> are required&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">buf_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">)</span>
        <span class="c1"># Adjust metadata where needed</span>
        <span class="k">with</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_builder</span><span class="p">()</span> <span class="k">as</span> <span class="n">builder</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">in_cnt</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">_is_str_param</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_type</span><span class="p">(</span><span class="n">i</span><span class="p">)):</span>
                    <span class="n">builder</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">builder</span><span class="o">.</span><span class="n">set_length</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">in_meta</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
            <span class="n">new_size</span> <span class="o">=</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_message_length</span><span class="p">()</span>
            <span class="n">in_buffer</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">new_size</span><span class="p">)</span> <span class="k">if</span> <span class="n">buf_size</span> <span class="o">&lt;</span> <span class="n">new_size</span> <span class="k">else</span> <span class="n">buffer</span>
        <span class="n">buf_addr</span> <span class="o">=</span> <span class="n">addressof</span><span class="p">(</span><span class="n">in_buffer</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">in_meta</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">in_cnt</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">datatype</span> <span class="o">=</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_offset</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="c1"># handle NULL value</span>
                <span class="n">in_buffer</span><span class="p">[</span><span class="n">in_meta</span><span class="o">.</span><span class="n">get_null_offset</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># store parameter value</span>
                <span class="k">if</span> <span class="n">_is_str_param</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datatype</span><span class="p">):</span>
                    <span class="c1"># Implicit conversion to string</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">VARYING</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value of parameter (</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">) is too long,&quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot; expected </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">SHORT</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">LONG</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">):</span>
                    <span class="c1"># It&#39;s scalled integer?</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_scale</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_subtype</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">or</span> <span class="n">scale</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">value</span> <span class="o">*</span> <span class="n">_tenTo</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">scale</span><span class="p">)])</span><span class="o">.</span><span class="n">to_integral</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="n">_tenTo</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">scale</span><span class="p">)])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Objects of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1"> are not &#39;</span>
                                            <span class="sa">f</span><span class="s1">&#39; acceptable input for&#39;</span>
                                            <span class="sa">f</span><span class="s1">&#39; a fixed-point column.&#39;</span><span class="p">)</span>
                    <span class="n">_check_integer_range</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dialect</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span>
                                         <span class="n">in_meta</span><span class="o">.</span><span class="n">get_subtype</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">scale</span><span class="p">)</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DATE</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_date</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIME</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_time</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIME_TZ</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_time_tz</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">_encode_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIMESTAMP_TZ</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">_util</span><span class="o">.</span><span class="n">encode_timestamp_tz</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DEC16</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byref</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">get_decfloat16</span><span class="p">()</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DEC34</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">_util</span><span class="o">.</span><span class="n">get_decfloat34</span><span class="p">()</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">INT128</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">_util</span><span class="o">.</span><span class="n">get_int128</span><span class="p">()</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_scale</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">BOOLEAN</span><span class="p">:</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">BLOB</span><span class="p">:</span>
                    <span class="n">blobid</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_QUAD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
                        <span class="c1"># It seems we&#39;ve got file-like object, use stream BLOB</span>
                        <span class="n">blob_buf</span> <span class="o">=</span> <span class="n">_create_blob_buffer</span><span class="p">()</span>
                        <span class="n">blob</span><span class="p">:</span> <span class="n">iBlob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">create_blob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_tra</span><span class="p">,</span>
                                                                        <span class="n">blobid</span><span class="p">,</span> <span class="n">_bpb_stream</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">blobid</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                            <span class="k">while</span> <span class="n">value_chunk</span> <span class="o">:=</span> <span class="n">value</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">MAX_BLOB_SEGMENT_SIZE</span><span class="p">):</span>
                                <span class="n">blob_buf</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">value_chunk</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_chunk</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">value_chunk</span>
                                <span class="n">blob</span><span class="o">.</span><span class="n">put_segment</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value_chunk</span><span class="p">),</span> <span class="n">blob_buf</span><span class="p">)</span>
                                <span class="n">memset</span><span class="p">(</span><span class="n">blob_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_BLOB_SEGMENT_SIZE</span><span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">blob</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">del</span> <span class="n">blob_buf</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Non-stream BLOB</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_subtype</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;String value is not&#39;</span>
                                                <span class="s1">&#39; acceptable type for&#39;</span>
                                                <span class="s1">&#39; a non-textual BLOB column.&#39;</span><span class="p">)</span>
                        <span class="n">blob_buf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">blob</span><span class="p">:</span> <span class="n">iBlob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">create_blob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_tra</span><span class="p">,</span>
                                                                        <span class="n">blobid</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">blobid</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
                            <span class="n">total_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                            <span class="n">bytes_written_so_far</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">bytes_to_write_this_time</span> <span class="o">=</span> <span class="n">MAX_BLOB_SEGMENT_SIZE</span>
                            <span class="k">while</span> <span class="n">bytes_written_so_far</span> <span class="o">&lt;</span> <span class="n">total_size</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">-</span> <span class="n">bytes_written_so_far</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_BLOB_SEGMENT_SIZE</span><span class="p">:</span>
                                    <span class="n">bytes_to_write_this_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">-</span> <span class="n">bytes_written_so_far</span><span class="p">)</span>
                                <span class="n">blob</span><span class="o">.</span><span class="n">put_segment</span><span class="p">(</span><span class="n">bytes_to_write_this_time</span><span class="p">,</span>
                                                 <span class="n">addressof</span><span class="p">(</span><span class="n">blob_buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">bytes_written_so_far</span><span class="p">)</span>
                                <span class="n">bytes_written_so_far</span> <span class="o">+=</span> <span class="n">bytes_to_write_this_time</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">blob</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">del</span> <span class="n">blob_buf</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">ARRAY</span><span class="p">:</span>
                    <span class="n">arrayid</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_QUAD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">arrayid_ptr</span> <span class="o">=</span> <span class="n">pointer</span><span class="p">(</span><span class="n">arrayid</span><span class="p">)</span>
                    <span class="n">arraydesc</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_ARRAY_DESC</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">isc_status</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_STATUS_ARRAY</span><span class="p">()</span>
                    <span class="n">db_handle</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">tr_handle</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">relname</span> <span class="o">=</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_relation</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                    <span class="n">sqlname</span> <span class="o">=</span> <span class="n">in_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                    <span class="n">api</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span>
                    <span class="n">api</span><span class="o">.</span><span class="n">fb_get_database_handle</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_att</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                                      <span class="n">isc_status</span><span class="p">,</span>
                                                      <span class="s2">&quot;Error in Cursor._pack_input:fb_get_database_handle()&quot;</span><span class="p">)</span>
                    <span class="n">api</span><span class="o">.</span><span class="n">fb_get_transaction_handle</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">tr_handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_tra</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                                      <span class="n">isc_status</span><span class="p">,</span>
                                                      <span class="s2">&quot;Error in Cursor._pack_input:fb_get_transaction_handle()&quot;</span><span class="p">)</span>
                    <span class="n">sqlsubtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_get_array_sqlsubtype</span><span class="p">(</span><span class="n">relname</span><span class="p">,</span> <span class="n">sqlname</span><span class="p">)</span>
                    <span class="n">api</span><span class="o">.</span><span class="n">isc_array_lookup_bounds</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">,</span> <span class="n">tr_handle</span><span class="p">,</span>
                                                <span class="n">relname</span><span class="p">,</span> <span class="n">sqlname</span><span class="p">,</span> <span class="n">arraydesc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                                      <span class="n">isc_status</span><span class="p">,</span>
                                                      <span class="s2">&quot;Error in Cursor._pack_input:isc_array_lookup_bounds()&quot;</span><span class="p">)</span>
                    <span class="n">value_type</span> <span class="o">=</span> <span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_dtype</span>
                    <span class="n">value_scale</span> <span class="o">=</span> <span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_scale</span>
                    <span class="n">value_size</span> <span class="o">=</span> <span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_length</span>
                    <span class="k">if</span> <span class="n">value_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_varying</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_varying2</span><span class="p">):</span>
                        <span class="n">value_size</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">total_num_elements</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_dimensions</span><span class="p">):</span>
                        <span class="n">bounds</span> <span class="o">=</span> <span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_bounds</span><span class="p">[</span><span class="n">dimension</span><span class="p">]</span>
                        <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bounds</span><span class="o">.</span><span class="n">array_bound_upper</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">array_bound_lower</span><span class="p">)</span>
                        <span class="n">total_num_elements</span> <span class="o">*=</span> <span class="n">dimensions</span><span class="p">[</span><span class="n">dimension</span><span class="p">]</span>
                    <span class="n">total_size</span> <span class="o">=</span> <span class="n">total_num_elements</span> <span class="o">*</span> <span class="n">value_size</span>
                    <span class="c1"># Validate value to make sure it matches the array structure</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_array_value</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span>
                                                      <span class="n">sqlsubtype</span><span class="p">,</span> <span class="n">value_scale</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incorrect ARRAY field value.&quot;</span><span class="p">)</span>
                    <span class="n">value_buffer</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span>
                    <span class="n">tsize</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_LONG</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_copy_list_to_db_array</span><span class="p">(</span><span class="n">value_size</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span>
                                                <span class="n">sqlsubtype</span><span class="p">,</span> <span class="n">value_scale</span><span class="p">,</span>
                                                <span class="mi">0</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span>
                                                <span class="n">value</span><span class="p">,</span> <span class="n">value_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">api</span><span class="o">.</span><span class="n">isc_array_put_slice</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">,</span> <span class="n">tr_handle</span><span class="p">,</span>
                                            <span class="n">arrayid_ptr</span><span class="p">,</span> <span class="n">arraydesc</span><span class="p">,</span>
                                            <span class="n">value_buffer</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                                      <span class="n">isc_status</span><span class="p">,</span>
                                                      <span class="s2">&quot;Error in Cursor._pack_input:/isc_array_put_slice()&quot;</span><span class="p">)</span>
                    <span class="n">memmove</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">arrayid</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="n">in_meta</span><span class="o">.</span><span class="n">add_ref</span><span class="p">()</span> <span class="c1"># Everything went just fine, so we keep the metadata past &#39;with&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">in_meta</span><span class="p">,</span> <span class="n">in_buffer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unpack_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
        <span class="c1"># pylint: disable=R1702</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span>
        <span class="n">buf_addr</span> <span class="o">=</span> <span class="n">addressof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_desc</span><span class="p">:</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="s1">&#39;&lt;NOT_IMPLEMENTED&gt;&#39;</span>
            <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">desc</span><span class="o">.</span><span class="n">null_offset</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datatype</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">datatype</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">offset</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">length</span>
                <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">string_at</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">charset</span> <span class="o">!=</span> <span class="n">a</span><span class="o">.</span><span class="n">OCTETS</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                    <span class="c1"># CHAR with multibyte encoding requires special handling</span>
                    <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">charset</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">69</span><span class="p">):</span>  <span class="c1"># UTF8 and GB18030</span>
                        <span class="n">reallength</span> <span class="o">=</span> <span class="n">length</span> <span class="o">//</span> <span class="mi">4</span>
                    <span class="k">elif</span> <span class="n">desc</span><span class="o">.</span><span class="n">charset</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># UNICODE_FSS</span>
                        <span class="n">reallength</span> <span class="o">=</span> <span class="n">length</span> <span class="o">//</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reallength</span> <span class="o">=</span> <span class="n">length</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="n">reallength</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">VARYING</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">string_at</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">string_at</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">charset</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">BOOLEAN</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">((</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">SHORT</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">LONG</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">length</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># It&#39;s scalled integer?</span>
                    <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">subtype</span> <span class="ow">or</span> <span class="n">desc</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">_tenTo</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="n">scale</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DATE</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">decode_date</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIME</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">decode_time</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIME_TZ</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">decode_time_tz</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">decode_date</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">]),</span>
                                                      <span class="n">_util</span><span class="o">.</span><span class="n">decode_time</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIMESTAMP_TZ</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">_util</span><span class="o">.</span><span class="n">decode_timestamp_tz</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">INT128</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">get_int128</span><span class="p">()</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">FB_I128</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">]),</span> <span class="n">desc</span><span class="o">.</span><span class="n">scale</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DEC16</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">get_decfloat16</span><span class="p">()</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">FB_DEC16</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DEC34</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">_util</span><span class="o">.</span><span class="n">get_decfloat34</span><span class="p">()</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">FB_DEC34</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">BLOB</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">]</span>
                    <span class="n">blobid</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_QUAD</span><span class="p">((</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">val</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">),</span>
                                        <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
                    <span class="n">blob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_att</span><span class="o">.</span><span class="n">open_blob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_tra</span><span class="p">,</span> <span class="n">blobid</span><span class="p">,</span> <span class="n">_bpb_stream</span><span class="p">)</span>
                    <span class="c1"># Get BLOB total length and max. size of segment</span>
                    <span class="n">blob_length</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">get_info2</span><span class="p">(</span><span class="n">BlobInfoCode</span><span class="o">.</span><span class="n">TOTAL_LENGTH</span><span class="p">)</span>
                    <span class="n">segment_size</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">get_info2</span><span class="p">(</span><span class="n">BlobInfoCode</span><span class="o">.</span><span class="n">MAX_SEGMENT</span><span class="p">)</span>
                    <span class="c1"># Check if stream BLOB is requested instead materialized one</span>
                    <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stream_blobs</span> <span class="ow">and</span> <span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="n">alias</span> <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">alias</span> <span class="o">!=</span> <span class="n">desc</span><span class="o">.</span><span class="n">field</span> <span class="k">else</span> <span class="n">desc</span><span class="o">.</span><span class="n">field</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_blobs</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="n">blob_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_blob_threshold</span><span class="p">)):</span>
                        <span class="c1"># Stream BLOB</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">BlobReader</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">blobid</span><span class="p">,</span> <span class="n">desc</span><span class="o">.</span><span class="n">subtype</span><span class="p">,</span> <span class="n">blob_length</span><span class="p">,</span>
                                           <span class="n">segment_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__blob_readers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Materialized BLOB</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Load BLOB</span>
                            <span class="n">blob_value</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">blob_length</span><span class="p">)</span>
                            <span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">bytes_actually_read</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Cardinal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="k">while</span> <span class="n">bytes_read</span> <span class="o">&lt;</span> <span class="n">blob_length</span><span class="p">:</span>
                                <span class="n">blob</span><span class="o">.</span><span class="n">get_segment</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">segment_size</span><span class="p">,</span> <span class="n">blob_length</span> <span class="o">-</span> <span class="n">bytes_read</span><span class="p">),</span>
                                                 <span class="n">byref</span><span class="p">(</span><span class="n">blob_value</span><span class="p">,</span> <span class="n">bytes_read</span><span class="p">),</span>
                                                 <span class="n">bytes_actually_read</span><span class="p">)</span>
                                <span class="n">bytes_read</span> <span class="o">+=</span> <span class="n">bytes_actually_read</span><span class="o">.</span><span class="n">value</span>
                            <span class="c1"># Finalize value</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">blob_value</span><span class="o">.</span><span class="n">raw</span>
                            <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">subtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">blob</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">del</span> <span class="n">blob_value</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">ARRAY</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">length</span><span class="p">]</span>
                    <span class="n">arrayid</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_QUAD</span><span class="p">((</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">val</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
                    <span class="n">arraydesc</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_ARRAY_DESC</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">isc_status</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_STATUS_ARRAY</span><span class="p">()</span>
                    <span class="n">db_handle</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">tr_handle</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">FB_API_HANDLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">relname</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">relation</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                    <span class="n">sqlname</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
                    <span class="n">api</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span>
                    <span class="n">api</span><span class="o">.</span><span class="n">fb_get_database_handle</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_att</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                                      <span class="n">isc_status</span><span class="p">,</span>
                                                      <span class="s2">&quot;Error in Cursor._unpack_output:fb_get_database_handle()&quot;</span><span class="p">)</span>
                    <span class="n">api</span><span class="o">.</span><span class="n">fb_get_transaction_handle</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">tr_handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_tra</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                                      <span class="n">isc_status</span><span class="p">,</span>
                                                      <span class="s2">&quot;Error in Cursor._unpack_output:fb_get_transaction_handle()&quot;</span><span class="p">)</span>
                    <span class="n">sqlsubtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_get_array_sqlsubtype</span><span class="p">(</span><span class="n">relname</span><span class="p">,</span> <span class="n">sqlname</span><span class="p">)</span>
                    <span class="n">api</span><span class="o">.</span><span class="n">isc_array_lookup_bounds</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">,</span> <span class="n">tr_handle</span><span class="p">,</span>
                                                <span class="n">relname</span><span class="p">,</span> <span class="n">sqlname</span><span class="p">,</span> <span class="n">arraydesc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                                      <span class="n">isc_status</span><span class="p">,</span>
                                                      <span class="s2">&quot;Error in Cursor._unpack_output:isc_array_lookup_bounds()&quot;</span><span class="p">)</span>
                    <span class="n">value_type</span> <span class="o">=</span> <span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_dtype</span>
                    <span class="n">value_scale</span> <span class="o">=</span> <span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_scale</span>
                    <span class="n">value_size</span> <span class="o">=</span> <span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_length</span>
                    <span class="k">if</span> <span class="n">value_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">blr_varying</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">blr_varying2</span><span class="p">):</span>
                        <span class="n">value_size</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">total_num_elements</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_dimensions</span><span class="p">):</span>
                        <span class="n">bounds</span> <span class="o">=</span> <span class="n">arraydesc</span><span class="o">.</span><span class="n">array_desc_bounds</span><span class="p">[</span><span class="n">dimension</span><span class="p">]</span>
                        <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bounds</span><span class="o">.</span><span class="n">array_bound_upper</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">array_bound_lower</span><span class="p">)</span>
                        <span class="n">total_num_elements</span> <span class="o">*=</span> <span class="n">dimensions</span><span class="p">[</span><span class="n">dimension</span><span class="p">]</span>
                    <span class="n">total_size</span> <span class="o">=</span> <span class="n">total_num_elements</span> <span class="o">*</span> <span class="n">value_size</span>
                    <span class="n">value_buffer</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span>
                    <span class="n">tsize</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ISC_LONG</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span>
                    <span class="n">api</span><span class="o">.</span><span class="n">isc_array_get_slice</span><span class="p">(</span><span class="n">isc_status</span><span class="p">,</span> <span class="n">db_handle</span><span class="p">,</span> <span class="n">tr_handle</span><span class="p">,</span>
                                            <span class="n">arrayid</span><span class="p">,</span> <span class="n">arraydesc</span><span class="p">,</span>
                                            <span class="n">value_buffer</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">db_api_error</span><span class="p">(</span><span class="n">isc_status</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">raise</span> <span class="n">a</span><span class="o">.</span><span class="n">exception_from_status</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span>
                                                      <span class="n">isc_status</span><span class="p">,</span>
                                                      <span class="s2">&quot;Error in Cursor._unpack_output:isc_array_get_slice()&quot;</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_db_array_to_list</span><span class="p">(</span><span class="n">value_size</span><span class="p">,</span>
                                                                     <span class="n">value_type</span><span class="p">,</span>
                                                                     <span class="n">sqlsubtype</span><span class="p">,</span>
                                                                     <span class="n">value_scale</span><span class="p">,</span>
                                                                     <span class="mi">0</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span>
                                                                     <span class="n">value_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_fetchone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">==</span> <span class="n">StateResult</span><span class="o">.</span><span class="n">NO_DATA</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__output_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__output_cache</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="n">StateResult</span><span class="o">.</span><span class="n">NO_DATA</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__output_cache</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">fetch_next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">==</span> <span class="n">StateResult</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_output</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Cannot fetch from cursor that did not executed a statement.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Statement</span><span class="p">],</span>
                 <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">CursorFlag</span><span class="o">=</span><span class="n">CursorFlag</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">Statement</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">operation</span><span class="o">.</span><span class="n">_connection</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s1">&#39;Cannot execute Statement that was created by different Connection.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span> <span class="o">=</span> <span class="n">operation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__internal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">sql</span> <span class="o">==</span> <span class="n">operation</span><span class="p">:</span>
            <span class="c1"># We should execute the same SQL string again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_prepare</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__internal</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_flags</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="n">in_meta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Execute the statement</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_in_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">in_meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_in_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pack_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_in_meta</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_in_buffer</span><span class="p">,</span>
                                                                  <span class="n">parameters</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">has_cursor</span><span class="p">():</span>
                <span class="c1"># Statement returns multiple rows</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_istmt</span><span class="o">.</span><span class="n">open_cursor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_tra</span><span class="p">,</span>
                                                            <span class="n">in_meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_in_buffer</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_meta</span><span class="p">,</span>
                                                            <span class="n">flags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Statement may return single row</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_istmt</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_tra</span><span class="p">,</span> <span class="n">in_meta</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_in_buffer</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__output_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_output</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">in_meta</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blob_readers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__blob_readers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<div class="viewcode-block" id="Cursor.callproc"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.callproc">[docs]</a>    <span class="k">def</span> <span class="nf">callproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Executes a stored procedure with the given name.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            proc_name: Stored procedure name.</span>
<span class="sd">            parameters: Sequence of parameters. Must contain one entry for each argument</span>
<span class="sd">                        that the procedure expects.</span>

<span class="sd">        .. note::</span>

<span class="sd">           If stored procedure does have output parameters, you must retrieve their values</span>
<span class="sd">           saparatelly by `.Cursor.fetchone()` call. This method is not very convenient,</span>
<span class="sd">           but conforms to Python DB API 2.0. If you don&#39;t require conformance to Python</span>
<span class="sd">           DB API, it&#39;s recommended to use more convenient method `.Cursor.call_procedure()`</span>
<span class="sd">           instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">parameters</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;EXECUTE PROCEDURE &#39;</span> <span class="o">+</span> <span class="n">proc_name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
               <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;?&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>
<div class="viewcode-block" id="Cursor.call_procedure"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.call_procedure">[docs]</a>    <span class="k">def</span> <span class="nf">call_procedure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Executes a stored procedure with the given name.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            proc_name: Stored procedure name.</span>
<span class="sd">            parameters: Sequence of parameters. Must contain one entry for each argument</span>
<span class="sd">                        that the procedure expects.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None or tuple with values returned by stored procedure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callproc</span><span class="p">(</span><span class="n">proc_name</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Cursor.set_cursor_name"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.set_cursor_name">[docs]</a>    <span class="k">def</span> <span class="nf">set_cursor_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sets name for the SQL cursor.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: Cursor name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Cannot set name for cursor has not yet &quot;</span>
                                 <span class="s2">&quot;executed a statement&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Cursor&#39;s name has already been declared in&quot;</span>
                                 <span class="s2">&quot; context of currently executed statement&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_istmt</span><span class="o">.</span><span class="n">set_cursor_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span></div>
<div class="viewcode-block" id="Cursor.prepare"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Statement</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates prepared statement for repeated execution.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            operation: SQL command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_prepare</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">)</span></div>
<div class="viewcode-block" id="Cursor.open"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Statement</span><span class="p">],</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Executes SQL command or prepared `Statement` as scrollable.</span>

<span class="sd">        Starts new transaction if transaction manager associated with cursor is not active.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            operation: SQL command or prepared `Statement`.</span>
<span class="sd">            parameters: Sequence of parameters. Must contain one entry for each argument</span>
<span class="sd">                        that the operation expects.</span>

<span class="sd">        Note:</span>
<span class="sd">            If `operation` is a string with SQL command that is exactly the same as the</span>
<span class="sd">            last executed command, the internally prepared `Statement` from last execution</span>
<span class="sd">            is reused.</span>

<span class="sd">            If cursor is open, it&#39;s closed before new statement is executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">CursorFlag</span><span class="o">.</span><span class="n">SCROLLABLE</span><span class="p">)</span></div>
<div class="viewcode-block" id="Cursor.execute"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Statement</span><span class="p">],</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Executes SQL command or prepared `Statement`.</span>

<span class="sd">        Starts new transaction if transaction manager associated with cursor is not active.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            operation: SQL command or prepared `Statement`.</span>
<span class="sd">            parameters: Sequence of parameters. Must contain one entry for each argument</span>
<span class="sd">                        that the operation expects.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `self` so call to execute could be used as iterator over returned rows.</span>

<span class="sd">        Note:</span>
<span class="sd">            If `operation` is a string with SQL command that is exactly the same as the</span>
<span class="sd">            last executed command, the internally prepared `Statement` from last execution</span>
<span class="sd">            is reused.</span>

<span class="sd">            If cursor is open, it&#39;s closed before new statement is executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="Cursor.executemany"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.executemany">[docs]</a>    <span class="k">def</span> <span class="nf">executemany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Statement</span><span class="p">],</span>
                    <span class="n">seq_of_parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Executes SQL command or prepared statement against all parameter</span>
<span class="sd">        sequences found in the sequence `seq_of_parameters`.</span>

<span class="sd">        Starts new transaction if transaction manager associated with cursor is not active.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            operation: SQL command or prepared `Statement`.</span>
<span class="sd">            seq_of_parameters: Sequence of sequences of parameters. Must contain</span>
<span class="sd">                               one sequence of parameters for each execution</span>
<span class="sd">                               that has one entry for each argument that the</span>
<span class="sd">                               operation expects.</span>

<span class="sd">        Note:</span>
<span class="sd">            This function simply calls `.execute` in a loop, feeding it with</span>
<span class="sd">            parameters from `seq_of_parameters`. Because `.execute` reuses the statement,</span>
<span class="sd">            calling `executemany` is equally efective as direct use of prepared `Statement`</span>
<span class="sd">            and calling `execute` in a loop directly in application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">seq_of_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></div>
<div class="viewcode-block" id="Cursor.close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close the cursor and release all associated resources.</span>

<span class="sd">        The result set (if any) from last executed statement is released, and if executed</span>
<span class="sd">        `Statement` was not supplied externally, it&#39;s released as well.</span>

<span class="sd">        Note:</span>
<span class="sd">            The closed cursor could be used to execute further SQL commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__internal</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Cursor.fetchone"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.fetchone">[docs]</a>    <span class="k">def</span> <span class="nf">fetchone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the next row of a query result set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchone</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Cannot fetch from cursor that did not executed a statement.&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="Cursor.fetchmany"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.fetchmany">[docs]</a>    <span class="k">def</span> <span class="nf">fetchmany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the next set of rows of a query result, returning a sequence of</span>
<span class="sd">        sequences (e.g. a list of tuples).</span>

<span class="sd">        An empty sequence is returned when no more rows are available. The number of rows</span>
<span class="sd">        to fetch per call is specified by the parameter. If it is not given, the cursor’s</span>
<span class="sd">        `.arraysize` determines the number of rows to be fetched. The method does try to</span>
<span class="sd">        fetch as many rows as indicated by the size parameter. If this is not possible due</span>
<span class="sd">        to the specified number of rows not being available, fewer rows may be returned.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            size: The number of rows to fetch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arraysize</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">result</span></div>
<div class="viewcode-block" id="Cursor.fetchall"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.fetchall">[docs]</a>    <span class="k">def</span> <span class="nf">fetchall</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch all remaining rows of a query result set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="Cursor.fetch_next"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.fetch_next">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the next row of a scrollable query result set.</span>

<span class="sd">        Returns None if there is no row to be fetched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">fetch_next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">==</span> <span class="n">StateResult</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_output</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Cursor.fetch_prior"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.fetch_prior">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the previous row of a scrollable query result set.</span>

<span class="sd">        Returns None if there is no row to be fetched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">fetch_prior</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">==</span> <span class="n">StateResult</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_output</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Cursor.fetch_first"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.fetch_first">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_first</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the first row of a scrollable query result set.</span>

<span class="sd">        Returns None if there is no row to be fetched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">fetch_first</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">==</span> <span class="n">StateResult</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_output</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Cursor.fetch_last"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.fetch_last">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_last</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the last row of a scrollable query result set.</span>

<span class="sd">        Returns None if there is no row to be fetched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">fetch_last</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">==</span> <span class="n">StateResult</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_output</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Cursor.fetch_absolute"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.fetch_absolute">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the row of a scrollable query result set specified by absolute position.</span>

<span class="sd">        Returns None if there is no row to be fetched.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            position: Absolute position number of row in result set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">fetch_absolute</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">==</span> <span class="n">StateResult</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_output</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Cursor.fetch_relative"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.fetch_relative">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the row of a scrollable query result set specified by relative position.</span>

<span class="sd">        Returns None if there is no row to be fetched.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            offset: Relative position number of row in result set. Negative value refers</span>
<span class="sd">                    to previous row, positive to next row.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">fetch_relative</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_status</span> <span class="o">==</span> <span class="n">StateResult</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_output</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Cursor.setinputsizes"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.setinputsizes">[docs]</a>    <span class="k">def</span> <span class="nf">setinputsizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Type</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Required by Python DB API 2.0, but pointless for Firebird, so it does nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="Cursor.setoutputsize"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.setoutputsize">[docs]</a>    <span class="k">def</span> <span class="nf">setoutputsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Required by Python DB API 2.0, but pointless for Firebird, so it does nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="Cursor.is_closed"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.is_closed">[docs]</a>    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if cursor is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span> <span class="ow">is</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Cursor.is_eof"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.is_eof">[docs]</a>    <span class="k">def</span> <span class="nf">is_eof</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True is scrollable cursor is positioned at the end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">is_eof</span><span class="p">()</span></div>
<div class="viewcode-block" id="Cursor.is_bof"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.is_bof">[docs]</a>    <span class="k">def</span> <span class="nf">is_bof</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True is scrollable cursor is positioned at the beginning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">is_bof</span><span class="p">()</span></div>
<div class="viewcode-block" id="Cursor.to_dict"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Cursor.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">into</span><span class="p">:</span> <span class="n">Dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns row tuple as dictionary with field names as keys. Returns new dictionary</span>
<span class="sd">        if `into` argument is not provided, otherwise returns `into` dictionary updated</span>
<span class="sd">        with row data.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            row:  Row data returned by fetch_* method.</span>
<span class="sd">            into: Dictionary that shouold be updated with row data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="s2">&quot;Length of data must match number of fields&quot;</span>
        <span class="k">if</span> <span class="n">into</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">into</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_names</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">into</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_names</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">into</span></div>
    <span class="c1"># Properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Connection associated with cursor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="s2">&quot;Logging context [Connection&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">statement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Statement</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Executed `Statement` or None if cursor does not executed a statement yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DESCRIPTION</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Tuple of DESCRIPTION tuples (with 7-items).</span>

<span class="sd">        Each of these tuples contains information describing one result column:</span>
<span class="sd">        (name, type_code, display_size, internal_size, precision, scale, null_ok)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_desc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_out_desc</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">scale</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">VARYING</span><span class="p">):</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="nb">str</span>
                    <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">subtype</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">69</span><span class="p">):</span>  <span class="c1"># UTF8 and GB18030</span>
                        <span class="n">dispsize</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">length</span> <span class="o">//</span> <span class="mi">4</span>
                    <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">subtype</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># UNICODE_FSS</span>
                        <span class="n">dispsize</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">length</span> <span class="o">//</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dispsize</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">length</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">SHORT</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">LONG</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">)</span>
                      <span class="ow">and</span> <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">subtype</span> <span class="ow">or</span> <span class="n">meta</span><span class="o">.</span><span class="n">scale</span><span class="p">)):</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span>
                    <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_determine_field_precision</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">20</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">SHORT</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="nb">int</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">6</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">LONG</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="nb">int</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">11</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="nb">int</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">20</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SQLDataType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">D_FLOAT</span><span class="p">,</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">):</span>
                    <span class="c1"># Special case, dialect 1 DOUBLE/FLOAT</span>
                    <span class="c1"># could be Fixed point</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_dialect</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">meta</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
                        <span class="n">vtype</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span>
                        <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_determine_field_precision</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vtype</span> <span class="o">=</span> <span class="nb">float</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">17</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">BLOB</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="nb">str</span> <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">subtype</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">bytes</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">subtype</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">22</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">DATE</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">TIME</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">11</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">ARRAY</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="nb">list</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">SQLDataType</span><span class="o">.</span><span class="n">BOOLEAN</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="nb">bool</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">dispsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">meta</span><span class="o">.</span><span class="n">field</span> <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="n">meta</span><span class="o">.</span><span class="n">alias</span> <span class="k">else</span> <span class="n">meta</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
                                  <span class="n">vtype</span><span class="p">,</span> <span class="n">dispsize</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span>
                                  <span class="n">scale</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">nullable</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_desc</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_desc</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">affected_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Specifies the number of rows that the last `.execute` or `.open`</span>
<span class="sd">        produced (for DQL statements like select) or affected (for DML statements</span>
<span class="sd">        like update or insert ).</span>

<span class="sd">        The attribute is -1 in case no statement was executed on the cursor</span>
<span class="sd">        or the rowcount of the last operation is not determinable by the interface.</span>

<span class="sd">        Note:</span>
<span class="sd">            The database engine&#39;s own support for the determination of</span>
<span class="sd">            “rows affected”/”rows selected” is quirky. The database engine only</span>
<span class="sd">            supports the determination of rowcount for INSERT, UPDATE, DELETE,</span>
<span class="sd">            and SELECT statements. When stored procedures become involved, row</span>
<span class="sd">            count figures are usually not available to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_executed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">StatementType</span><span class="o">.</span><span class="n">SELECT</span><span class="p">,</span>
                                                   <span class="n">StatementType</span><span class="o">.</span><span class="n">INSERT</span><span class="p">,</span>
                                                   <span class="n">StatementType</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span>
                                                   <span class="n">StatementType</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">_istmt</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">23</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">info</span><span class="p">)</span> <span class="c1"># bytes(isc_info_sql_records, isc_info_end)</span>
            <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">23</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Cursor.affected_rows:</span><span class="se">\n</span><span class="s2">&quot;</span>
                                     <span class="s2">&quot;first byte must be &#39;isc_info_sql_records&#39;&quot;</span><span class="p">)</span>
            <span class="n">res_walk</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">while</span> <span class="nb">ord</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">res_walk</span><span class="p">])</span> <span class="o">!=</span> <span class="n">isc_info_end</span><span class="p">:</span>
                <span class="n">cur_count_type</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">res_walk</span><span class="p">])</span>
                <span class="n">res_walk</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">res_walk</span><span class="p">:</span><span class="n">res_walk</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
                <span class="n">res_walk</span> <span class="o">+=</span> <span class="mi">2</span>
                <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">res_walk</span><span class="p">:</span><span class="n">res_walk</span> <span class="o">+</span> <span class="n">size</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
                <span class="c1"># pylint: disable=R0916</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">cur_count_type</span> <span class="o">==</span> <span class="mi">13</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">StatementType</span><span class="o">.</span><span class="n">SELECT</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="n">cur_count_type</span> <span class="o">==</span> <span class="mi">14</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">StatementType</span><span class="o">.</span><span class="n">INSERT</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="n">cur_count_type</span> <span class="o">==</span> <span class="mi">15</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">StatementType</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="n">cur_count_type</span> <span class="o">==</span> <span class="mi">16</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmt</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">StatementType</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">count</span>
                <span class="n">res_walk</span> <span class="o">+=</span> <span class="n">size</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="n">rowcount</span> <span class="o">=</span> <span class="n">affected_rows</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionManager</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Transaction manager associated with cursor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Name set for cursor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span></div>

<div class="viewcode-block" id="ServerInfoProvider"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerInfoProvider">[docs]</a><span class="k">class</span> <span class="nc">ServerInfoProvider</span><span class="p">(</span><span class="n">InfoProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides access to information about attached server.</span>

<span class="sd">    Important:</span>
<span class="sd">       Do NOT create instances of this class directly! Use `Server.info` property to access</span>
<span class="sd">       the instance already bound to connectected server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="n">Server</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">:</span> <span class="n">Server</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="c1"># Get Firebird engine version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__version</span> <span class="o">=</span> <span class="n">_engine_version_provider</span><span class="o">.</span><span class="n">get_server_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__engine_version</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ServerInfoProvider._close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerInfoProvider._close">[docs]</a>    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Drops the association with attached server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="ServerInfoProvider._acquire"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerInfoProvider._acquire">[docs]</a>    <span class="k">def</span> <span class="nf">_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Acquires information from associated attachment. Information is stored in native</span>
<span class="sd">        format in `response` buffer.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            request: Data specifying the required information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span></div>
<div class="viewcode-block" id="ServerInfoProvider.get_info"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerInfoProvider.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info_code</span><span class="p">:</span> <span class="n">SrvInfoCode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns requested information from connected server.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            info_code: A code specifying the required information.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The data type of returned value depends on information required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">info_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">info_code</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">info_code</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">info_code</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;An error response was received&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">isc_info_error</span>
                                     <span class="k">else</span> <span class="s2">&quot;Result code does not match request code&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">info_code</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">VERSION</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">CAPABILITIES</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_int</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">info_code</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">SERVER_VERSION</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">IMPLEMENTATION</span><span class="p">,</span>
                           <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">GET_ENV</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">GET_ENV_MSG</span><span class="p">,</span>
                           <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">GET_ENV_LOCK</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">USER_DBPATH</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">info_code</span> <span class="o">==</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">SRV_DB_INFO</span><span class="p">:</span>
            <span class="n">num_attachments</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">databases</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvDbInfoOption</span><span class="o">.</span><span class="n">ATT</span><span class="p">:</span>
                    <span class="n">num_attachments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">:</span>
                    <span class="n">databases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvDbInfoOption</span><span class="o">.</span><span class="n">DB</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_short</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_attachments</span><span class="p">,</span> <span class="n">databases</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span> <span class="o">!=</span> <span class="n">isc_info_end</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Malformed result buffer (missing isc_info_end item)&quot;</span><span class="p">)</span>
        <span class="c1"># cache</span>
        <span class="k">if</span> <span class="n">info_code</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">SERVER_VERSION</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">VERSION</span><span class="p">,</span>
                         <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">IMPLEMENTATION</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">GET_ENV</span><span class="p">,</span>
                         <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">USER_DBPATH</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">GET_ENV_LOCK</span><span class="p">,</span>
                         <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">GET_ENV_MSG</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">CAPABILITIES</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">info_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span></div>
<div class="viewcode-block" id="ServerInfoProvider.get_log"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerInfoProvider.get_log">[docs]</a>    <span class="k">def</span> <span class="nf">get_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">CB_OUTPUT_LINE</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Request content of Firebird Server log. **(ASYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            callback: Function to call back with each output line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">GET_FB_LOG</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Firebird version as SEMVER string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__version</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">engine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Firebird version as &lt;major&gt;.&lt;minor&gt; float number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__engine_version</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">manager_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Service manager version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Server implementation description.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">IMPLEMENTATION</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">home_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Server home directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">GET_ENV</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">security_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Path to security database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">USER_DBPATH</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lock_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Directory with lock file(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">GET_ENV_LOCK</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">message_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Directory with message file(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">GET_ENV_MSG</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ServerCapability</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Server capabilities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ServerCapability</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">CAPABILITIES</span><span class="p">))</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of database attachments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">SRV_DB_INFO</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attached_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List of attached databases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">SRV_DB_INFO</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="ServerServiceProvider"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerServiceProvider">[docs]</a><span class="k">class</span> <span class="nc">ServerServiceProvider</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for server service providers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="n">Server</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">:</span> <span class="n">Server</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ServerDbServices3"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3">[docs]</a><span class="k">class</span> <span class="nc">ServerDbServices3</span><span class="p">(</span><span class="n">ServerServiceProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Database-related actions and services [Firebird 3+].</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ServerDbServices3.get_statistics"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.get_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span>
                       <span class="n">flags</span><span class="p">:</span> <span class="n">SrvStatFlag</span><span class="o">=</span><span class="n">SrvStatFlag</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">tables</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">CB_OUTPUT_LINE</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return database statistics produced by gstat utility. **(ASYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            flags: Flags indicating which statistics shall be collected.</span>
<span class="sd">            role: SQL ROLE name passed to gstat.</span>
<span class="sd">            tables: List of database tables whose statistics are to be collected.</span>
<span class="sd">            callback: Function to call back with each output line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">DB_STATS</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                    <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span> <span class="c1"># isc_spb_sts_table = 64</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>
<div class="viewcode-block" id="ServerDbServices3.backup"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.backup">[docs]</a>    <span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">backup</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FILESPEC</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">FILESPEC</span><span class="p">]],</span>
               <span class="n">backup_file_sizes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">(),</span>
               <span class="n">flags</span><span class="p">:</span> <span class="n">SrvBackupFlag</span><span class="o">=</span><span class="n">SrvBackupFlag</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">callback</span><span class="p">:</span> <span class="n">CB_OUTPUT_LINE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stats</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbint</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_data</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">include_data</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keyhoder</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keyname</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">crypt</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Request logical (GBAK) database backup. **(ASYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database file specification or alias.</span>
<span class="sd">            backup: Backup filespec, or list of backup file specifications.</span>
<span class="sd">            backup_file_sizes: List of file sizes for backup files.</span>
<span class="sd">            flags: Backup options.</span>
<span class="sd">            role: SQL ROLE name passed to gbak.</span>
<span class="sd">            callback: Function to call back with each output line.</span>
<span class="sd">            stats: Backup statistic options (TDWR).</span>
<span class="sd">            verbose: Whether output should be verbose or not.</span>
<span class="sd">            verbint: Verbose information with explicit interval (number of records)</span>
<span class="sd">            skip_data: String with table names whose data should be excluded from backup.</span>
<span class="sd">            include_data: String with table names whose data should be included into backup [Firebird 4].</span>
<span class="sd">            keyholder: Keyholder name [Firebird 4]</span>
<span class="sd">            keyname: Key name [Firebird 4]</span>
<span class="sd">            crypt: Encryption specification [Firebird 4]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backup</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="n">backup</span> <span class="o">=</span> <span class="p">[</span><span class="n">backup</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">backup_file_sizes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">backup</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">backup</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">backup_file_sizes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">BACKUP</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">backup</span><span class="p">,</span> <span class="n">backup_file_sizes</span><span class="p">):</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">FILE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">LENGTH</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skip_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">SKIP_DATA</span><span class="p">,</span> <span class="n">skip_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">INCLUDE_DATA</span><span class="p">,</span> <span class="n">include_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyhoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">KEYHOLDER</span><span class="p">,</span> <span class="n">keyhoder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">KEYNAME</span><span class="p">,</span> <span class="n">keyname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crypt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">CRYPT</span><span class="p">,</span> <span class="n">crypt</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">VERBINT</span><span class="p">,</span> <span class="n">verbint</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">STAT</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>
<div class="viewcode-block" id="ServerDbServices3.restore"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">backup</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FILESPEC</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">FILESPEC</span><span class="p">]],</span>
                <span class="n">database</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FILESPEC</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">FILESPEC</span><span class="p">]],</span>
                <span class="n">db_file_pages</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">(),</span>
                <span class="n">flags</span><span class="p">:</span> <span class="n">SrvRestoreFlag</span><span class="o">=</span><span class="n">SrvRestoreFlag</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">callback</span><span class="p">:</span> <span class="n">CB_OUTPUT_LINE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stats</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbint</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_data</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">page_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffers</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">access_mode</span><span class="p">:</span> <span class="n">DbAccessMode</span><span class="o">=</span><span class="n">DbAccessMode</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">,</span> <span class="n">include_data</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">keyhoder</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keyname</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crypt</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">replica_mode</span><span class="p">:</span> <span class="n">ReplicaMode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Request database restore from logical (GBAK) backup. **(ASYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            backup: Backup filespec, or list of backup file specifications.</span>
<span class="sd">            database: Database specification or alias, or list of those.</span>
<span class="sd">            db_file_pages: List of database file sizes (in pages).</span>
<span class="sd">            flags: Restore options.</span>
<span class="sd">            role: SQL ROLE name passed to gbak.</span>
<span class="sd">            callback: Function to call back with each output line.</span>
<span class="sd">            stats: Restore statistic options (TDWR).</span>
<span class="sd">            verbose: Whether output should be verbose or not.</span>
<span class="sd">            verbint: Verbose information with explicit interval (number of records)</span>
<span class="sd">            skip_data: String with table names whose data should be excluded from restore.</span>
<span class="sd">            page_size: Page size for restored database.</span>
<span class="sd">            buffers: Cache size for restored database.</span>
<span class="sd">            access_mode: Restored database access mode (R/W or R/O).</span>
<span class="sd">            include_data: String with table names whose data should be included into backup [Firebird 4].</span>
<span class="sd">            keyholder: Keyholder name [Firebird 4]</span>
<span class="sd">            keyname: Key name [Firebird 4]</span>
<span class="sd">            crypt: Encryption specification [Firebird 4]</span>
<span class="sd">            replica_mode: Replica mode for restored database [Firebird 4]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backup</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="n">backup</span> <span class="o">=</span> <span class="p">[</span><span class="n">backup</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="n">database</span> <span class="o">=</span> <span class="p">[</span><span class="n">database</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">db_file_pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">database</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">database</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">db_file_pages</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">RESTORE</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">backup</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">FILE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">db_file_pages</span><span class="p">):</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">LENGTH</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">page_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">buffers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">BUFFERS</span><span class="p">,</span> <span class="n">buffers</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_bytes</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">ACCESS_MODE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">access_mode</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">skip_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">SKIP_DATA</span><span class="p">,</span> <span class="n">skip_data</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">INCLUDE_DATA</span><span class="p">,</span> <span class="n">include_data</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyhoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">KEYHOLDER</span><span class="p">,</span> <span class="n">keyhoder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">KEYNAME</span><span class="p">,</span> <span class="n">keyname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crypt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">CRYPT</span><span class="p">,</span> <span class="n">crypt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">replica_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">REPLICA_MODE</span><span class="p">,</span> <span class="n">replica_mode</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">VERBINT</span><span class="p">,</span> <span class="n">verbint</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">STAT</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>
<div class="viewcode-block" id="ServerDbServices3.local_backup"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.local_backup">[docs]</a>    <span class="k">def</span> <span class="nf">local_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">backup_stream</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span>
                     <span class="n">flags</span><span class="p">:</span> <span class="n">SrvBackupFlag</span><span class="o">=</span><span class="n">SrvBackupFlag</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">skip_data</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_data</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keyhoder</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">keyname</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crypt</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Request logical (GBAK) database backup into local byte stream. **(SYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            backup_stream: Binary stream to which the backup is to be written.</span>
<span class="sd">            flags: Backup options.</span>
<span class="sd">            role: SQL ROLE name passed to gbak.</span>
<span class="sd">            skip_data: String with table names whose data should be excluded from backup.</span>
<span class="sd">            include_data: String with table names whose data should be included into backup [Firebird 4].</span>
<span class="sd">            keyholder: Keyholder name [Firebird 4]</span>
<span class="sd">            keyname: Key name [Firebird 4]</span>
<span class="sd">            crypt: Encryption specification [Firebird 4]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">BACKUP</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">FILE</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skip_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">SKIP_DATA</span><span class="p">,</span> <span class="n">skip_data</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">INCLUDE_DATA</span><span class="p">,</span> <span class="n">include_data</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyhoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">KEYHOLDER</span><span class="p">,</span> <span class="n">keyhoder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">KEYNAME</span><span class="p">,</span> <span class="n">keyname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crypt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvBackupOption</span><span class="o">.</span><span class="n">CRYPT</span><span class="p">,</span> <span class="n">crypt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_eof</span><span class="p">:</span>
            <span class="n">backup_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_read_next_binary_output</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.local_restore"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.local_restore">[docs]</a>    <span class="k">def</span> <span class="nf">local_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">backup_stream</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span>
                      <span class="n">database</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FILESPEC</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">FILESPEC</span><span class="p">]],</span>
                      <span class="n">db_file_pages</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">(),</span>
                      <span class="n">flags</span><span class="p">:</span> <span class="n">SrvRestoreFlag</span><span class="o">=</span><span class="n">SrvRestoreFlag</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">skip_data</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">page_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffers</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">access_mode</span><span class="p">:</span> <span class="n">DbAccessMode</span><span class="o">=</span><span class="n">DbAccessMode</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">,</span>
                      <span class="n">include_data</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keyhoder</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keyname</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">crypt</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replica_mode</span><span class="p">:</span> <span class="n">ReplicaMode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Request database restore from logical (GBAK) backup stored in local byte stream.</span>
<span class="sd">        **(SYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            backup_stream: Binary stream with the backup.</span>
<span class="sd">            database: Database specification or alias, or list of those.</span>
<span class="sd">            db_file_pages: List of database file sizes (in pages).</span>
<span class="sd">            flags: Restore options.</span>
<span class="sd">            role: SQL ROLE name passed to gbak.</span>
<span class="sd">            skip_data: String with table names whose data should be excluded from restore.</span>
<span class="sd">            page_size: Page size for restored database.</span>
<span class="sd">            buffers: Cache size for restored database.</span>
<span class="sd">            access_mode: Restored database access mode (R/W or R/O).</span>
<span class="sd">            include_data: String with table names whose data should be included into backup [Firebird 4].</span>
<span class="sd">            keyholder: Keyholder name [Firebird 4]</span>
<span class="sd">            keyname: Key name [Firebird 4]</span>
<span class="sd">            crypt: Encryption specification [Firebird 4]</span>
<span class="sd">            replica_mode: Replica mode for restored database [Firebird 4]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="n">database</span> <span class="o">=</span> <span class="p">[</span><span class="n">database</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">db_file_pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">database</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">database</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">db_file_pages</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">RESTORE</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">FILE</span><span class="p">,</span> <span class="s1">&#39;stdin&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">db_file_pages</span><span class="p">):</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">LENGTH</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">page_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">buffers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">BUFFERS</span><span class="p">,</span> <span class="n">buffers</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_bytes</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">ACCESS_MODE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">access_mode</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">skip_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">SKIP_DATA</span><span class="p">,</span> <span class="n">skip_data</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">INCLUDE_DATA</span><span class="p">,</span> <span class="n">include_data</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyhoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">KEYHOLDER</span><span class="p">,</span> <span class="n">keyhoder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">KEYNAME</span><span class="p">,</span> <span class="n">keyname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crypt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">CRYPT</span><span class="p">,</span> <span class="n">crypt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">replica_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRestoreOption</span><span class="o">.</span><span class="n">REPLICA_MODE</span><span class="p">,</span> <span class="n">replica_mode</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="c1">#</span>
        <span class="n">request_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">keep_going</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">keep_going</span><span class="p">:</span>
            <span class="n">no_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">request_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">request_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">request_length</span><span class="p">,</span> <span class="mi">65500</span><span class="p">])</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">backup_stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">request_length</span><span class="p">)</span>
                <span class="n">send</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">LINE</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">),</span>
                                 <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">),</span> <span class="n">raw</span><span class="p">,</span>
                                 <span class="n">isc_info_end</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">send</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">STDIN</span><span class="p">,</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">LINE</span><span class="p">]),</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">isc_info_end</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">STDIN</span><span class="p">:</span>
                    <span class="n">request_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_int</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">LINE</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">isc_info_data_not_ready</span><span class="p">:</span>
                    <span class="n">no_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Service responded with error code: </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
            <span class="n">keep_going</span> <span class="o">=</span> <span class="n">no_data</span> <span class="ow">or</span> <span class="n">request_length</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">line</span></div>
<div class="viewcode-block" id="ServerDbServices3.nbackup"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.nbackup">[docs]</a>    <span class="k">def</span> <span class="nf">nbackup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">backup</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">direct</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">SrvNBackupFlag</span><span class="o">=</span><span class="n">SrvNBackupFlag</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
                <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">guid</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform physical (NBACKUP) database backup. **(SYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            backup: Backup file specification.</span>
<span class="sd">            level: Backup level.</span>
<span class="sd">            direct: Direct I/O override.</span>
<span class="sd">            flags: Backup options.</span>
<span class="sd">            role: SQL ROLE name passed to nbackup.</span>
<span class="sd">            guid: Database backup GUID.</span>

<span class="sd">        Important:</span>
<span class="sd">            Parameters `level` and `guid` are mutually exclusive. If `guid` is specified,</span>
<span class="sd">            then `level` value is ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">NBAK</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvNBackupOption</span><span class="o">.</span><span class="n">FILE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">backup</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">guid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvNBackupOption</span><span class="o">.</span><span class="n">GUID</span><span class="p">,</span> <span class="n">guid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvNBackupOption</span><span class="o">.</span><span class="n">LEVEL</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">direct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvNBackupOption</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">,</span> <span class="s1">&#39;ON&#39;</span> <span class="k">if</span> <span class="n">direct</span> <span class="k">else</span> <span class="s1">&#39;OFF&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
<div class="viewcode-block" id="ServerDbServices3.nrestore"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.nrestore">[docs]</a>    <span class="k">def</span> <span class="nf">nrestore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">backups</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">FILESPEC</span><span class="p">],</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span>
                 <span class="n">direct</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">SrvNBackupFlag</span><span class="o">=</span><span class="n">SrvNBackupFlag</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
                 <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform restore from physical (NBACKUP) database backup.  **(SYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            backups: Backup file(s) specification.</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            direct: Direct I/O override.</span>
<span class="sd">            flags: Restore options.</span>
<span class="sd">            role: SQL ROLE name passed to nbackup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">NREST</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">backup</span> <span class="ow">in</span> <span class="n">backups</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvNBackupOption</span><span class="o">.</span><span class="n">FILE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">backup</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">direct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvNBackupOption</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">,</span> <span class="s1">&#39;ON&#39;</span> <span class="k">if</span> <span class="n">direct</span> <span class="k">else</span> <span class="s1">&#39;OFF&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
<div class="viewcode-block" id="ServerDbServices3.set_default_cache_size"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.set_default_cache_size">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_cache_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set individual page cache size for database.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            size: New value.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvPropertiesOption</span><span class="o">.</span><span class="n">PAGE_BUFFERS</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.set_sweep_interval"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.set_sweep_interval">[docs]</a>    <span class="k">def</span> <span class="nf">set_sweep_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set database sweep interval.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            interval: New value.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvPropertiesOption</span><span class="o">.</span><span class="n">SWEEP_INTERVAL</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.set_space_reservation"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.set_space_reservation">[docs]</a>    <span class="k">def</span> <span class="nf">set_space_reservation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">DbSpaceReservation</span><span class="p">,</span>
                              <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set space reservation for database.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            mode: New value.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_bytes</span><span class="p">(</span><span class="n">SrvPropertiesOption</span><span class="o">.</span><span class="n">RESERVE_SPACE</span><span class="p">,</span>
                             <span class="nb">bytes</span><span class="p">([</span><span class="n">mode</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.set_write_mode"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.set_write_mode">[docs]</a>    <span class="k">def</span> <span class="nf">set_write_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">DbWriteMode</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set database write mode (SYNC/ASYNC).</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            mode: New value.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_bytes</span><span class="p">(</span><span class="n">SrvPropertiesOption</span><span class="o">.</span><span class="n">WRITE_MODE</span><span class="p">,</span>
                             <span class="nb">bytes</span><span class="p">([</span><span class="n">mode</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.set_access_mode"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.set_access_mode">[docs]</a>    <span class="k">def</span> <span class="nf">set_access_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">DbAccessMode</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set database access mode (R/W or R/O).</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            mode: New value.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_bytes</span><span class="p">(</span><span class="n">SrvPropertiesOption</span><span class="o">.</span><span class="n">ACCESS_MODE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">mode</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.set_sql_dialect"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.set_sql_dialect">[docs]</a>    <span class="k">def</span> <span class="nf">set_sql_dialect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">dialect</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set database SQL dialect.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            dialect: New value.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvPropertiesOption</span><span class="o">.</span><span class="n">SET_SQL_DIALECT</span><span class="p">,</span> <span class="n">dialect</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.activate_shadow"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.activate_shadow">[docs]</a>    <span class="k">def</span> <span class="nf">activate_shadow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Activate database shadow.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">SrvPropertiesFlag</span><span class="o">.</span><span class="n">ACTIVATE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.no_linger"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.no_linger">[docs]</a>    <span class="k">def</span> <span class="nf">no_linger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set one-off override for database linger.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">SrvPropertiesFlag</span><span class="o">.</span><span class="n">NOLINGER</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.shutdown"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">ShutdownMode</span><span class="p">,</span>
                 <span class="n">method</span><span class="p">:</span> <span class="n">ShutdownMethod</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database shutdown.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            mode: Shutdown mode.</span>
<span class="sd">            method: Shutdown method.</span>
<span class="sd">            timeout: Timeout for shutdown.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_bytes</span><span class="p">(</span><span class="n">SrvPropertiesOption</span><span class="o">.</span><span class="n">SHUTDOWN_MODE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">mode</span><span class="p">]))</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.bring_online"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.bring_online">[docs]</a>    <span class="k">def</span> <span class="nf">bring_online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">OnlineMode</span><span class="o">=</span><span class="n">OnlineMode</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span>
                     <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Bring previously shut down database back online.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            mode: Online mode.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_bytes</span><span class="p">(</span><span class="n">SrvPropertiesOption</span><span class="o">.</span><span class="n">ONLINE_MODE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">mode</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span></div>
<div class="viewcode-block" id="ServerDbServices3.sweep"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.sweep">[docs]</a>    <span class="k">def</span> <span class="nf">sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform database sweep operation.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">REPAIR</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">SrvRepairFlag</span><span class="o">.</span><span class="n">SWEEP_DB</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
<div class="viewcode-block" id="ServerDbServices3.repair"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.repair">[docs]</a>    <span class="k">def</span> <span class="nf">repair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">SrvRepairFlag</span><span class="o">=</span><span class="n">SrvRepairFlag</span><span class="o">.</span><span class="n">REPAIR</span><span class="p">,</span>
               <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform database repair operation.  **(SYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            flags: Repair flags.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">REPAIR</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
<div class="viewcode-block" id="ServerDbServices3.validate"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">include_table</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exclude_table</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_index</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exclude_index</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lock_timeout</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">callback</span><span class="p">:</span> <span class="n">CB_OUTPUT_LINE</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform database validation. **(ASYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            flags: Repair flags.</span>
<span class="sd">            include_table: Regex pattern for table names to include in validation run.</span>
<span class="sd">            exclude_table: Regex pattern for table names to exclude in validation run.</span>
<span class="sd">            include_index: Regex pattern for index names to include in validation run.</span>
<span class="sd">            exclude_index: Regex pattern for index names to exclude in validation run.</span>
<span class="sd">            lock_timeout: Lock timeout (seconds), used to acquire locks for table to validate,</span>
<span class="sd">              default is 10 secs. 0 is no-wait, -1 is infinite wait.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">            callback: Function to call back with each output line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">VALIDATE</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvValidateOption</span><span class="o">.</span><span class="n">INCLUDE_TABLE</span><span class="p">,</span> <span class="n">include_table</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exclude_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvValidateOption</span><span class="o">.</span><span class="n">EXCLUDE_TABLE</span><span class="p">,</span> <span class="n">exclude_table</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvValidateOption</span><span class="o">.</span><span class="n">INCLUDE_INDEX</span><span class="p">,</span> <span class="n">include_index</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exclude_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvValidateOption</span><span class="o">.</span><span class="n">EXCLUDE_INDEX</span><span class="p">,</span> <span class="n">exclude_index</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lock_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvValidateOption</span><span class="o">.</span><span class="n">LOCK_TIMEOUT</span><span class="p">,</span> <span class="n">lock_timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>
<div class="viewcode-block" id="ServerDbServices3.get_limbo_transaction_ids"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.get_limbo_transaction_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_limbo_transaction_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns list of transactions in limbo.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;Feature not yet implemented&quot;</span><span class="p">)</span></div>
        <span class="c1">#with a.get_api().util.get_xpb_builder(XpbKind.SPB_START) as spb:</span>
            <span class="c1">#spb.insert_tag(ServerAction .REPAIR)</span>
            <span class="c1">#spb.insert_string(SPBItem.DBNAME, str(database))</span>
            <span class="c1">#spb.insert_int(SPBItem.OPTIONS, SrvRepairFlag.LIST_LIMBO_TRANS)</span>
            <span class="c1">#self._srv()._svc.start(spb.get_buffer())</span>
        <span class="c1">#self._srv()._reset_output()</span>
        <span class="c1">#self._srv()._fetch_complex_info(bytes([SrvInfoCode.LIMBO_TRANS]))</span>
        <span class="c1">#trans_ids = []</span>
        <span class="c1">#while not self._srv().response.is_eof():</span>
            <span class="c1">#tag = self._srv().response.get_tag()</span>
            <span class="c1">#if tag == SrvInfoCode.TIMEOUT:</span>
                <span class="c1">#return None</span>
            <span class="c1">#if tag == SrvInfoCode.LIMBO_TRANS:</span>
                <span class="c1">#size = self._srv().response.read_short()</span>
                <span class="c1">#while not self._srv().response.is_eof() and self._srv().response.pos &lt; size:</span>
                    <span class="c1">#tag = self._srv().response.get_tag()</span>
                    <span class="c1">#if tag == SrvRepairOption.TRA_HOST_SITE:</span>
                        <span class="c1">#site = self._srv().response.get_string()</span>
                    <span class="c1">#elif tag == SrvRepairOption.TRA_STATE:</span>
                        <span class="c1">#tag = self._srv().response.get_tag()</span>
                        <span class="c1">#if tag == SrvRepairOption.TRA_STATE_LIMBO:</span>
                            <span class="c1">#state = TransactionState.LIMBO</span>
                        <span class="c1">#elif tag == SrvRepairOption.TRA_STATE_COMMIT:</span>
                            <span class="c1">#state = TransactionState.COMMIT</span>
                        <span class="c1">#elif tag == SrvRepairOption.TRA_STATE_ROLLBACK:</span>
                            <span class="c1">#state = TransactionState.ROLLBACK</span>
                        <span class="c1">#elif tag == SrvRepairOption.TRA_STATE_UNKNOWN:</span>
                            <span class="c1">#state = TransactionState.UNKNOWN</span>
                        <span class="c1">#else:</span>
                            <span class="c1">#raise InterfaceError(f&quot;Unknown transaction state {tag}&quot;)</span>
                    <span class="c1">#elif tag == SrvRepairOption.TRA_REMOTE_SITE:</span>
                        <span class="c1">#remote_site = self._srv().response.get_string()</span>
                    <span class="c1">#elif tag == SrvRepairOption.TRA_DB_PATH:</span>
                        <span class="c1">#db_path = self._srv().response.get_string()</span>
                    <span class="c1">#elif tag == SrvRepairOption.TRA_ADVISE:</span>
                        <span class="c1">#tag = self._srv().response.get_tag()</span>
                        <span class="c1">#if tag == SrvRepairOption.TRA_ADVISE_COMMIT:</span>
                            <span class="c1">#advise = TransactionState.COMMIT</span>
                        <span class="c1">#elif tag == SrvRepairOption.TRA_ADVISE_ROLLBACK:</span>
                            <span class="c1">#advise = TransactionState.ROLLBACK</span>
                        <span class="c1">#elif tag == SrvRepairOption.TRA_ADVISE_UNKNOWN:</span>
                            <span class="c1">#advise = TransactionState.UNKNOWN</span>
                        <span class="c1">#else:</span>
                            <span class="c1">#raise InterfaceError(f&quot;Unknown transaction state {tag}&quot;)</span>
                    <span class="c1">#elif tag == SrvRepairOption.MULTI_TRA_ID:</span>
                        <span class="c1">#multi_id = self._srv().response.get_int()</span>
                    <span class="c1">#elif tag == SrvRepairOption.SINGLE_TRA_ID:</span>
                        <span class="c1">#single_id = self._srv().response.get_int()</span>
                    <span class="c1">#elif tag == SrvRepairOption.TRA_ID:</span>
                        <span class="c1">#tra_id = self._srv().response.get_int()</span>
                    <span class="c1">#elif tag == SrvRepairOption.MULTI_TRA_ID_64:</span>
                        <span class="c1">#multi_id = self._srv().response.get_int64()</span>
                    <span class="c1">#elif tag == SrvRepairOption.SINGLE_TRA_ID_64:</span>
                        <span class="c1">#single_id = self._srv().response.get_int64()</span>
                    <span class="c1">#elif tag == SrvRepairOption.TRA_ID_64:</span>
                        <span class="c1">#tra_id = self._srv().response.get_int64()</span>
                    <span class="c1">#else:</span>
                        <span class="c1">#raise InterfaceError(f&quot;Unknown transaction state {tag}&quot;)</span>
                    <span class="c1">#trans_ids.append(None)</span>
        <span class="c1">#if self._srv().response.get_tag() != isc_info_end:</span>
            <span class="c1">#raise InterfaceError(&quot;Malformed result buffer (missing isc_info_end item)&quot;)</span>
        <span class="c1">#return trans_ids</span>
<div class="viewcode-block" id="ServerDbServices3.commit_limbo_transaction"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.commit_limbo_transaction">[docs]</a>    <span class="k">def</span> <span class="nf">commit_limbo_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Resolve limbo transaction with commit.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            transaction_id: ID of Transaction to resolve.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">REPAIR</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transaction_id</span> <span class="o">&lt;=</span> <span class="n">USHRT_MAX</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRepairOption</span><span class="o">.</span><span class="n">COMMIT_TRANS</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_bigint</span><span class="p">(</span><span class="n">SrvRepairOption</span><span class="o">.</span><span class="n">COMMIT_TRANS_64</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_read_all_binary_output</span><span class="p">()</span></div>
<div class="viewcode-block" id="ServerDbServices3.rollback_limbo_transaction"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices3.rollback_limbo_transaction">[docs]</a>    <span class="k">def</span> <span class="nf">rollback_limbo_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Resolve limbo transaction with rollback.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            transaction_id: ID of Transaction to resolve.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">REPAIR</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transaction_id</span> <span class="o">&lt;=</span> <span class="n">USHRT_MAX</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvRepairOption</span><span class="o">.</span><span class="n">ROLLBACK_TRANS</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_bigint</span><span class="p">(</span><span class="n">SrvRepairOption</span><span class="o">.</span><span class="n">ROLLBACK_TRANS_64</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_read_all_binary_output</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="ServerDbServices"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices">[docs]</a><span class="k">class</span> <span class="nc">ServerDbServices</span><span class="p">(</span><span class="n">ServerDbServices3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Database-related actions and services [Firebird 4+].</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ServerDbServices.nfix_database"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices.nfix_database">[docs]</a>    <span class="k">def</span> <span class="nf">nfix_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">flags</span><span class="p">:</span> <span class="n">SrvNBackupFlag</span><span class="o">=</span><span class="n">SrvNBackupFlag</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fixup database after filesystem copy.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            role: SQL ROLE name passed to nbackup.</span>
<span class="sd">            flags: Backup options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">NFIX</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">OPTIONS</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
<div class="viewcode-block" id="ServerDbServices.set_replica_mode"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerDbServices.set_replica_mode">[docs]</a>    <span class="k">def</span> <span class="nf">set_replica_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">ReplicaMode</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Manage replica database.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            mode: New replication mode.</span>
<span class="sd">            role: SQL ROLE name passed to gfix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_bytes</span><span class="p">(</span><span class="n">SrvPropertiesOption</span><span class="o">.</span><span class="n">REPLICA_MODE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">mode</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="ServerUserServices"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerUserServices">[docs]</a><span class="k">class</span> <span class="nc">ServerUserServices</span><span class="p">(</span><span class="n">ServerServiceProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;User-related actions and services.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__fetch_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserInfo</span><span class="p">]:</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvUserOption</span><span class="o">.</span><span class="n">USER_NAME</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
                    <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UserInfo</span><span class="p">(</span><span class="o">**</span><span class="n">user</span><span class="p">))</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;user_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvUserOption</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">:</span>
                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read_int</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvUserOption</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">:</span>
                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read_int</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvUserOption</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvUserOption</span><span class="o">.</span><span class="n">GROUP_NAME</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;group_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvUserOption</span><span class="o">.</span><span class="n">FIRST_NAME</span><span class="p">:</span>
                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvUserOption</span><span class="o">.</span><span class="n">MIDDLE_NAME</span><span class="p">:</span>
                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;middle_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvUserOption</span><span class="o">.</span><span class="n">LAST_NAME</span><span class="p">:</span>
                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvUserOption</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">:</span>
                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">read_int</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized result clumplet: </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UserInfo</span><span class="p">(</span><span class="o">**</span><span class="n">user</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">users</span>
<div class="viewcode-block" id="ServerUserServices.get_all"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerUserServices.get_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sql_role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserInfo</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get information about users.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            sql_role: SQL role name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">DISPLAY_USER_ADM</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sql_role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">sql_role</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fetch_users</span><span class="p">(</span><span class="n">Buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_read_all_binary_output</span><span class="p">()))</span></div>
<div class="viewcode-block" id="ServerUserServices.get"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerUserServices.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sql_role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserInfo</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get information about user.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            user_name: User name.</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            sql_role: SQL role name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">DISPLAY_USER_ADM</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">USER_NAME</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sql_role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">sql_role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fetch_users</span><span class="p">(</span><span class="n">Buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_read_all_binary_output</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">users</span> <span class="k">else</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="ServerUserServices.add"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerUserServices.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">group_id</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">middle_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">last_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">admin</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sql_role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add new user.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            user_name: User name.</span>
<span class="sd">            password: User password.</span>
<span class="sd">            user_id: User ID.</span>
<span class="sd">            group_id: Group ID.</span>
<span class="sd">            firest_name: User&#39;s first name.</span>
<span class="sd">            middle_name: User&#39;s middle name.</span>
<span class="sd">            last_name: User&#39;s last name.</span>
<span class="sd">            admin: Admin flag.</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            sql_role: SQL role name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">ADD_USER</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">USER_NAME</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sql_role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">sql_role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                              <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">FIRST_NAME</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">middle_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">MIDDLE_NAME</span><span class="p">,</span> <span class="n">middle_name</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">LAST_NAME</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">admin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">admin</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
<div class="viewcode-block" id="ServerUserServices.update"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerUserServices.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_id</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">middle_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">last_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">admin</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update user information.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            user_name: User name.</span>
<span class="sd">            password: User password.</span>
<span class="sd">            user_id: User ID.</span>
<span class="sd">            group_id: Group ID.</span>
<span class="sd">            firest_name: User&#39;s first name.</span>
<span class="sd">            middle_name: User&#39;s middle name.</span>
<span class="sd">            last_name: User&#39;s last name.</span>
<span class="sd">            admin: Admin flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">MODIFY_USER</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">USER_NAME</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span>
                              <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">FIRST_NAME</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">middle_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">MIDDLE_NAME</span><span class="p">,</span> <span class="n">middle_name</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">LAST_NAME</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span>
                                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">admin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">admin</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
<div class="viewcode-block" id="ServerUserServices.delete"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerUserServices.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sql_role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Delete user.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            user_name: User name.</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            sql_role: SQL role name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">DELETE_USER</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvUserOption</span><span class="o">.</span><span class="n">USER_NAME</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">DBNAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sql_role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SPBItem</span><span class="o">.</span><span class="n">SQL_ROLE_NAME</span><span class="p">,</span> <span class="n">sql_role</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
<div class="viewcode-block" id="ServerUserServices.exists"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerUserServices.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="n">FILESPEC</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sql_role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if user exists.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            user_name: User name.</span>
<span class="sd">            database: Database specification or alias.</span>
<span class="sd">            sql_role: SQL role name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">sql_role</span><span class="o">=</span><span class="n">sql_role</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div></div>

<div class="viewcode-block" id="ServerTraceServices"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerTraceServices">[docs]</a><span class="k">class</span> <span class="nc">ServerTraceServices</span><span class="p">(</span><span class="n">ServerServiceProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trace session actions and services.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">ServerAction</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_int</span><span class="p">(</span><span class="n">SrvTraceOption</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_fetch_line</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trace session ID </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="c1"># response should contain the error message</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
<div class="viewcode-block" id="ServerTraceServices.start"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerTraceServices.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start new trace session. **(ASYNC service)**</span>

<span class="sd">        Arguments:</span>
<span class="sd">            config: Trace session configuration.</span>
<span class="sd">            name: Trace session name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Trace session ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">TRACE_START</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvTraceOption</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">SrvTraceOption</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_fetch_line</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Trace session ID&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
        <span class="c1"># pragma: no cover</span>
        <span class="c1"># response should contain the error message</span>
        <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>
<div class="viewcode-block" id="ServerTraceServices.stop"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerTraceServices.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stop trace session.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            session_id: Trace session ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">           Text message &#39;Trace session ID &lt;x&gt; stopped&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__action</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">TRACE_STOP</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span></div>
<div class="viewcode-block" id="ServerTraceServices.suspend"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerTraceServices.suspend">[docs]</a>    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Suspend trace session.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            session_id: Trace session ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">           Text message &#39;Trace session ID &lt;x&gt; paused&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__action</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">TRACE_SUSPEND</span><span class="p">,</span> <span class="s1">&#39;paused&#39;</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span></div>
<div class="viewcode-block" id="ServerTraceServices.resume"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.ServerTraceServices.resume">[docs]</a>    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Resume trace session.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            session_id: Trace session ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">           Text message &#39;Trace session ID &lt;x&gt; resumed&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__action</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">TRACE_RESUME</span><span class="p">,</span> <span class="s1">&#39;resumed&#39;</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span></div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">TraceSession</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with active trace sessions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">store</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">TraceSession</span><span class="p">(</span><span class="o">**</span><span class="n">current</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span>
                <span class="n">current</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_reset_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_xpb_builder</span><span class="p">(</span><span class="n">XpbKind</span><span class="o">.</span><span class="n">SPB_START</span><span class="p">)</span> <span class="k">as</span> <span class="n">spb</span><span class="p">:</span>
            <span class="n">spb</span><span class="o">.</span><span class="n">insert_tag</span><span class="p">(</span><span class="n">ServerAction</span><span class="o">.</span><span class="n">TRACE_LIST</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">()</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">())</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srv</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">store</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Session ID:&#39;</span><span class="p">):</span>
                <span class="n">store</span><span class="p">()</span>
                <span class="n">current</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;name:&#39;</span><span class="p">):</span>
                <span class="n">current</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;user:&#39;</span><span class="p">):</span>
                <span class="n">current</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;date:&#39;</span><span class="p">):</span>
                <span class="n">current</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;flags:&#39;</span><span class="p">):</span>
                <span class="n">current</span><span class="p">[</span><span class="s1">&#39;flags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected line in trace session list: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">store</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Server"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Server">[docs]</a><span class="k">class</span> <span class="nc">Server</span><span class="p">(</span><span class="n">LoggingIdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents connection to Firebird Service Manager.</span>

<span class="sd">    Note:</span>
<span class="sd">        Implements context manager protocol to call `.close()` automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">svc</span><span class="p">:</span> <span class="n">iService</span><span class="p">,</span> <span class="n">spb</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">encoding_errors</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="p">:</span> <span class="n">iService</span> <span class="o">=</span> <span class="n">svc</span>
        <span class="c1">#: Service Parameter Buffer (SPB) used to connect the service manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spb</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">spb</span>
        <span class="c1">#: Server host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">host</span>
        <span class="c1">#: Service output mode (line or eof)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span> <span class="n">SrvInfoCode</span> <span class="o">=</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TO_EOF</span>
        <span class="c1">#: Response buffer used to comunicate with service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span> <span class="n">CBuffer</span> <span class="o">=</span> <span class="n">CBuffer</span><span class="p">(</span><span class="n">USHRT_MAX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eof</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#: Encoding used for text data exchange with server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="c1">#: Handler used for encoding errors. See: `codecs#error-handlers`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding_errors</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">encoding_errors</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ev</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__info</span><span class="p">:</span> <span class="n">ServerInfoProvider</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dbsvc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ServerDbServices</span><span class="p">,</span> <span class="n">ServerDbServices3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__trace</span><span class="p">:</span> <span class="n">ServerTraceServices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__user</span><span class="p">:</span> <span class="n">ServerUserServices</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Server</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_id</span><span class="si">}</span><span class="s2">&#39; disposed without prior close()&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Server[v</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:service_mgr&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span>
    <span class="k">def</span> <span class="nf">_engine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ev</span> <span class="o">=</span> <span class="n">_engine_version_provider</span><span class="o">.</span><span class="n">get_engine_version</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ev</span>
    <span class="k">def</span> <span class="nf">_reset_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eof</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">),</span>
                         <span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">),</span>
                         <span class="n">timeout</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)])</span>
    <span class="k">def</span> <span class="nf">_fetch_complex_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">send</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_truncated</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Requested data can&#39;t fint into largest possible buffer&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_fetch_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span> <span class="c1"># pylint: disable=W0613</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_complex_info</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">LINE</span><span class="p">]))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_eof</span><span class="p">():</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">LINE</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span> <span class="o">!=</span> <span class="n">isc_info_end</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Malformed result buffer (missing isc_info_end item)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">_query_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span> <span class="nb">bytes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">())</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Service responded with error code: </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding_errors</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_read_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">init</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_output</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TO_EOF</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span> <span class="o">==</span> <span class="n">isc_info_end</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># LINE mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eof</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">data</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">tag</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">())</span> <span class="o">==</span> <span class="n">isc_info_truncated</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_output</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">isc_info_end</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;Malformed result buffer (missing isc_info_end item)&quot;</span><span class="p">)</span>
        <span class="n">init</span> <span class="o">+=</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">LINE</span><span class="p">:</span>
            <span class="n">init</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_read_all_binary_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">send</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eof</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">eof</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TO_EOF</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">())</span> <span class="o">!=</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TO_EOF</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Service responded with error code: </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">())</span>
            <span class="n">eof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span> <span class="o">==</span> <span class="n">isc_info_end</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_read_next_binary_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eof</span><span class="p">:</span>
            <span class="n">send</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TO_EOF</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">())</span> <span class="o">!=</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TO_EOF</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Service responded with error code: </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span> <span class="o">==</span> <span class="n">isc_info_end</span>
        <span class="k">return</span> <span class="n">result</span>
<div class="viewcode-block" id="Server.is_running"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Server.is_running">[docs]</a>    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if service is running.</span>

<span class="sd">        Note:</span>
<span class="sd">           Some services like `~.ServerDbServices.backup()` or `~.ServerDbServices.sweep()`</span>
<span class="sd">           may take time to comlete, so they&#39;re called asynchronously. Until they&#39;re finished,</span>
<span class="sd">           no other async service could be started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></div>
<div class="viewcode-block" id="Server.readline_timed"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Server.readline_timed">[docs]</a>    <span class="k">def</span> <span class="nf">readline_timed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sentinel</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get next line of textual output from last service query.</span>

<span class="sd">        Arguments:</span>
<span class="sd">          timeout: Time in seconds to wait for output.</span>

<span class="sd">        Returns:</span>
<span class="sd">          Line of service output, `None` for EOF or `.TIMEOUT` sentinel for expired timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">timeout</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">LINE</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">())</span> <span class="o">!=</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">LINE</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Service responded with error code: </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">read_sized_string</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding_errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span> <span class="o">==</span> <span class="n">SrvInfoCode</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TIMEOUT</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Server.readline"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Server.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get next line of textual output from last service query.</span>

<span class="sd">        Returns:</span>
<span class="sd">          Line of service output or `None` for EOF.</span>

<span class="sd">        Important:</span>
<span class="sd">          This method blocks until any output is available from server. Bacuse this method</span>
<span class="sd">          is used by iteration over `.Server` and `.readlines` method, they will block as</span>
<span class="sd">          well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eof</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_output</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eof</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_output</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_output</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__line_buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Server.readlines"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Server.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get list of remaining output lines from last service query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="Server.wait"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Server.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Wait until running service completes, i.e. stops sending data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">pass</span></div>
<div class="viewcode-block" id="Server.close"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.Server.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close the server connection now (rather than whenever `__del__` is called).</span>
<span class="sd">        The instance will be unusable from this point forward; an `.Error`</span>
<span class="sd">        (or subclass) exception will be raised if any operation is attempted</span>
<span class="sd">        with the instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__info</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dbsvc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dbsvc</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dbsvc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__trace</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__trace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__user</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># try..finally is necessary to shield from crashed server</span>
            <span class="c1"># Otherwise close() will be called from __del__ which may crash Python</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span> <span class="o">=</span> <span class="kc">None</span></div>
    <span class="c1"># Properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ServerInfoProvider</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Access to various information about attached server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__info</span> <span class="o">=</span> <span class="n">ServerInfoProvider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ServerDbServices3</span><span class="p">,</span> <span class="n">ServerDbServices</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Access to various database-related actions and services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dbsvc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">ServerDbServices</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_version</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">4.0</span> \
                <span class="k">else</span> <span class="n">ServerDbServices3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dbsvc</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dbsvc</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ServerTraceServices</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Access to various database-related actions and services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__trace</span> <span class="o">=</span> <span class="n">ServerTraceServices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trace</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ServerUserServices</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Access to various user-related actions and services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__user</span> <span class="o">=</span> <span class="n">ServerUserServices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__user</span></div>

<div class="viewcode-block" id="connect_server"><a class="viewcode-back" href="../../../ref-core.html#firebird.driver.core.connect_server">[docs]</a><span class="k">def</span> <span class="nf">connect_server</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">crypt_callback</span><span class="p">:</span> <span class="n">iCryptKeyCallbackImpl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">expected_db</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">encoding_errors</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Server</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Establishes a connection to server&#39;s service manager.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        server: Server host machine or Server configuration name.</span>
<span class="sd">        user: User name.</span>
<span class="sd">        password: User password.</span>
<span class="sd">        crypt_callback: Callback that provides encryption key.</span>
<span class="sd">        expected_db: Database that would be accessed (for using services with non-default</span>
<span class="sd">                     security database)</span>
<span class="sd">        role: SQL role used for connection.</span>
<span class="sd">        encoding: Encoding for string values passed in parameter buffer. Default is</span>
<span class="sd">           `.ServerConfig.encoding`.</span>
<span class="sd">        encoding_errors: Error handler used for encoding errors. Default is</span>
<span class="sd">           `.ServerConfig.encoding_errors`.</span>

<span class="sd">    Hooks:</span>
<span class="sd">        Event `.ServerHook.ATTACHED`: Executed before `Service` instance is</span>
<span class="sd">        returned. Hook must have signature::</span>

<span class="sd">            hook_func(server: Server) -&gt; None</span>

<span class="sd">        Any value returned by hook is ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">srv_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">get_server</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">srv_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">srv_config</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">.</span><span class="n">server_defaults</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">server</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">host</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;service_mgr&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;service_mgr&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="n">host</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span>
        <span class="n">host</span> <span class="o">+=</span> <span class="s1">&#39;service_mgr&#39;</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">value</span>
    <span class="n">spb</span> <span class="o">=</span> <span class="n">SPB_ATTACH</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">srv_config</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">trusted_auth</span><span class="o">=</span><span class="n">srv_config</span><span class="o">.</span><span class="n">trusted_auth</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">auth_plugin_list</span><span class="o">=</span><span class="n">srv_config</span><span class="o">.</span><span class="n">auth_plugin_list</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">expected_db</span><span class="o">=</span><span class="n">expected_db</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">)</span>
    <span class="n">spb_buf</span> <span class="o">=</span> <span class="n">spb</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">get_dispatcher</span><span class="p">()</span> <span class="k">as</span> <span class="n">provider</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">crypt_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">set_dbcrypt_callback</span><span class="p">(</span><span class="n">crypt_callback</span><span class="p">)</span>
        <span class="n">svc</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">attach_service_manager</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">spb_buf</span><span class="p">)</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">svc</span><span class="p">,</span> <span class="n">spb_buf</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">srv_config</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">encoding</span><span class="p">,</span>
                 <span class="n">srv_config</span><span class="o">.</span><span class="n">encoding_errors</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">encoding_errors</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">encoding_errors</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">get_callbacks</span><span class="p">(</span><span class="n">ServerHook</span><span class="o">.</span><span class="n">ATTACHED</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
        <span class="n">hook</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">con</span></div>

<span class="c1"># Register hookable classes</span>
<span class="n">register_class</span><span class="p">(</span><span class="n">Connection</span><span class="p">,</span> <span class="n">ConnectionHook</span><span class="p">)</span>
<span class="n">register_class</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span> <span class="n">ServerHook</span><span class="p">)</span>
<span class="k">del</span> <span class="n">register_class</span>
<span class="k">del</span> <span class="n">add_hook</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2020-2022, The Firebird Project.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>